<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ë§ˆì´í˜ì´ì§€ | WALKorea</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color:#f5f7fb; }

    .sidebar-fixed {
      width: 260px;
      min-width: 260px;
      max-width: 260px;
      border-right: 1px solid #e5e7eb;
      background-color:#fff;
    }

    /* ì‚¬ì´ë“œë°” ë©”ë‰´ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .sidebar .menu-title {
      font-size:0.85rem;
      font-weight:600;
      color:#6b7280;
      margin-top:1rem;
      margin-bottom:0.25rem;
    }

    .sidebar .nav-link {
      font-size:0.95rem;
      color:#374151;
      padding:0.45rem 0.75rem;
      border-radius:0.35rem;
      margin-bottom:2px;
    }

    .sidebar .nav-link.active {
      background-color:#e0f2fe;
      color:#0369a1;
      font-weight:600;
    }

    .calendar-grid {
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:4px;
      font-size:0.85rem;
    }
    .calendar-day {
      min-height:70px;
      border-radius:4px;
      padding:4px;
      background-color:#fff;
      border:1px solid #e5e7eb;
    }
    .calendar-day.today {
      border:2px solid #16a34a;
    }
    .calendar-day .date-num {
      font-weight:600;
      margin-bottom:4px;
    }
    .weather-box {
      background-color:#fff;
      border-radius:0.75rem;
      padding:0.75rem 0.85rem;
      box-shadow:0 1px 3px rgba(15,23,42,0.08);
      font-size:0.8rem;
    }

    #region-weather-list div {
      line-height:1.4;
    }
  </style>
</head>
<body>
<header class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold text-success" href="index.html">WALKorea</a>
    <ul class="navbar-nav ms-auto gap-2">
      <li class="nav-item"><a class="nav-link" href="recommend.html">ì¶”ì²œ ì—¬í–‰ì§€</a></li>
      <li class="nav-item"><a class="nav-link" href="calendar.html">ì—¬í–‰ ìº˜ë¦°ë”</a></li>
      <li class="nav-item"><a class="nav-link" href="mypage_calendar.html">ë§ˆì´í˜ì´ì§€</a></li>
      <!-- ì•Œë¦¼ ì•„ì´ì½˜ -->
      <li class="nav-item position-relative">
        <button id="notif-btn" class="btn btn-link nav-link p-0 position-relative">
          <span class="fs-5">ğŸ””</span>
          <span id="notif-badge"
                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
          </span>
        </button>

        <!-- ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ íŒ¨ë„ -->
        <div id="notif-panel"
             class="card shadow-sm position-absolute end-0 mt-2 d-none"
             style="width:260px; z-index:1050;">
          <div class="card-header py-2 px-3 d-flex justify-content-between align-items-center">
            <span class="small fw-semibold">ì•Œë¦¼</span>
            <button id="notif-close" class="btn btn-sm btn-outline-secondary py-0 px-1">Ã—</button>
          </div>
          <ul id="notif-list" class="list-group list-group-flush small"></ul>
        </div>
      </li>
      <li class="nav-item" id="nav-login"><a class="btn btn-success" href="login.html">ë¡œê·¸ì¸</a></li>
      <li class="nav-item" id="nav-signup"><a class="btn btn-primary" href="signup.html">íšŒì›ê°€ì…</a></li>
    </ul>
  </div>
</header>

<main class="container-fluid" style="margin-top:10px;">
  <div class="d-flex">
    <!-- ì™¼ìª½: ë§ˆì´í˜ì´ì§€ ì¹´í…Œê³ ë¦¬ -->
    <aside class="sidebar-fixed sidebar p-3">
      <div class="d-flex align-items-center mb-3">
        <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center"
            style="width:40px;height:40px;">
          <span id="side-initial">W</span>
        </div>
        <div class="ms-2">
          <div class="fw-semibold" id="side-nickname">ë¡œê·¸ì¸ ì‚¬ìš©ì</div>
          <div class="text-muted small" id="side-email">-</div>
        </div>
      </div>

      <div class="weather-box mb-3" id="weather-box">
        <div class="fw-semibold mb-1" id="region-weather-title">ë™ë„¤ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”</div>
        <div class="small text-muted mb-2" id="region-weather-desc">
          ë§ˆì´í˜ì´ì§€ &gt; í”„ë¡œí•„ ìˆ˜ì •ì—ì„œ ì§€ì—­ì„ ì„¤ì •í•˜ë©´, ì´ê³³ì— 6ì¼ê°„ì˜ ë‚ ì”¨ë¥¼ ë³´ì—¬ì¤„ê²Œìš”.
        </div>
        <div id="region-weather-list"></div>
        <a class="btn btn-outline-success btn-sm mt-2 w-100" href="mypage_profile.html">
          ì§€ì—­ ì„¤ì •í•˜ëŸ¬ ê°€ê¸°
        </a>
      </div>

      <div class="menu-title">ë§ˆì´í˜ì´ì§€</div>
      <nav class="nav flex-column">
        <a href="mypage_calendar.html"  class="nav-link">ë‚´ ì¼ì •</a>
        <a href="mypage_friends.html"   class="nav-link">ì¹œêµ¬ ê´€ë¦¬</a>
        <a href="mypage_recommend.html" class="nav-link">ë§ì¶¤ ê´€ê´‘</a>
        <a href="mypage_profile.html"   class="nav-link active">í”„ë¡œí•„ ìˆ˜ì •</a>
        <a href="mypage_favorites.html" class="nav-link">ì¢‹ì•„ìš” í•œ ì—¬í–‰ì§€</a>
      </nav>
    </aside>
    
    <section class="flex-grow-1 py-5 px-4" style="max-width:960px;">
      <div class="row g-4">
        <div class="col-lg-7">
          <div class="card shadow-sm">
            <div class="card-body">
              <!-- ì—¬ê¸°ë¶€í„° ê¸°ì¡´ ë‚´ ì •ë³´ form ë‚´ìš© ê·¸ëŒ€ë¡œ -->
              <h3 class="mb-3 fw-bold">ë‚´ ì •ë³´</h3>
              <p class="text-muted small mb-4">
                ê°€ì… ì‹œ ì…ë ¥í•œ ê¸°ë³¸ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ì¼ë¶€ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </p>
              <form id="profile-form">
                <div class="mb-3">
                  <label class="form-label">ì•„ì´ë””</label>
                  <input type="text" class="form-control" id="userid" disabled>
                </div>
                <div class="mb-3">
                  <label class="form-label">ì´ë©”ì¼</label>
                  <input type="email" class="form-control" id="email" disabled>
                </div>
                <div class="mb-3">
                  <label class="form-label">ë‹‰ë„¤ì„</label>
                  <input type="text" class="form-control" id="nickname">
                  <div id="nickname-msg" class="small mt-1"></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">íœ´ëŒ€í° ë²ˆí˜¸</label>
                  <input type="text" class="form-control" id="phonenum" placeholder="01012345678">
                  <div id="phone-msg" class="small mt-1"></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">ìƒë…„ì›”ì¼</label>
                  <input type="date" class="form-control" id="birthday">
                </div>
                <div class="mb-3">
                  <label class="form-label">ì„±ë³„</label>
                  <select class="form-select" id="gender">
                    <option value="">ì„ íƒ</option>
                    <option value="M">ë‚¨ì„±</option>
                    <option value="F">ì—¬ì„±</option>
                    <option value="O">ê¸°íƒ€</option>
                  </select>
                </div>

                <!-- ê±°ì£¼ ì§€ì—­ -->
                <div class="mb-3">
                  <label class="form-label">ê±°ì£¼ ì§€ì—­</label>
                  <div class="d-flex gap-2">
                    <input type="text" class="form-control" id="edit-region-label"
                          placeholder="ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”" readonly>
                    <button type="button" class="btn btn-outline-secondary"
                            data-bs-toggle="modal" data-bs-target="#regionModal">
                      ì§€ì—­ ì„ íƒ
                    </button>
                  </div>
                  <input type="hidden" id="edit-region-id">
                </div>

                <button type="submit" class="btn btn-success w-100 mt-2">ì •ë³´ ì €ì¥</button>
              </form>
            </div>
          </div>
        </div>

        <!-- ìš°ì¸¡: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ / ê³„ì • ê´€ë¦¬ -->
        <div class="col-lg-5">
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h4 class="fw-bold mb-3">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h4>
              <form id="pw-form">
                <div class="mb-2">
                  <label class="form-label">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                  <input type="password" class="form-control" id="current_password" required>
                </div>
                <div class="mb-2">
                  <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                  <input type="password" class="form-control" id="new_password" required>
                </div>
                <div class="mb-2">
                  <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                  <input type="password" class="form-control" id="new_password_confirm" required>
                </div>
                <div id="pw-msg" class="small mt-1"></div>
                <button type="submit" class="btn btn-outline-primary w-100 mt-2">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
              </form>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <h4 class="fw-bold mb-3">ê³„ì • ê´€ë¦¬</h4>
              <button id="logout-btn" class="btn btn-outline-secondary w-100 mb-2">ë¡œê·¸ì•„ì›ƒ</button>
              <button id="delete-btn" class="btn btn-outline-danger w-100">íšŒì› íƒˆí‡´</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- ì§€ì—­ ì„ íƒ ëª¨ë‹¬ -->
<div class="modal fade" id="regionModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h5 class="modal-title">ê±°ì£¼ ì§€ì—­ ì„ íƒ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <input type="text" class="form-control form-control-sm" id="region-search"
                 placeholder="ì§€ì—­ëª… ê²€ìƒ‰ ì˜ˆ) ì„œìš¸, ì„œì´ˆêµ¬">
        </div>
        <div class="row g-2" style="max-height:320px; overflow-y:auto;">
          <div class="col-3 border-end">
            <div class="fw-semibold small mb-1">ì‹œÂ·ë„</div>
            <ul class="list-group list-group-flush small" id="sido-list"></ul>
          </div>
          <div class="col-4 border-end">
            <div class="fw-semibold small mb-1">ì‹œÂ·êµ°Â·êµ¬</div>
            <ul class="list-group list-group-flush small" id="sigungu-list"></ul>
          </div>
          <div class="col-5">
            <div class="fw-semibold small mb-1">ë™Â·ìÂ·ë©´</div>
            <ul class="list-group list-group-flush small" id="dong-list"></ul>
          </div>
        </div>
      </div>
      <div class="modal-footer py-2">
        <div class="me-auto small text-muted" id="region-selected-text">ì„ íƒëœ ì§€ì—­: ì—†ìŒ</div>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ì·¨ì†Œ</button>
        <button type="button" class="btn btn-success btn-sm" id="region-apply-btn">ì ìš©</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  function formatKoreanWeekday(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  const names = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
  return names[d.getDay()];
}

function mapIconToEmoji(icon) {
  switch (icon) {
    case "rain": return "ğŸŒ§ï¸";
    case "snow": return "â„ï¸";
    case "fog": return "ğŸŒ«ï¸";
    case "wind": return "ğŸ’¨";
    case "cloudy": return "â˜ï¸";
    case "partly-cloudy-day": return "â›…";
    case "partly-cloudy-night": return "â˜ï¸";
    case "clear-day": return "â˜€ï¸";
    case "clear-night": return "ğŸŒ™";
    default: return "ğŸŒ¤ï¸";
  }
}

async function loadProfileWeather() {
  const token = localStorage.getItem("access_token");
  if (!token) return;

  try {
    const res = await fetch("http://127.0.0.1:8000/weather/profile/current", {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) return;
    const data = await res.json();   // { region_name, days: [...] }

    const box = document.getElementById("weather-box");
    const boxTitle = document.getElementById("region-weather-title");
    const boxDesc  = document.getElementById("region-weather-desc");
    const listBox  = document.getElementById("region-weather-list");
    if (!data.days || !boxTitle || !boxDesc || !listBox || !box) return;

    // ìˆ¨ê¹€ í•´ì œ
    box.style.display = "block";

    boxTitle.textContent = `${data.region_name}ì˜ 6ì¼ê°„ ë‚ ì”¨`;
    boxDesc.textContent  = "ì˜¤ëŠ˜ì„ í¬í•¨í•œ 6ì¼ì¹˜ ë™ë„¤ ë‚ ì”¨ì˜ˆìš”.";

    listBox.innerHTML = "";

    data.days.forEach((d, idx) => {
      const div = document.createElement("div");
      div.className = "d-flex align-items-center small mb-1";

      const weekday = formatKoreanWeekday(d.date);
      const label = idx === 0 ? "ì˜¤ëŠ˜" : weekday;

      const temp = d.temp;
      const tmax = d.temp_max;
      const tmin = d.temp_min;

      const tempPart = (tmax != null && tmin != null)
        ? `${tmax.toFixed(0)}Â° / ${tmin.toFixed(0)}Â°`
        : (temp != null ? `${temp.toFixed(0)}Â°` : "-Â°");

      const iconEmoji = mapIconToEmoji(d.icon);
      const desc = d.desc || "";

      div.innerHTML = `
        <span class="text-muted" style="width:32px;">${label}</span>
        <span style="width:32px; text-align:center;">${iconEmoji}</span>
        <span class="fw-semibold" style="width:80px; text-align:right;">${tempPart}</span>
        <span class="text-muted" style="flex:1; text-align:left; margin-left:8px;">
          ${desc}
        </span>
      `;
      listBox.appendChild(div);
    });
  } catch (e) {
    console.error("profile weather error", e);
  }
}

  
// ---- ê³µí†µ í—¤ë” + ì´ˆê¸° ë¡œë”© ----
window.addEventListener("DOMContentLoaded", async function() {
  const token = localStorage.getItem("access_token");
  const nav = document.querySelector(".navbar-nav");
  const loginLi = document.getElementById("nav-login");
  const signupLi = document.getElementById("nav-signup");

  if (token && nav) {
    if (loginLi) loginLi.remove();
    if (signupLi) signupLi.remove();

    const profileLi = document.createElement("li");
    profileLi.className = "nav-item d-flex align-items-center";
    profileLi.innerHTML = `<span class="me-2 fw-semibold" id="nav-nickname">ë¡œê·¸ì¸ ì‚¬ìš©ì</span>`;
    nav.appendChild(profileLi);

    const logoutNavLi = document.createElement("li");
    logoutNavLi.className = "nav-item";
    logoutNavLi.innerHTML = `<a class="btn btn-outline-danger" href="#">ë¡œê·¸ì•„ì›ƒ</a>`;
    logoutNavLi.querySelector("a").onclick = function(e) {
      e.preventDefault();
      localStorage.removeItem("access_token");
      localStorage.removeItem("refresh_token");
      window.location.href = "index.html";
    };
    nav.appendChild(logoutNavLi);

    await loadProfile(token);
    await loadSidos();
    await loadProfileWeather();
    document.getElementById("region-apply-btn").onclick = applyRegionSelection;
  } else {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    window.location.href = "login.html";
    return;
  }

  document.getElementById("profile-form").addEventListener("submit", onSaveProfile);
  document.getElementById("pw-form").addEventListener("submit", onChangePassword);
  document.getElementById("logout-btn").addEventListener("click", () => {
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    window.location.href = "index.html";
  });
  document.getElementById("delete-btn").addEventListener("click", onDeleteAccount);

  // ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬
  const nickInput = document.getElementById("nickname");
  const nickMsg = document.getElementById("nickname-msg");
  let nickTimer = null;
  nickInput.addEventListener("input", function() {
    clearTimeout(nickTimer);
    const val = nickInput.value.trim();
    if (val.length < 2) {
      nickMsg.textContent = "ë‹‰ë„¤ì„ì„ 2ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.";
      nickMsg.className = "small text-danger mt-1";
      return;
    }
    nickTimer = setTimeout(async () => {
      const res = await fetch(`/auth/check-nickname?nickname=${encodeURIComponent(val)}`);
      const data = await res.json().catch(()=>null);
      if (data && data.result === "dup") {
        nickMsg.textContent = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.";
        nickMsg.className = "small text-danger mt-1";
      } else {
        nickMsg.textContent = "ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.";
        nickMsg.className = "small text-success mt-1";
      }
    }, 400);
  });

  // íœ´ëŒ€í° ë²ˆí˜¸ í¬ë§· ì²´í¬
  const phoneInput = document.getElementById("phonenum");
  const phoneMsg = document.getElementById("phone-msg");
  phoneInput.addEventListener("input", function() {
    let val = phoneInput.value.replace(/\D/g, "");
    phoneInput.value = val;
    if (!val) {
      phoneMsg.textContent = "";
      return;
    }
    if (/^010\d{8}$/.test(val)) {
      phoneMsg.textContent = "ì‚¬ìš© ê°€ëŠ¥í•œ ë²ˆí˜¸ì…ë‹ˆë‹¤.";
      phoneMsg.className = "small text-success mt-1";
    } else {
      phoneMsg.textContent = "010ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” 11ìë¦¬ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.";
      phoneMsg.className = "small text-danger mt-1";
    }
  });
});

// ---- í”„ë¡œí•„ ë¡œë”© ----
async function loadProfile(token) {
  try {
    const res = await fetch("http://127.0.0.1:8000/user/profile", {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) return;
    const data = await res.json();

    // ìƒë‹¨ ë„¤ë¹„ ë‹‰ë„¤ì„
    const navNick = document.getElementById("nav-nickname");
    if (navNick && data.nickname) navNick.textContent = data.nickname;

    // â˜… ì™¼ìª½ ì‚¬ì´ë“œë°” í”„ë¡œí•„ ì •ë³´ ì±„ìš°ê¸°
    const sideNick = document.getElementById("side-nickname");
    const sideEmail = document.getElementById("side-email");
    const sideInit  = document.getElementById("side-initial");
    const baseName  = data.nickname || data.userid || "ì‚¬ìš©ì";
    if (sideNick) sideNick.textContent = baseName;
    if (sideEmail) sideEmail.textContent = data.email || "";
    if (sideInit)  sideInit.textContent = baseName[0];

    // í¼ í•„ë“œë“¤
    document.getElementById("userid").value = data.userid || "";
    document.getElementById("email").value = data.email || "";
    document.getElementById("nickname").value = data.nickname || "";
    document.getElementById("phonenum").value = data.phonenum || "";
    if (data.birthday) document.getElementById("birthday").value = data.birthday;
    if (data.gender) document.getElementById("gender").value = data.gender;

    document.getElementById("edit-region-label").value = data.region_name || "";
    document.getElementById("edit-region-id").value = data.region_id || "";
  } catch (e) {
    console.error("loadProfile error", e);
  }
}


// ---- í”„ë¡œí•„ ì €ì¥ + ì§€ì—­ ì €ì¥ ----
async function onSaveProfile(e) {
  e.preventDefault();
  const token = localStorage.getItem("access_token");
  if (!token) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    return;
  }

  const payload = {
    phonenum: document.getElementById("phonenum").value.trim(),
    nickname: document.getElementById("nickname").value.trim(),
    gender: document.getElementById("gender").value || null,
  };
  const res = await fetch("http://127.0.0.1:8000/user/profile", {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify(payload)
  });
  if (!res.ok) {
    const err = await res.json().catch(()=>null);
    alert((err && err.detail) || "í”„ë¡œí•„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  const regionId = document.getElementById("edit-region-id").value;
  if (regionId) {
    const res2 = await fetch("http://127.0.0.1:8000/user/me/region", {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ region_id: parseInt(regionId, 10) })
    });
    if (!res2.ok) {
      const err2 = await res2.json().catch(()=>null);
      alert((err2 && err2.detail) || "ì§€ì—­ ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      return;
    }
  }

  alert("í”„ë¡œí•„ê³¼ ì§€ì—­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

// ---- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ----
async function onChangePassword(e) {
  e.preventDefault();
  const token = localStorage.getItem("access_token");
  if (!token) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    return;
  }
  const current = document.getElementById("current_password").value;
  const pw = document.getElementById("new_password").value;
  const pw2 = document.getElementById("new_password_confirm").value;
  const pwMsg = document.getElementById("pw-msg");

  if (pw !== pw2) {
    pwMsg.textContent = "ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    pwMsg.className = "small text-danger mt-1";
    return;
  }
  pwMsg.textContent = "";

  const payload = { current_password: current, new_password: pw };
  const res = await fetch("http://127.0.0.1:8000/user/change-pw", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify(payload)
  });
  if (res.ok) {
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.");
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    window.location.href = "login.html";
  } else {
    const err = await res.json().catch(()=>null);
    pwMsg.textContent = (err && err.detail) || "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
    pwMsg.className = "small text-danger mt-1";
  }
}

// ---- íšŒì› íƒˆí‡´ ----
async function onDeleteAccount() {
  if (!confirm("ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
  const token = localStorage.getItem("access_token");
  if (!token) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    return;
  }
  const res = await fetch("http://127.0.0.1:8000/user/delete", {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + token }
  });
  if (res.ok) {
    alert("íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    localStorage.clear();
    window.location.href = "index.html";
  } else {
    const err = await res.json().catch(()=>null);
    alert((err && err.detail) || "íšŒì› íƒˆí‡´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  }
}

// ---- ì§€ì—­ 3ë‹¨ê³„ ì„ íƒ ----
let selectedSido = null;
let selectedGugun = null;
let selectedDong = null;
let selectedRegionId = null;

async function loadSidos() {
  const res = await fetch("http://127.0.0.1:8000/regions/sidos");
  if (!res.ok) {
    console.error("sidos load fail", res.status);
    return;
  }
  const list = await res.json();
  const ul = document.getElementById("sido-list");
  ul.innerHTML = "";
  list.forEach(sido => {
    const li = document.createElement("li");
    li.className = "list-group-item list-group-item-action";
    li.textContent = sido.name;
    li.onclick = () => {
      selectedSido = sido;
      selectedGugun = null;
      selectedDong = null;
      loadGuguns(sido.id);
      document.getElementById("sigungu-list").innerHTML = "";
      document.getElementById("dong-list").innerHTML = "";
      updateSelectedText();
    };
    ul.appendChild(li);
  });
}

async function loadGuguns(sidoId) {
  const res = await fetch(`http://127.0.0.1:8000/regions/guguns/${sidoId}`);
  if (!res.ok) return;
  const list = await res.json();
  const ul = document.getElementById("sigungu-list");
  ul.innerHTML = "";
  list.forEach(gu => {
    const li = document.createElement("li");
    li.className = "list-group-item list-group-item-action";
    li.textContent = gu.name;
    li.onclick = () => {
      selectedGugun = gu;
      selectedDong = null;
      loadDongs(gu.id);
      document.getElementById("dong-list").innerHTML = "";
      updateSelectedText();
    };
    ul.appendChild(li);
  });
}

async function loadDongs(gugunId) {
  const res = await fetch(`http://127.0.0.1:8000/regions/dongs/${gugunId}`);
  if (!res.ok) return;
  const list = await res.json();
  const ul = document.getElementById("dong-list");
  ul.innerHTML = "";
  list.forEach(dong => {
    const li = document.createElement("li");
    li.className = "list-group-item list-group-item-action";
    li.textContent = dong.name;
    li.onclick = () => {
      selectedDong = dong;
      selectedRegionId = dong.id;
      updateSelectedText();
    };
    ul.appendChild(li);
  });
}

function updateSelectedText() {
  const text = document.getElementById("region-selected-text");
  if (selectedSido && selectedGugun && selectedDong) {
    text.textContent = `ì„ íƒëœ ì§€ì—­: ${selectedSido.name} ${selectedGugun.name} ${selectedDong.name}`;
  } else if (selectedSido && selectedGugun) {
    text.textContent = `ì„ íƒëœ ì§€ì—­: ${selectedSido.name} ${selectedGugun.name}`;
  } else if (selectedSido) {
    text.textContent = `ì„ íƒëœ ì§€ì—­: ${selectedSido.name}`;
  } else {
    text.textContent = "ì„ íƒëœ ì§€ì—­: ì—†ìŒ";
  }
}

function applyRegionSelection() {
  if (!selectedRegionId) {
    alert("ì‹œÂ·ë„, ì‹œÂ·êµ°Â·êµ¬, ë™ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }
  const label = `${selectedSido.name} ${selectedGugun.name} ${selectedDong.name}`;
  document.getElementById("edit-region-label").value = label;
  document.getElementById("edit-region-id").value = selectedRegionId;

  const modalEl = document.getElementById("regionModal");
  const modal = bootstrap.Modal.getInstance(modalEl);
  modal.hide();
}
let notifCount = 0;

async function loadNotifications() {
  const token = localStorage.getItem("access_token");
  if (!token) return;

  try {
    const res = await fetch("http://127.0.0.1:8000/notifications/", {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) return;
    const items = await res.json();   // [{id, type, message, ...}, ...]

    const ul = document.getElementById("notif-list");
    if (!ul) return;
    ul.innerHTML = "";

    items.forEach(n => {
      const li = document.createElement("li");
      li.className = "list-group-item py-2";
      li.textContent = n.message;
      ul.appendChild(li);
    });

    if (items.length > 0) {
      notifCount = items.filter(n => !n.is_read).length || items.length;
      const badge = document.getElementById("notif-badge");
      if (badge) {
        badge.textContent = notifCount;
        badge.classList.toggle("d-none", notifCount === 0);
      }
    }
  } catch (e) {
    console.error("loadNotifications error", e);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("notif-btn");
  const panel = document.getElementById("notif-panel");
  const closeBtn = document.getElementById("notif-close");

  if (!btn || !panel) return;

  btn.addEventListener("click", async () => {
    if (panel.classList.contains("d-none")) {
      await loadNotifications();          // ì—´ ë•Œë§ˆë‹¤ ìµœì‹  ëª©ë¡
      panel.classList.remove("d-none");
      const badge = document.getElementById("notif-badge");
      if (badge) badge.classList.add("d-none");   // ì—´ë©´ ë±ƒì§€ ì´ˆê¸°í™”
    } else {
      panel.classList.add("d-none");
    }
  });

  if (closeBtn) {
    closeBtn.addEventListener("click", () => panel.classList.add("d-none"));
  }
});

</script>
</body>
</html>
