<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>WALKorea - ì—¬í–‰ ì„œë¹„ìŠ¤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<header class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold text-success" href="index.html">WALKorea</a>
        <ul class="navbar-nav ms-auto gap-2">
            <li class="nav-item"><a class="nav-link" href="places/list">ì¶”ì²œ ì—¬í–‰ì§€</a></li>
            <li class="nav-item"><a class="nav-link" href="calendar.html">ì—¬í–‰ ìº˜ë¦°ë”</a></li>
            <li class="nav-item"><a class="nav-link" href="mypage_calendar.html">ë§ˆì´í˜ì´ì§€</a></li>
            <li class="nav-item" id="nav-login">
                <a class="btn btn-success" href="login.html">ë¡œê·¸ì¸</a>
            </li>
            <li class="nav-item" id="nav-signup">
                <a class="btn btn-primary" href="signup.html">íšŒì›ê°€ì…</a>
            </li>
        </ul>
    </div>
</header>
<main class="container" style="margin-top:100px;">
    <div class="text-center pt-5 mt-5">
        <h2 class="fw-bold display-5">WALKoreaì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</h2>
        <p class="lead mb-4">
            ì—¬í–‰ ìŠ¤íƒ€ì¼ì— ë§ëŠ” ì¶”ì²œ ì—¬í–‰ì§€ì™€ ìº˜ë¦°ë”, ê°œì¸í™” ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.<br>
            ìƒë‹¨ì˜ <b>ë¡œê·¸ì¸</b> ë˜ëŠ” <b>íšŒì›ê°€ì…</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.
        </p>
        <img src="assets/img/sample_main.jpg" alt="ì—¬í–‰ ë©”ì¸" class="img-fluid rounded shadow-sm" style="max-width:280px;">
    </div>
</main>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // 1) ì†Œì…œ ì½œë°± í† í° ì €ì¥
  const param = new URLSearchParams(location.search);
  const access = param.get("access_token");
  const refresh = param.get("refresh_token");
  if (access && refresh) {
    localStorage.setItem("access_token", access);
    localStorage.setItem("refresh_token", refresh);
    window.history.replaceState({}, document.title, location.pathname);
  }

  // 2) ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë„¤ë¹„ê²Œì´ì…˜ ë³€ê²½
  const token = localStorage.getItem("access_token");
  const nav = document.querySelector(".navbar-nav");
  if (!nav) return;

  const loginLi  = document.getElementById("nav-login");
  const signupLi = document.getElementById("nav-signup");

  if (!token) return;

  if (loginLi)  loginLi.remove();
  if (signupLi) signupLi.remove();

  // (1) ë§ˆì´í˜ì´ì§€ ë’¤ì— ì•Œë¦¼ ì•„ì´ì½˜ ì¶”ê°€
  const notifLi = document.createElement("li");
  notifLi.className = "nav-item position-relative d-flex align-items-center";
  notifLi.innerHTML = `
    <button id="notif-btn" class="btn btn-link nav-link p-0 position-relative">
      <span class="fs-5">ğŸ””</span>
      <span id="notif-badge"
            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
      </span>
    </button>
    <div id="notif-panel"
        class="card shadow-sm position-absolute end-0 d-none"
        style="width:260px; z-index:1050; top:100%; margin-top:8px;">
      <div class="card-header py-2 px-3 d-flex justify-content-between align-items-center">
        <span class="small fw-semibold">ì•Œë¦¼</span>
        <button id="notif-close" class="btn btn-sm btn-outline-secondary py-0 px-1">Ã—</button>
      </div>
      <ul id="notif-list" class="list-group list-group-flush small"></ul>
    </div>
  `;
  const mypageLi = document.querySelector('a[href="mypage_calendar.html"]')?.parentElement;
  if (mypageLi && mypageLi.parentElement) {
    mypageLi.parentElement.insertBefore(notifLi, mypageLi.nextSibling);
  } else {
    nav.appendChild(notifLi);
  }

  // (2) ë‹‰ë„¤ì„ li
  const profileLi = document.createElement("li");
  profileLi.className = "nav-item d-flex align-items-center";
  profileLi.innerHTML = `<span class="me-2 fw-semibold" id="nav-nickname">ë¡œê·¸ì¸ ì‚¬ìš©ì</span>`;
  nav.appendChild(profileLi);

  // (3) ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
  const logoutLi = document.createElement("li");
  logoutLi.className = "nav-item";
  logoutLi.innerHTML = `<a class="btn btn-outline-danger" href="#">ë¡œê·¸ì•„ì›ƒ</a>`;
  logoutLi.querySelector("a").onclick = function (e) {
    e.preventDefault();
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    window.location.href = "/";
  };
  nav.appendChild(logoutLi);

  // (4) í”„ë¡œí•„ ë‹‰ë„¤ì„ ì±„ìš°ê¸°
  fetch("http://127.0.0.1:8000/user/profile", {
    headers: { "Authorization": "Bearer " + token }
  })
    .then(res => res.ok ? res.json() : null)
    .then(data => {
      const nickSpan = document.getElementById("nav-nickname");
      if (data && nickSpan && data.nickname) {
        nickSpan.textContent = data.nickname;
      }
    })
    .catch(err => console.error("profile error", err));

  // -------- ì—¬ê¸°ì„œë¶€í„° ì•Œë¦¼ íŒ¨ë„ ì œì–´ --------
  const notifBtn   = document.getElementById("notif-btn");
  const notifPanel = document.getElementById("notif-panel");
  const notifClose = document.getElementById("notif-close");
  const notifList  = document.getElementById("notif-list");

  if (!notifBtn || !notifPanel) return;

  async function loadNotifications() {
    const t = localStorage.getItem("access_token");
    if (!t || !notifList) return;

    try {
      const res = await fetch("http://127.0.0.1:8000/notifications/", {
        headers: { "Authorization": "Bearer " + t }
      });
      if (!res.ok) return;
      const items = await res.json();
      notifList.innerHTML = "";
      items.forEach(n => {
        const li = document.createElement("li");
        li.className = "list-group-item py-2";
        li.textContent = n.message;
        notifList.appendChild(li);
      });
    } catch (e) {
      console.error("loadNotifications error", e);
    }
  }

  notifBtn.addEventListener("click", async () => {
    if (notifPanel.classList.contains("d-none")) {
      await loadNotifications();
      notifPanel.classList.remove("d-none");
      const badge = document.getElementById("notif-badge");
      if (badge) badge.classList.add("d-none");
    } else {
      notifPanel.classList.add("d-none");
    }
  });

  if (notifClose) {
    notifClose.addEventListener("click", () => {
      notifPanel.classList.add("d-none");
    });
  }
});
</script>
</body>
</html>
