<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>마이페이지 | WALKorea</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<header class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold text-success" href="index.html">WALKorea</a>
    <ul class="navbar-nav ms-auto gap-2">
      <li class="nav-item"><a class="nav-link" href="recommend.html">추천 여행지</a></li>
      <li class="nav-item"><a class="nav-link" href="calendar.html">여행 캘린더</a></li>
      <li class="nav-item"><a class="nav-link" href="mypage_calendar.html">마이페이지</a></li>
      <li class="nav-item" id="nav-login">
        <a class="btn btn-success" href="login.html">로그인</a>
      </li>
      <li class="nav-item" id="nav-signup">
        <a class="btn btn-primary" href="signup.html">회원가입</a>
      </li>
    </ul>
  </div>
</header>

<main class="container py-5" style="max-width:960px;">
  <div class="row g-4">
    <!-- 좌측: 기본 정보 카드 -->
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3 class="mb-3 fw-bold">내 정보</h3>
          <p class="text-muted small mb-4">가입 시 입력한 기본 정보를 확인하고 일부를 수정할 수 있습니다.</p>

          <form id="profile-form">
            <div class="mb-3">
              <label class="form-label">아이디</label>
              <input type="text" class="form-control" id="userid" disabled>
            </div>
            <div class="mb-3">
              <label class="form-label">이메일</label>
              <input type="email" class="form-control" id="email" disabled>
            </div>
            <div class="mb-3">
              <label class="form-label">닉네임</label>
              <input type="text" class="form-control" id="nickname">
              <div id="nickname-msg" class="small mt-1"></div>
            </div>
            <div class="mb-3">
              <label class="form-label">휴대폰 번호</label>
              <input type="text" class="form-control" id="phonenum" placeholder="01012345678">
              <div id="phone-msg" class="small mt-1"></div>
            </div>
            <div class="mb-3">
              <label class="form-label">생년월일</label>
              <input type="date" class="form-control" id="birthday">
            </div>
            <div class="mb-3">
              <label class="form-label">성별</label>
              <select class="form-select" id="gender">
                <option value="">선택</option>
                <option value="M">남성</option>
                <option value="F">여성</option>
                <option value="O">기타</option>
              </select>
            </div>
            <button type="submit" class="btn btn-success w-100 mt-2">정보 저장</button>
          </form>
        </div>
      </div>
    </div>

    <!-- 우측: 비밀번호 변경 / 기타 -->
    <div class="col-lg-5">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h4 class="fw-bold mb-3">비밀번호 변경</h4>
          <form id="pw-form">
            <div class="mb-2">
              <label class="form-label">현재 비밀번호</label>
              <input type="password" class="form-control" id="current_password" required>
            </div>
            <div class="mb-2">
              <label class="form-label">새 비밀번호</label>
              <input type="password" class="form-control" id="new_password" required>
            </div>
            <div class="mb-2">
              <label class="form-label">새 비밀번호 확인</label>
              <input type="password" class="form-control" id="new_password_confirm" required>
            </div>
            <div id="pw-msg" class="small mt-1"></div>
            <button type="submit" class="btn btn-outline-primary w-100 mt-2">비밀번호 변경</button>
          </form>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <h4 class="fw-bold mb-3">계정 관리</h4>
          <button id="logout-btn" class="btn btn-outline-secondary w-100 mb-2">로그아웃</button>
          <button id="delete-btn" class="btn btn-outline-danger w-100">회원 탈퇴</button>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
// 공통: 로그인 상태에 따라 헤더 버튼 변경
window.addEventListener("DOMContentLoaded", async function() {
  const token = localStorage.getItem("access_token");
  const nav = document.querySelector(".navbar-nav");
  const loginLi = document.getElementById("nav-login");
  const signupLi = document.getElementById("nav-signup");

  if (token && nav) {
    if (loginLi) loginLi.remove();
    if (signupLi) signupLi.remove();

    const profileLi = document.createElement("li");
    profileLi.className = "nav-item d-flex align-items-center";
    profileLi.innerHTML = `<span class="me-2 fw-semibold" id="nav-nickname">로그인 사용자</span>`;
    nav.appendChild(profileLi);

    const logoutNavLi = document.createElement("li");
    logoutNavLi.className = "nav-item";
    logoutNavLi.innerHTML = `<a class="btn btn-outline-danger" href="#">로그아웃</a>`;
    logoutNavLi.querySelector("a").onclick = function(e) {
      e.preventDefault();
      localStorage.removeItem("access_token");
      localStorage.removeItem("refresh_token");
      window.location.href = "index.html";
    };
    nav.appendChild(logoutNavLi);

    // 마이페이지 진입 시 프로필 불러오기
    await loadProfile(token);
  } else {
    // 토큰 없으면 로그인 페이지로 보낼지 선택
    // window.location.href = "login.html";
  }

  // 이벤트 바인딩
  document.getElementById("profile-form").addEventListener("submit", onSaveProfile);
  document.getElementById("pw-form").addEventListener("submit", onChangePassword);
  document.getElementById("logout-btn").addEventListener("click", () => {
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    window.location.href = "index.html";
  });
  document.getElementById("delete-btn").addEventListener("click", onDeleteAccount);

  // 닉네임 중복 체크
  const nickInput = document.getElementById("nickname");
  const nickMsg = document.getElementById("nickname-msg");
  let nickTimer = null;
  nickInput.addEventListener("input", function() {
    clearTimeout(nickTimer);
    const val = nickInput.value.trim();
    if (val.length < 2) {
      nickMsg.textContent = "닉네임을 2자 이상 입력하세요.";
      nickMsg.className = "small text-danger mt-1";
      return;
    }
    nickTimer = setTimeout(async () => {
      const res = await fetch(`/auth/check-nickname?nickname=${encodeURIComponent(val)}`);
      const data = await res.json().catch(()=>null);
      if (data && data.result === "dup") {
        nickMsg.textContent = "이미 사용 중인 닉네임입니다.";
        nickMsg.className = "small text-danger mt-1";
      } else {
        nickMsg.textContent = "사용 가능한 닉네임입니다.";
        nickMsg.className = "small text-success mt-1";
      }
    }, 400);
  });

  // 휴대폰 번호 포맷 체크
  const phoneInput = document.getElementById("phonenum");
  const phoneMsg = document.getElementById("phone-msg");
  phoneInput.addEventListener("input", function() {
    let val = phoneInput.value.replace(/\D/g, "");
    phoneInput.value = val;
    if (!val) {
      phoneMsg.textContent = "";
      return;
    }
    if (/^010\d{8}$/.test(val)) {
      phoneMsg.textContent = "사용 가능한 번호입니다.";
      phoneMsg.className = "small text-success mt-1";
    } else {
      phoneMsg.textContent = "010으로 시작하는 11자리 숫자로 입력하세요.";
      phoneMsg.className = "small text-danger mt-1";
    }
  });
});

async function loadProfile(token) {
  try {
    const res = await fetch("http://127.0.0.1:8000/user/profile", {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) return;
    const data = await res.json();
    console.log("mypage profile", data);

    // 헤더 닉네임
    const navNick = document.getElementById("nav-nickname");
    if (navNick && data.nickname) navNick.textContent = data.nickname;

    // 폼 채우기
    document.getElementById("userid").value = data.userid || "";
    document.getElementById("email").value = data.email || "";
    document.getElementById("nickname").value = data.nickname || "";
    document.getElementById("phonenum").value = data.phonenum || "";
    if (data.birthday) document.getElementById("birthday").value = data.birthday;
    if (data.gender) document.getElementById("gender").value = data.gender;
  } catch (e) {
    console.error("loadProfile error", e);
  }
}

async function onSaveProfile(e) {
  e.preventDefault();
  const token = localStorage.getItem("access_token");
  if (!token) {
    alert("로그인이 필요합니다.");
    return;
  }
  const payload = {
    phonenum: document.getElementById("phonenum").value.trim(),
    nickname: document.getElementById("nickname").value.trim(),
    gender: document.getElementById("gender").value || null,
  };
  const res = await fetch("http://127.0.0.1:8000/user/profile", {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify(payload)
  });
  if (res.ok) {
    alert("프로필이 저장되었습니다.");
    const updated = await res.json();
    const navNick = document.getElementById("nav-nickname");
    if (navNick && updated.nickname) navNick.textContent = updated.nickname;
  } else {
    const err = await res.json().catch(()=>null);
    alert((err && err.detail) || "프로필 저장에 실패했습니다.");
  }
}

async function onChangePassword(e) {
  e.preventDefault();
  const token = localStorage.getItem("access_token");
  if (!token) {
    alert("로그인이 필요합니다.");
    return;
  }
  const current = document.getElementById("current_password").value;
  const pw = document.getElementById("new_password").value;
  const pw2 = document.getElementById("new_password_confirm").value;
  const pwMsg = document.getElementById("pw-msg");

  if (pw !== pw2) {
    pwMsg.textContent = "새 비밀번호와 확인이 일치하지 않습니다.";
    pwMsg.className = "small text-danger mt-1";
    return;
  }
  pwMsg.textContent = "";

  const payload = { current_password: current, new_password: pw };
  const res = await fetch("http://127.0.0.1:8000/user/change-pw", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify(payload)
  });
  if (res.ok) {
    alert("비밀번호가 변경되었습니다. 다시 로그인해 주세요.");
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    window.location.href = "login.html";
  } else {
    const err = await res.json().catch(()=>null);
    pwMsg.textContent = (err && err.detail) || "비밀번호 변경에 실패했습니다.";
    pwMsg.className = "small text-danger mt-1";
  }
}

async function onDeleteAccount() {
  if (!confirm("정말 탈퇴하시겠습니까? 되돌릴 수 없습니다.")) return;
  const token = localStorage.getItem("access_token");
  if (!token) {
    alert("로그인이 필요합니다.");
    return;
  }
  // 간단 버전: 비밀번호 추가 확인 없이 바로 삭제 API 호출
  const res = await fetch("http://127.0.0.1:8000/user/delete", {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + token }
  });
  if (res.ok) {
    alert("회원 탈퇴가 완료되었습니다.");
    localStorage.clear();
    window.location.href = "index.html";
  } else {
    const err = await res.json().catch(()=>null);
    alert((err && err.detail) || "회원 탈퇴에 실패했습니다.");
  }
}
</script>
</body>
</html>
