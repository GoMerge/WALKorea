<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>WALKorea - 좋아요 한 여행지</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/main.css" />
</head>
<body class="bg-light">

<header class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold text-success" href="index.html">WALKorea</a>
    <ul class="navbar-nav ms-auto gap-2">
      <li class="nav-item"><a class="nav-link" href="index.html">홈</a></li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="places_list.html" id="navPlace" data-bs-toggle="dropdown">
          여행정보
        </a>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="places_list.html?contenttypeid=12">관광지</a></li>
          <li><a class="dropdown-item" href="places_list.html?contenttypeid=14">문화시설</a></li>
          <li><a class="dropdown-item" href="places_list.html?contenttypeid=15">축제</a></li>
          <li><a class="dropdown-item" href="places_list.html?contenttypeid=32">숙박</a></li>
          <li><a class="dropdown-item" href="places_list.html?contenttypeid=39">음식점</a></li>
          <li><a class="dropdown-item" href="places_list.html?contenttypeid=38">쇼핑</a></li>
          <li><a class="dropdown-item" href="places_list.html?contenttypeid=28">레포츠</a></li>
        </ul>
      </li>
      <li class="nav-item"><a class="nav-link" href="mypage_calendar.html">마이페이지</a></li>
    </ul>
  </div>
</header>

<main class="container" style="margin-top:100px; max-width: 960px;">
  <div class="mb-4">
    <h2 class="fw-bold">좋아요 한 여행지</h2>
    <p class="text-muted mb-0">하트를 눌러 저장해 둔 여행지를 한눈에 모아볼 수 있습니다.</p>
  </div>

  <div id="favorites-empty" class="text-center text-muted py-5 d-none">
    아직 좋아요 한 여행지가 없습니다.<br />
    여행정보에서 마음에 드는 장소에 하트를 눌러 보관해 보세요.
  </div>

  <div id="favorites-grid" class="row g-3"></div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem("access_token");
  if (!token) {
    alert("로그인이 필요합니다.");
    window.location.href = "login.html";
    return;
  }

  const gridEl  = document.getElementById("favorites-grid");
  const emptyEl = document.getElementById("favorites-empty");

  async function loadFavorites() {
    try {
      const res = await fetch("http://127.0.0.1:8000/favorites/places", {
        headers: { "Authorization": "Bearer " + token }
      });
      if (!res.ok) throw new Error("failed");
      const items = await res.json();

      if (!items.length) {
        emptyEl.classList.remove("d-none");
        gridEl.innerHTML = "";
        return;
      }

      emptyEl.classList.add("d-none");
      gridEl.innerHTML = "";

      items.forEach(p => {
        const col = document.createElement("div");
        col.className = "col-6 col-md-4 col-lg-3";

        col.innerHTML = `
            <a href="/places/detail/${p.id}" class="text-decoration-none text-reset">
            <div class="card border-0">
                <div class="position-relative">
                <img src="${p.firstimage || '/static/no_image.jpg'}"
                    class="rounded-4 img-fluid w-100"
                    style="aspect-ratio: 1 / 1; object-fit: cover;"
                    alt="${p.title}">
                <button type="button"
                        class="btn btn-light btn-sm position-absolute top-0 end-0 m-2 rounded-circle like-btn"
                        data-place-id="${p.id}"
                        style="box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                    <span class="text-danger">♥</span>
                </button>
                </div>
                <div class="mt-2">
                <div class="fw-semibold text-truncate" title="${p.title}">${p.title}</div>
                <div class="text-muted small text-truncate" title="${p.addr1 || ''}">
                    ${p.addr1 || ""}
                </div>
                </div>
            </div>
            </a>
        `;
        gridEl.appendChild(col);
        });
    } catch (e) {
      console.error(e);
      alert("좋아요 목록을 불러오지 못했습니다.");
    }
  }

  // 작은 카드의 하트 클릭 시 좋아요 해제 + 새로고침
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".like-btn");
    if (!btn) return;

    e.preventDefault();          // 카드 링크 클릭 막기
    e.stopPropagation();

    const placeId = btn.dataset.placeId;
    try {
      const res = await fetch(`http://127.0.0.1:8000/favorites/places/${placeId}`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token }
      });
      if (!res.ok) throw new Error();
      const data = await res.json();
      if (!data.liked) {
        await loadFavorites();   // 해제되면 목록 갱신
      }
    } catch (e2) {
      console.error(e2);
      alert("좋아요 해제에 실패했습니다.");
    }
  });

  loadFavorites();
});
</script>
</body>
</html>
