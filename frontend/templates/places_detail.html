<!DOCTYPE html>
<html lang="en">
<style>
  .page-title {
    background: linear-gradient(180deg, #f9fafb 0%, #ffffff 100%);
    border-bottom: 1px solid #f3f4f6;
  }
  .heading-title {
    font-size: 2.2rem;
    font-weight: 800;
    letter-spacing: -0.03em;
    color: #111827;
  }
  .page-title .mb-0 {
    color: #6b7280;
    font-size: 0.95rem;

  
  }

  .comments-section {
  background: #f8fafc;
  padding: 40px 0;
  border-top: 1px solid #e2e8f0;
}

.comment-item {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  border-left: 4px solid #3b82f6;
  transition: all 0.2s;
}

.comment-item:hover {
  box-shadow: 0 8px 30px rgba(0,0,0,0.12);
  transform: translateY(-2px);
}

.comment-header {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 12px;
}

.comment-avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 16px;
  flex-shrink: 0;
}

.comment-meta {
  flex: 1;
  min-width: 0;
}

.comment-author {
  font-weight: 600;
  color: #1e293b;
  font-size: 0.95rem;
  margin-bottom: 2px;
}

.comment-time {
  color: #64748b;
  font-size: 0.8rem;
}

.comment-actions {
  display: flex;
  gap: 8px;
}

.btn-comment-action {
  background: none;
  border: 1px solid #e2e8f0;
  color: #64748b;
  padding: 4px 12px;
  border-radius: 6px;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-comment-action:hover {
  background: #3b82f6;
  color: white;
  border-color: #3b82f6;
}

.comment-content {
  color: #374151;
  line-height: 1.6;
  word-break: break-word;
}

#submit-comment:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
#recommend-reason.card {
  border: none;
  border-radius: 20px;
  box-shadow: 0 18px 35px rgba(15, 23, 42, 0.10);
  background: #ffffff;
  padding-top: 18px;
}

#recommend-reason .card-title {
  font-size: 0.95rem;
  font-weight: 700;
  color: #111827;
}

#recommend-reason .small.text-muted {
  color: #9ca3af !important;
}
#recommend-reason .progress {
  height: 22px;
  border-radius: 999px;
  background: linear-gradient(180deg, #f3f4f6 0%, #e5e7eb 100%);
  box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08);
}

/* ê³µí†µ ë§‰ëŒ€ ì±„ì›Œì§€ëŠ” ë¶€ë¶„: íŒŒìŠ¤í…”í†¤ + ì¤‘ì•™ ì‚´ì§ ë°ê²Œ */
#recommend-reason .progress-bar {
  border-radius: 999px;
  font-size: 0.7rem;
  line-height: 22px;
  color: #f9fafb;
  text-shadow: 0 0 2px rgba(0,0,0,0.15);
}

/* ê¸°ë³¸ ì •ë³´: ë¯¼íŠ¸ */
#score-base.progress-bar {
  background: linear-gradient(90deg, #6ee7b7 0%, #22c55e 100%);
}

/* ì—¬í–‰ ì·¨í–¥: íŒŒìŠ¤í…” ë¸”ë£¨ */
#score-topic.progress-bar {
  background: linear-gradient(90deg, #93c5fd 0%, #3b82f6 100%);
}

/* ìƒí™©/ê±°ë¦¬: íŒŒìŠ¤í…” ì˜¤ë Œì§€ */
#score-distance.progress-bar {
  background: linear-gradient(90deg, #fed7aa 0%, #fb923c 100%);
}

/* ìµœì¢… ì ìˆ˜ í…ìŠ¤íŠ¸ */
#score-final {
  font-size: 1.05rem;
  font-weight: 700;
  color: #111827;
}
</style>
<head>
  <script type="module" src="/assets/js/mypage_common.js"></script>
  <!-- ì§€ë„ êµ¬í˜„ -->
  <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=fd93df643bf67f10524ef70aafa1a1a6"></script>
  <base href="/">
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>WALKorea</title>
  <meta name="description" content="">
  <meta name="keywords" content="">

  

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
  <link href="assets/vendor/drift-zoom/drift-basic.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: TheProperty
  * Template URL: https://bootstrapmade.com/theproperty-bootstrap-real-estate-template/
  * Updated: Aug 05 2025 with Bootstrap v5.3.7
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>
  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="header-container container-fluid container-xl position-relative d-flex align-items-center justify-content-between">
      
      <!-- Logo -->
      <a href="/" class="logo d-flex align-items-center me-auto me-xl-0">
        <h1 class="sitename">WALKorea</h1>
      </a>

      <!-- Navigation Menu -->
      <nav id="navmenu" class="navmenu">
        <ul>
          <li class="dropdown">
            <a href="/"><span>ì—¬í–‰ì •ë³´</span> <i class="bi bi-chevron-down toggle-dropdown"></i></a>
            <ul>
              <li><a href="/places/list?contenttypeid=12&page=1&sort=updated">ê´€ê´‘ì§€</a></li>
              <li><a href="/places/list?contenttypeid=14&page=1&sort=updated">ë¬¸í™”ì‹œì„¤</a></li>
              <li><a href="/places/list?contenttypeid=15&page=1&sort=updated">ì¶•ì œ</a></li>
              <li><a href="/places/list?contenttypeid=32&page=1&sort=updated">ìˆ™ë°•</a></li>
              <li><a href="/places/list?contenttypeid=39&page=1&sort=updated">ìŒì‹ì </a></li>
              <li><a href="/places/list?contenttypeid=38&page=1&sort=updated">ì‡¼í•‘</a></li>
              <li><a href="/places/list?contenttypeid=28&page=1&sort=updated">ë ˆí¬ì¸ </a></li>
            </ul>
          </li>
          <li><a href="/places/map_more">ì§€ë„</a></li>
          <li><a href="/mypage_calendar">ë§ˆì´í˜ì´ì§€</a></li>
        </ul>
      </nav>

      <!-- ë¹„ë¡œê·¸ì¸: ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì ìš©) -->
      <div id="nav-guest" class="d-flex align-items-center gap-2">
        <a class="btn-getstarted" href="/signup">íšŒì›ê°€ì…</a>
        <a class="btn-getstarted" href="/login">ë¡œê·¸ì¸</a>
      </div>

      <!-- ë¡œê·¸ì¸: ì•Œë¦¼/ë‹‰ë„¤ì„/ë¡œê·¸ì•„ì›ƒ (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì ìš©) -->
      <div id="nav-user" class="d-none d-flex align-items-center gap-3">

        <!-- ì•Œë¦¼ ë²„íŠ¼ (ì‘ê²Œ) -->
        <div class="dropdown">
          <button id="notifDropdown"
                  class="btn btn-outline-success btn-sm position-relative px-2 py-1 dropdown-toggle"
                  type="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false">
            <i class="bi bi-bell"></i>
            <span id="notif-badge"
                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none small">
              0
            </span>
          </button>

          <div class="dropdown-menu dropdown-menu-end notif-dropdown">
            <div class="notif-header d-flex justify-content-between align-items-center">
              <span class="fw-semibold">ì•Œë¦¼</span>
              <button id="notif-clear-all" class="btn btn-link btn-sm text-danger p-0">ì „ì²´ì‚­ì œ</button>
            </div>
            <div class="notif-body">
              <p id="notif-empty-text" class="notif-empty text-muted small mb-2">
                ì•„ì§ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.
              </p>
              <ul id="notif-list" class="notif-list list-unstyled mb-0"></ul>
            </div>
          </div>
        </div>

        <!-- ë‹‰ë„¤ì„ + ë¼ë²¨ -->
        <div class="d-flex align-items-center gap-2">
          <div id="header-initial"
              class="mypage-user-badge"
              style="width:32px; height:32px; font-size:16px; margin-right:0;">
            ë‹‰ë„¤ì„
          </div>
          <span id="header-nickname" class="fw-semibold"></span>
        </div>

        <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼: ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš© -->
        <button id="nav-logout" class="btn-getstarted btn-logout-small">
          ë¡œê·¸ì•„ì›ƒ
        </button>
      </div>
    </div>
  </header>
  <!-- ëª©ë¡ ë -->

  <main class="main">

    <!-- Page Title -->
    <div class="page-title">
      <div class="heading">
        <div class="container">
          <div class="row d-flex justify-content-center text-center">
            <div class="col-lg-8">
              <h1 class="heading-title">{{ place.title }}</h1>

              {% if place.hashtags  %}
              <div class="property-agent">
                {% for pt in place.hashtags[:6]  %}
                <a href="/places/list?tag={{ pt.tag.name }}&page=1{% if contenttypeid %}&contenttypeid={{ contenttypeid }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}
                {% if addr %}&addr={{ addr }}{% endif %}{% if search %}&search={{ search }}{% endif %}" class="badge bg-secondary text-decoration-none me-1">#{{ pt.tag.name }}</a>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <nav class="breadcrumbs">
        <div class="container">
          <ol>
            <li><a href="/">ì—¬í–‰ì •ë³´</a></li>
            <li class="current">ìƒì„¸ë³´ê¸°</li>
          </ol>
        </div>
      </nav>
    </div><!-- End Page Title -->

<!-- Property Details Section -->
    <section id="property-details" class="property-details section">

      <div class="container" data-aos="fade-up" data-aos-delay="100">

        <div class="row gy-4">

          <div class="col-lg-8">

            <!-- Property Gallery -->
            <div class="property-gallery" data-aos="fade-up" data-aos-delay="200">
              <div class="main-image-container image-zoom-container">
                <img id="main-product-image" src="{{ place.firstimage if place.firstimage else '/static/no_image.jpg' }}" alt="{{ place.title }}" class="img-fluid main-property-image" >
                <div class="image-nav-buttons">
                  <button class="image-nav-btn prev-image" type="button">
                    <i class="bi bi-chevron-left"></i>
                  </button>
                  <button class="image-nav-btn next-image" type="button">
                    <i class="bi bi-chevron-right"></i>
                  </button>
                </div>
              </div>
              <div class="thumbnail-gallery thumbnail-list">
                 {% for img in detail_images %}
                <div class="thumbnail-item{% if loop.first %} active{% endif %}" data-image="{{ img.originimgurl }}">
                  <img src="{{ img.originimgurl }}" alt="Tour Image" class="img-fluid">
                </div>
                {% endfor %}
              </div>
            </div><!-- End Property Gallery -->

            <!-- Property Description -->
            <div class="property-description" data-aos="fade-up" data-aos-delay="300">
              <h3>ìƒì„¸ì •ë³´</h3>
              <p>{{ place.overview }}</p>
            </div><!-- End Property Description -->

            <!-- Amenities -->
            <div class="property-amenities" data-aos="fade-up" data-aos-delay="400">
            <h3>ê·¸ ì™¸ ì •ë³´</h3>

            {% if detail_info %}
            <ul class="features-list">
              {% for item in detail_info %}
              <li>
                  <i class="bi bi-check-circle"></i>
                  <strong>{{ item.label }}  :   </strong>   {{ item.value }}
              </li>
              {% endfor %}
            </ul>
              {% else %}
              <p class="text-muted">ì¶”ê°€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
              {% endif %}
            </div><!-- End Amenities -->

            <!-- Map Section -->
            <div class="property-map" data-aos="fade-up" data-aos-delay="500">
              <h3>ìœ„ì¹˜</h3>
              <div class="map-container">
                <div id="kakaomap" style="width:100%; height:400px;">
                </div>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <h6>{{ place.title }} ì§€ë„ì •ë³´ì™€ ê·¼ì²˜ ê´€ê´‘ì§€ë„ í•¨ê»˜ í™•ì¸í•´ë³´ì„¸ìš”!</h6>
              </div>
            </div><!-- End Map Section -->
            <!-- ì§€ë„ ì„¹ì…˜ ë°”ë¡œ ì•„ë˜ -->
            <section class="comments-section section" data-aos="fade-up">
              <div class="container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                  <h3><i class="bi bi-chat-dots text-primary me-2"></i>ëŒ“ê¸€ (<span id="comment-count">0</span>)</h3>
                  <small class="text-muted">ìµœëŒ€ 500ì</small>
                </div>
                
                <!-- ëŒ“ê¸€ ì…ë ¥ -->
                <div class="comment-input-section mb-4 p-4 bg-light rounded-3">
                  <div class="row g-3 align-items-end">
                    <div class="col-lg-9 col-md-8">
                      <textarea 
                        id="comment-text" 
                        class="form-control" 
                        rows="2" 
                        placeholder="ì´ ì¥ì†Œì— ëŒ€í•œ ì†Œê°ì´ë‚˜ íŒì„ ë‚¨ê²¨ì£¼ì„¸ìš”!"
                        maxlength="500"
                      ></textarea>
                      <div class="form-text">
                        <span id="char-count">0</span>/500ì
                      </div>
                    </div>
                    <div class="col-lg-3 col-md-4">
                      <button id="submit-comment" class="btn btn-primary w-100" disabled>
                        <i class="bi bi-send"></i> ë¡œê·¸ì¸ í›„ ì‘ì„±
                      </button>
                    </div>
                  </div>
                </div>

                <!-- ëŒ“ê¸€ ëª©ë¡ -->
                <div id="comments-container">
                  <div class="text-center py-5">
                    <i class="bi bi-chat-square-text fs-1 text-muted mb-3"></i>
                    <h5 class="text-muted">ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</h5>
                  </div>
              </div>
            </section>
          </div>

          <div class="col-lg-4">

            <div id="recommend-reason" class="card shadow-sm mb-3 d-none">
              <div class="card-body">
                <h5 id="match-title" class="card-title mb-3">
                  ë‚´ ì·¨í–¥ê³¼ ë§¤ì¹­
                </h5>

                <div class="mb-2 small text-muted">ê¸°ë³¸ ì •ë³´</div>
                <div class="progress mb-2">
                  <div id="score-base" class="progress-bar" role="progressbar"></div>
                </div>

                <div class="mb-2 small text-muted">ì—¬í–‰ ì·¨í–¥</div>
                <div class="progress mb-2">
                  <div id="score-topic" class="progress-bar bg-success" role="progressbar"></div>
                </div>

                <div class="mb-2 small text-muted">ìƒí™©/ê±°ë¦¬</div>
                <div class="progress mb-3">
                  <div id="score-distance" class="progress-bar bg-info" role="progressbar"></div>
                </div>

                <hr>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="small text-muted">ìµœì¢… ë§¤ì¹­ ì ìˆ˜</span>
                  <span id="score-final" class="fw-bold"></span>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">ìº˜ë¦°ë” ì¼ì •ì— ì €ì¥í•˜ê¸°</h5>
                <div class="mb-2">
                  <label class="form-label">ë°©ë¬¸ ë‚ ì§œ</label>
                  <input type="date" id="visit-date" class="form-control">
                </div>
                <button class="btn btn-success w-100" id="btn-save-to-calendar">
                  ì €ì¥í•˜ê¸°
                </button>
              </div>
            </div>
          </div>

        </div>

      </div>

    </section><!-- /Property Details Section -->
<!-- /Property Details Section -->

  </main>

  <script>
    const PLACE_ID = {{ place.contentid }};
  </script>

  <footer id="footer" class="footer position-relative">


    <div class="footer-bottom">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-6">
            <div class="copyright">
              <p>Â© <span>WALKorea</span></p>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="footer-bottom-links">
              <a href="#">ê°œë°œì ê¹€í˜œì˜</a>
              <a href="#">ê°œë°œì ì´ì§€ì˜</a>
            </div>
            <div class="credits">
            </div>
          </div>
        </div>
      </div>
    </div>

  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="assets/vendor/drift-zoom/Drift.min.js"></script>

  <!-- Main JS File -->
  <script src="assets/js/main.js"></script>

  <script type="module">
    const API_BASE = 'https://walkorea.inhatc.com';

    import { goLoginWithReturn } from "./assets/js/mypage_common.js";
    document.addEventListener("DOMContentLoaded", async () => {
      const placeId = PLACE_ID;
      
      const token = localStorage.getItem("access_token");
      
      
      const btn = document.getElementById("btn-save-to-calendar");
      const dateInput = document.getElementById("visit-date");

      if (!btn || !dateInput) {
        console.warn("ìº˜ë¦°ë” ì €ì¥ UIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      btn.addEventListener("click", async () => {
        console.log("ë²„íŠ¼ í´ë¦­ë¨!");
        const dateStr = dateInput.value;
        if (!dateStr) {
          alert("ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
          return;
        }

        let token = localStorage.getItem("access_token");
        if (!token || token.length < 10) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          goLoginWithReturn();
          return;
        }

        // ìƒì„¸í˜ì´ì§€ íƒ€ì´í‹€ ê°€ì ¸ì˜¤ê¸°
        const titleEl = document.querySelector(".heading-title");
        const title = titleEl ? titleEl.textContent.trim() : "ì—¬í–‰ ì¼ì •";

        console.log("ì €ì¥ ì‹œë„:", title, dateStr);

        const res = await fetch(
          API_BASE + `/calendar/places/${placeId}/events2`,
          {
            method: "POST",
            headers: {
              "Authorization": "Bearer " + token,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              title: title,
              visit_date: dateStr,
            }),
          }
        );

        if (res.ok) {
          alert("ìº˜ë¦°ë”ì— ì €ì¥í–ˆìŠµë‹ˆë‹¤.");
        } else {
          const err = await res.json().catch(() => ({}));
          alert("ì €ì¥ ì‹¤íŒ¨: " + (err.detail || res.status));
        }
      });


      const box = document.getElementById("recommend-reason");
      if (!box) return;

      // 1) ì¶”ì²œ ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
      try {
        const res = await fetch(API_BASE + `/places/recommend/reason/${placeId}`, {
          headers: { "Authorization": "Bearer " + token },
        });

        if (!res.ok) return;
        const data = await res.json();
        if (!data.is_recommended) return;   

        box.classList.remove("d-none");

        const toPercent = v => Math.round((v || 0) * 100);
        const base = toPercent(data.base);
        const topic = toPercent(data.topic);
        const distance = toPercent(data.distance);
        const final = toPercent(data.final);

        const setBar = (id, value) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.style.width = value + "%";
          el.textContent = value + "%";
        };

        setBar("score-base", base);
        setBar("score-topic", topic);
        setBar("score-distance", distance);
        document.getElementById("score-final").textContent = final + "%";
      } catch (e) {
        console.error("load reason error", e);
        return; // ì ìˆ˜ ì‹¤íŒ¨í•˜ë©´ ì•„ë˜ ë‹‰ë„¤ì„ ë¡œì§ë„ ì•ˆ ëŒê²Œ í•˜ê³  ì‹¶ìœ¼ë©´ ì´ ì¤„ ìœ ì§€
      }

      // 2) ë‹‰ë„¤ì„ìœ¼ë¡œ ì œëª© ë°”ê¾¸ê¸°
      try {
        const meRes = await fetch(API_BASE + "/user/profile", {
          headers: { "Authorization": "Bearer " + token },
        });
        if (meRes.ok) {
          const me = await meRes.json();   // { nickname: "ì½©ìˆœì´", ... } í˜•íƒœ
          if (me.nickname) {
            const titleEl = document.getElementById("match-title");
            if (titleEl) {
              titleEl.textContent = `${me.nickname}ë‹˜ ì·¨í–¥ê³¼ ë§¤ì¹­`;
            }
          }
        }
      } catch (e) {
        console.error("load me error", e);
      }
    });
  </script>

  <!-- ì§€ë„--><!-- ì§€ë„--><!-- ì§€ë„--><!-- ì§€ë„--><!-- ì§€ë„--><!-- ì§€ë„--><!-- ì§€ë„--><!-- ì§€ë„--><!-- ì§€ë„--><!-- ì§€ë„--><!-- ì§€ë„--><!-- ì§€ë„--><!-- ì§€ë„--><!-- ì§€ë„--><!-- ì§€ë„--><!-- ì§€ë„--><!-- ì§€ë„-->
<!-- ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ì „ì²´ êµì²´ -->
<script>
(function() {
  function initMap() {
    console.log('â³ Kakao SDK ëŒ€ê¸° ì¤‘...');
    
    if (typeof kakao === 'undefined' || !kakao.maps) {
      setTimeout(initMap, 500);
      return;
    }
    
    var container = document.getElementById('kakaomap');
    if (!container) {
      console.error('âŒ #kakaomap divë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      return;
    }
    
    var centerLatLng = new kakao.maps.LatLng({{ place.mapy|default(37.566826) }}, {{ place.mapx|default(126.9786567) }});
    var map = new kakao.maps.Map(container, {
      center: centerLatLng,
      level: 10
    });
    
    // ë©”ì¸ ë§ˆì»¤ ì´ë¯¸ì§€ (ê¸°ë³¸ ë³„ ì•„ì´ì½˜)
    var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";
    var imageSize = new kakao.maps.Size(24, 35);
    var imageOption = {offset: new kakao.maps.Point(12, 35)};
    var mainMarkerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
    
    var mainMarker = new kakao.maps.Marker({
      position: centerLatLng,
      map: map,
      title: '{{ place.title }}',
      image: mainMarkerImage,
      zIndex: 999
    });
    
    var mainInfowindow = new kakao.maps.InfoWindow({
      content: `
        <div style="padding:16px; min-width:180px; text-align:left; border-radius:8px; background:#FFF8E1; box-shadow:0 2px 10px rgba(0,0,0,0.1);">
          <h6 style="margin:0 0 8px 0; font-weight:600; color:#D84315; font-size:15px; border-bottom:2px solid #FF9800; padding-bottom:5px;">ğŸ“ í˜„ì¬ ìœ„ì¹˜</h6>
          <p style="margin:0 0 12px 0; font-size:13px; color:#666; line-height:1.4;">{{ place.addr1 }}</p>
        </div>
      `,
      zIndex: 10000
    });
    
    var mainInfowindowOpened = false;
    kakao.maps.event.addListener(mainMarker, 'click', function() {
      if (mainInfowindowOpened) {
        mainInfowindow.close();
        mainInfowindowOpened = false;
      } else {
        mainInfowindow.open(map, mainMarker);
        mainInfowindowOpened = true;
      }
    });
    
    var nearbyPlaces = {{ nearby_places | tojson | safe }};
    console.log('ğŸ“ ì£¼ë³€ ê´€ê´‘ì§€:', nearbyPlaces.length, 'ê°œ');
    
    var nearbyInfoWindows = [];
    var nearbyInfoOpenedFlags = [];
    var bounds = new kakao.maps.LatLngBounds();
    bounds.extend(centerLatLng);
    
    if (nearbyPlaces && nearbyPlaces.length > 0) {
      nearbyPlaces.forEach(function(p, idx) {
        if (!p.mapx || !p.mapy || !p.title) return;
        
        var pos = new kakao.maps.LatLng(p.mapy, p.mapx);
        bounds.extend(pos);
        
        var nearbyMarker = new kakao.maps.Marker({
          position: pos,
          map: map,
          title: p.title,
          zIndex: 1
        });
        
        var nearbyInfowindow = new kakao.maps.InfoWindow({
          content: `
            <div style="padding:12px; min-width:150px; border-radius:8px; background:white; box-shadow:0 2px 10px rgba(0,0,0,0.1);">
              <h6 style="margin:0 0 5px 0; font-size:14px;">${p.title}</h6>
              <p style="margin:0 0 8px 0; font-size:12px; color:#666;">${p.addr1 || ''}</p>
              <a href="/places/detail/${p.contentid}" style="padding:4px 8px; background:#007bff; color:white; text-decoration:none; font-size:11px; border-radius:4px;">ìƒì„¸ë³´ê¸°</a>
            </div>`
            ,zIndex: 999
        });
        
        nearbyInfoWindows.push(nearbyInfowindow);
        nearbyInfoOpenedFlags.push(false);
        
        kakao.maps.event.addListener(nearbyMarker, 'click', function() {
          if (nearbyInfoOpenedFlags[idx]) {
            nearbyInfowindow.close();
            nearbyInfoOpenedFlags[idx] = false;
          } else {
            nearbyInfowindow.open(map, nearbyMarker);
            nearbyInfoOpenedFlags[idx] = true;
          }
        });
      });
      
      map.setBounds(bounds);
    }
    
    // ì§€ë„ í´ë¦­ ì‹œ ëª¨ë“  ì¸í¬ìœˆë„ìš° ë‹«ê¸°
    kakao.maps.event.addListener(map, 'click', function() {
      if (mainInfowindowOpened) {
        mainInfowindow.close();
        mainInfowindowOpened = false;
      }
      nearbyInfoWindows.forEach(function(iw, idx) {
        if (nearbyInfoOpenedFlags[idx]) {
          iw.close();
          nearbyInfoOpenedFlags[idx] = false;
        }
      });
    });
    
    console.log('ğŸ‰ ë§ˆì»¤ ë° ì¸í¬ìœˆë„ìš° í† ê¸€ ê¸°ëŠ¥ ì™„ì „ ë¡œë“œ ì„±ê³µ!');
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => setTimeout(initMap, 500));
  } else {
    setTimeout(initMap, 500);
  }
})();
</script>
<script type="module">
  import { initHeader } from "/assets/js/header.js";
  import { goLoginWithReturn } from "./assets/js/mypage_common.js";
  window.addEventListener("DOMContentLoaded", async () => {
    await initHeader();                 
  });
</script>

<!-- ëŒ“ê¸€ --><!-- ëŒ“ê¸€ --><!-- ëŒ“ê¸€ --><!-- ëŒ“ê¸€ --><!-- ëŒ“ê¸€ --><!-- ëŒ“ê¸€ --><!-- ëŒ“ê¸€ --><!-- ëŒ“ê¸€ --><!-- ëŒ“ê¸€ -->
<script>
  const API_BASE = 'https://walkorea.inhatc.com';
  const PLACE_ID = {{ place.contentid }}; 
document.addEventListener("DOMContentLoaded", function() {
  const token = localStorage.getItem("access_token");
  
  let comments = [];
  let currentUser = null;
  
  initComments();
  
  async function initComments() {
    await loadComments();
    document.getElementById("comment-text").addEventListener("input", onCommentInput);
    document.getElementById("submit-comment").addEventListener("click", submitComment);

    // token ìƒˆë¡œ ê°€ì ¸ì˜¤ê¸° (ì „ì—­ ë³€ìˆ˜ ë§ê³ !)
    const currentToken = localStorage.getItem("access_token");
    const btn = document.getElementById("submit-comment");

    if (currentToken) {
      await loadUserProfile();
      btn.innerHTML = `<i class="bi bi-send"></i> ì‘ì„±í•˜ê¸°`;
      btn.disabled = false;  // ë¡œê·¸ì¸ì‹œ ë²„íŠ¼ í™œì„±í™”!
    } else {
      btn.disabled = true;
      btn.innerHTML = `<i class="bi bi-lock"></i> ë¡œê·¸ì¸ í›„ ì‘ì„±`;
    }
  }

  
  
  async function loadUserProfile() {
    try {
      const res = await fetch(API_BASE + "/user/profile", {
        headers: { "Authorization": "Bearer " + token }
      });
      if (res.ok) currentUser = await res.json();
    } catch (e) {
      console.error("í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:", e);
    }
  }
  
  async function loadComments() {
    try {

      const headers = {};
      if (token) {
        headers["Authorization"] = "Bearer " + token;
      }

    const res = await fetch(API_BASE + `/places/${PLACE_ID}/comments`, {
      headers,
    });

    if (res.ok) {
        comments = await res.json();
        renderComments();
      }
    } catch (e) {
      console.error("ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:", e);
    }
  }
  
  function onCommentInput(e) {
    const text = e.target.value;
    const count = text.length;
    document.getElementById("char-count").textContent = count;
    
    const btn = document.getElementById("submit-comment");
    const token = localStorage.getItem("access_token");
    
    if (count > 0 && count <= 500 && token) {  // ğŸ”¥ í† í° ìˆì–´ì•¼ë§Œ í™œì„±í™”
      btn.disabled = false;
      btn.innerHTML = `<i class="bi bi-send"></i> ëŒ“ê¸€ ì‘ì„±`;
    } else {
      btn.disabled = true;
      btn.innerHTML = token 
        ? `<i class="bi bi-send"></i> ${count > 500 ? 'ë„ˆë¬´ ê¹ë‹ˆë‹¤' : 'ì‘ì„±í•˜ê¸°'}`
        : `<i class="bi bi-lock"></i> ë¡œê·¸ì¸ í›„ ì‘ì„±`;
    }
  }
  
  async function submitComment() {
    const text = document.getElementById("comment-text").value.trim();
    if (!text) return;
    
    const token = localStorage.getItem("access_token");
    if (!token) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      window.goLoginWithReturn();
      return;
    }

    const btn = document.getElementById("submit-comment");
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>ë“±ë¡ì¤‘...`;
    
    try {
      const res = await fetch(API_BASE + `/places/${PLACE_ID}/comments`, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ content: text })
      });

      if (res.ok) {
        document.getElementById("comment-text").value = "";
        await loadComments(); // ì¬ë¡œë“œ
      } else {
        alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");
      }
    } catch (e) {
      console.error(e);
      alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
    } finally {
      btn.innerHTML = originalHTML;
      btn.disabled = false;
    }
  }
  
  function renderComments() {
    const container = document.getElementById("comments-container");
    const countEl = document.getElementById("comment-count");
    
    countEl.textContent = comments.length;
    
    if (comments.length === 0) {
      container.innerHTML = `
        <div class="text-center py-5">
          <i class="bi bi-chat-square-text fs-1 text-muted mb-3"></i>
          <h5 class="text-muted">ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</h5>
        </div>
      `;
      return;
    }
    
    container.innerHTML = comments.map(c => createCommentHTML(c)).join("");
  }
  
  function createCommentHTML(comment) {
    const isMine = currentUser && comment.user_id === currentUser.id;
    const timeAgo = formatTimeAgo(comment.created_at);
    
    return `
      <div class="comment-item">
        <div class="comment-header">
          <div class="comment-avatar">${getInitials(comment.nickname)}</div>
          <div class="comment-meta">
            <div class="comment-author">${comment.nickname}</div>
            <div class="comment-time">${timeAgo}</div>
          </div>
          ${isMine ? `
            <div class="comment-actions">
              <button class="btn-comment-action" onclick="deleteComment(${comment.id})">
                <i class="bi bi-trash3 me-1"></i>ì‚­ì œ
              </button>
            </div>
          ` : ''}
        </div>
        <div class="comment-content">${comment.content}</div>
      </div>
    `;
  }
  
  function getInitials(name) {
    return name.charAt(0);
  }
  
  function formatTimeAgo(dateStr) {
    const now = new Date();
    const date = new Date(dateStr);

     // UTC â†’ KST ë³€í™˜ (+9ì‹œê°„)
    date.setHours(date.getHours() + 9);
    const diff = now - date;
    
    if (diff < 60 * 1000) return "ë°©ê¸ˆ ì „";
    if (diff < 60 * 60 * 1000) return `${Math.floor(diff / 60000)}ë¶„ ì „`;
    if (diff < 24 * 60 * 60 * 1000) return `${Math.floor(diff / 3600000)}ì‹œê°„ ì „`;
    return `${Math.floor(diff / 86400000)}ì¼ ì „`;
  }
  
  window.deleteComment = async (commentId) => {
    if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
    try {
      const res = await fetch(API_BASE + `/places/${PLACE_ID}/comments/${commentId}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      });

      if (res.ok) {
        await loadComments();
      } else {
        alert("ì‚­ì œ ì‹¤íŒ¨");
      }
    } catch (e) {
      alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
    }
  };
});
</script>
</body>
</html>
