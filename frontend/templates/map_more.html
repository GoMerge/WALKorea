<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ì§€ë„ êµ¬í˜„ -->
   
  <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=55562bb0d8e5870b4ba807c7e9cac258&libraries=services,clusterer,geometry"></script>
  <base href="/" / >
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Property Details - TheProperty Bootstrap Template</title>
  <meta name="description" content="">
  <meta name="keywords" content="">

  

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
  <link href="assets/vendor/drift-zoom/drift-basic.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: TheProperty
  * Template URL: https://bootstrapmade.com/theproperty-bootstrap-real-estate-template/
  * Updated: Aug 05 2025 with Bootstrap v5.3.7
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
  <script  type="module" src="./assets/js/mypage_common.js"></script>
  <style>
    body { 
        padding-top: 80px; 
        margin: 0;
        font-family: Arial, sans-serif;
    }
    html { height: 100%; }
    main {
        height: calc(100vh - 80px); 
        margin: 0;
    }
    .main { 
        display: flex; 
        height: 100%; 
    }
    #map { 
        flex: 1; 
        height: 100%; 
    }
    .sidebar {
        width: 350px;
        padding: 20px;
        overflow-y: auto;
        background: #fff;
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        height: 100%;
    }
    input, button {
        width: 100%;
        padding: 12px;
        box-sizing: border-box;
        margin-bottom: 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
    }
    .search-btn {
        background: #fee500 !important;
        border: none;
        cursor: pointer;
        font-weight: bold;
        color: #333;
    }
    .current-btn {
        background: #4CAF50 !important;
        color: white !important;
        border: none;
        cursor: pointer;
        font-weight: bold;
    }
    .search-btn:hover, .current-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .place-item {
        border-bottom: 1px solid #eee;
        padding: 15px;
        cursor: pointer;
        border-radius: 6px;
        margin-bottom: 5px;
    }
    .place-item:hover {
        background: #f0f8ff;
    }
    .place-name {
        font-weight: 600;
        font-size: 15px;
        color: #2c3e50;
    }
    .place-addr {
        font-size: 13px;
        color: #7f8c8d;
        margin-top: 4px;
    }
    .place-dist {
        color: #e74c3c;
        font-weight: bold;
        font-size: 13px;
        margin-top: 4px;
    }
    .loading { 
        text-align: center; 
        color: #666; 
        padding: 40px; 
        font-size: 16px;
    }
</style>

</head>

<body>
  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="header-container container-fluid container-xl position-relative d-flex align-items-center justify-content-between">
      
      <!-- Logo -->
      <a href="/" class="logo d-flex align-items-center me-auto me-xl-0">
        <h1 class="sitename">WALKorea</h1>
      </a>

      <!-- Navigation Menu -->
      <nav id="navmenu" class="navmenu">
        <ul>
          <li class="dropdown">
            <a href="/"><span>ì—¬í–‰ì •ë³´</span> <i class="bi bi-chevron-down toggle-dropdown"></i></a>
            <ul>
              <li><a href="/places/list?contenttypeid=12&page=1&sort=updated">ê´€ê´‘ì§€</a></li>
              <li><a href="/places/list?contenttypeid=14&page=1&sort=updated">ë¬¸í™”ì‹œì„¤</a></li>
              <li><a href="/places/list?contenttypeid=15&page=1&sort=updated">ì¶•ì œ</a></li>
              <li><a href="/places/list?contenttypeid=32&page=1&sort=updated">ìˆ™ë°•</a></li>
              <li><a href="/places/list?contenttypeid=39&page=1&sort=updated">ìŒì‹ì </a></li>
              <li><a href="/places/list?contenttypeid=38&page=1&sort=updated">ì‡¼í•‘</a></li>
              <li><a href="/places/list?contenttypeid=28&page=1&sort=updated">ë ˆí¬ì¸ </a></li>
            </ul>
          </li>
          <li><a href="/places/map_more">ì§€ë„</a></li>
          <li><a href="/mypage_calendar">ë§ˆì´í˜ì´ì§€</a></li>
        </ul>
      </nav>

      <!-- ë¹„ë¡œê·¸ì¸: ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì ìš©) -->
      <div id="nav-guest" class="d-flex align-items-center gap-2">
        <a class="btn-getstarted" href="/signup">íšŒì›ê°€ì…</a>
        <a class="btn-getstarted" href="/login">ë¡œê·¸ì¸</a>
      </div>

      <!-- ë¡œê·¸ì¸: ì•Œë¦¼/ë‹‰ë„¤ì„/ë¡œê·¸ì•„ì›ƒ (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì ìš©) -->
      <div id="nav-user" class="d-none d-flex align-items-center gap-3">

        <!-- ì•Œë¦¼ ë²„íŠ¼ (ì‘ê²Œ) -->
        <div class="dropdown">
          <button id="notifDropdown"
                  class="btn btn-outline-success btn-sm position-relative px-2 py-1 dropdown-toggle"
                  type="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false">
            <i class="bi bi-bell"></i>
            <span id="notif-badge"
                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none small">
              0
            </span>
          </button>

          <div class="dropdown-menu dropdown-menu-end notif-dropdown">
            <div class="notif-header d-flex justify-content-between align-items-center">
              <span class="fw-semibold">ì•Œë¦¼</span>
              <button id="notif-clear-all" class="btn btn-link btn-sm text-danger p-0">ì „ì²´ì‚­ì œ</button>
            </div>
            <div class="notif-body">
              <p id="notif-empty-text" class="notif-empty text-muted small mb-2">
                ì•„ì§ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.
              </p>
              <ul id="notif-list" class="notif-list list-unstyled mb-0"></ul>
            </div>
          </div>
        </div>

        <!-- ë‹‰ë„¤ì„ + ë¼ë²¨ -->
        <div class="d-flex align-items-center gap-2">
          <div id="header-initial"
              class="mypage-user-badge"
              style="width:32px; height:32px; font-size:16px; margin-right:0;">
            ë‹‰ë„¤ì„
          </div>
          <span id="header-nickname" class="fw-semibold"></span>
        </div>

        <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼: ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš© -->
        <button id="nav-logout" class="btn-getstarted btn-logout-small">
          ë¡œê·¸ì•„ì›ƒ
        </button>
      </div>
    </div>
  </header>
  <!-- ëª©ë¡ ë -->

   <main>
        <div class="main">
            <div id="map"></div>
            <div class="sidebar">
                <div class="search-box">
                    <input type="text" id="keyword" placeholder="ğŸ” ê´€ê´‘ì§€ ì´ë¦„ ê²€ìƒ‰ (ì˜ˆ: ê²½ë³µê¶)">
                    <button class="search-btn" id="searchBtn">ê²€ìƒ‰</button>
                    <button class="current-btn" id="currentBtn" onclick="showNearbyPlaces()">ğŸ“ í˜„ì¬ ìœ„ì¹˜ 3km ê´€ê´‘ì§€ ì°¾ê¸°</button>

                </div>
                <div id="placeList">
                    <div class="loading">ì§€ë„ì™€ ê´€ê´‘ì§€ ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>
    </main>

  <footer id="footer" class="footer position-relative">


    <div class="footer-bottom">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-6">
            <div class="copyright">
              <p>Â© <span>WALKorea</span></p>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="footer-bottom-links">
              <a href="#">ê°œë°œì ê¹€í˜œì˜</a>
              <a href="#">ê°œë°œì ì´ì§€ì˜</a>
            </div>
            <div class="credits">
            </div>
          </div>
        </div>
      </div>
    </div>

  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="assets/vendor/drift-zoom/Drift.min.js"></script>

  <!-- Main JS File -->
  <script src="assets/js/main.js"></script>
  <script type="module">
  import { initHeader } from "/assets/js/header.js";
  window.addEventListener("DOMContentLoaded", async () => {
    await initHeader();                 
  });
</script>

  <!-- ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
(() => {
    let map, clusterer, markers = [], userLocation = null;
    const placesData = {{ places | tojson | safe }};
    let openInfoWindow = null;  // â­ ëª¨ë“  ì¸í¬ìœˆë„ìš°ë¥¼ ë‹¨ì¼ ê´€ë¦¬

    console.log('ğŸ“ ê´€ê´‘ì§€ ë°ì´í„° ë¡œë“œ:', placesData.length, 'ê°œ');

    function getDistance(lat1, lng1, lat2, lng2) {
        function deg2rad(deg) { return deg * (Math.PI / 180); }
        const R = 6371;
        const dLat = deg2rad(lat2 - lat1);
        const dLng = deg2rad(lng2 - lng1);
        const a =
            Math.sin(dLat / 2) ** 2 +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
            Math.sin(dLng / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    /** ëª¨ë“  ì¸í¬ìœˆë„ìš° ë‹«ê¸° */
    function closeOpenInfoWindow() {
        if (openInfoWindow) {
            openInfoWindow.close();
            openInfoWindow = null;
        }
    }

    /** ì§€ë„ ì´ˆê¸°í™” */
    function initMap() {
        map = new kakao.maps.Map(document.getElementById('map'), {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 7
        });

        clusterer = new kakao.maps.MarkerClusterer({
            map: map,
            averageCenter: true,
            minLevel: 8
        });

        // â­ ì§€ë„ í´ë¦­ ì‹œ ì¸í¬ìœˆë„ìš° ë‹«ê¸°
        kakao.maps.event.addListener(map, 'click', closeOpenInfoWindow);

        document.getElementById('placeList').innerHTML =
            '<div class="loading">ê²€ìƒ‰í•˜ê±°ë‚˜ "í˜„ì¬ ìœ„ì¹˜ 3km ê´€ê´‘ì§€ ì°¾ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>';

        requestCurrentLocation();
    }

    /** í˜„ì¬ ìœ„ì¹˜ ìš”ì²­ */
    function requestCurrentLocation() {
        if (!navigator.geolocation) return;

        navigator.geolocation.getCurrentPosition(
            success => {
                userLocation = new kakao.maps.LatLng(
                    success.coords.latitude,
                    success.coords.longitude
                );

                map.setCenter(userLocation);
                map.setLevel(7);

                const imgSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";
                const imgSize = new kakao.maps.Size(24, 35);
                const imgOption = { offset: new kakao.maps.Point(12, 35) };

                const markerImg = new kakao.maps.MarkerImage(imgSrc, imgSize, imgOption);

                const userMarker = new kakao.maps.Marker({
                    position: userLocation,
                    map: map,
                    image: markerImg,
                    zIndex: 1000
                });

                const info = new kakao.maps.InfoWindow({
                    content: `
                        <div style="padding:16px; background:#FFF8E1; border-radius:8px;">
                            <h6 style="margin:0; color:#D84315;">ğŸ“ í˜„ì¬ ìœ„ì¹˜</h6>
                        </div>`
                });

                // â­ ì‚¬ìš©ì ìœ„ì¹˜ë„ ë™ì¼í•œ ê·œì¹™ ì ìš©
                let open = false;
                kakao.maps.event.addListener(userMarker, 'click', () => {
                    closeOpenInfoWindow();

                    if (!open) {
                        info.open(map, userMarker);
                        openInfoWindow = info;
                    }
                    open = !open;
                });

                console.log("ğŸ“ ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ");
            },
            err => console.log("ìœ„ì¹˜ ì˜¤ë¥˜:", err),
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    /** -----------------------------
     *  ë§ˆì»¤ + ëª©ë¡ ìƒì„± í•¨ìˆ˜
     * ----------------------------- */
    function createNearbyMarkers(places, title) {
        clusterer.clear();
        markers = [];

        const placeList = document.getElementById('placeList');

        if (!places || places.length === 0) {
            placeList.innerHTML = `
                <div class="loading" style="padding:40px; text-align:center;">
                    <h4 style="color:#e74c3c;">${title}</h4>
                    <p>ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>`;
            return;
        }

        const bounds = new kakao.maps.LatLngBounds();
        if (userLocation) bounds.extend(userLocation);

        places.forEach((p) => {
            if (!p.mapy || !p.mapx) return;

            const pos = new kakao.maps.LatLng(p.mapy, p.mapx);
            bounds.extend(pos);

            const marker = new kakao.maps.Marker({
                position: pos,
                map: map,
                title: p.title
            });

            const iw = new kakao.maps.InfoWindow({
                content: `
                    <div style="padding:12px; background:white; border-radius:8px;">
                        <h6 style="margin:0 0 5px 0;">${p.title}</h6>
                        <p style="margin:0; font-size:12px; color:#666;">${p.addr1 || ''}</p>
                    </div>`
            });

            // â­ ë§ˆì»¤ í´ë¦­ ì‹œ ë‹¨ì¼ openInfoWindow ê´€ë¦¬
            kakao.maps.event.addListener(marker, 'click', () => {
                if (openInfoWindow === iw) {
                    iw.close();
                    openInfoWindow = null;
                    return;
                }

                closeOpenInfoWindow();
                iw.open(map, marker);
                openInfoWindow = iw;
            });

            markers.push(marker);
        });

        clusterer.addMarkers(markers);
        map.setBounds(bounds);

        updatePlaceList(places, title);
    }

    /** í˜„ì¬ ìœ„ì¹˜ 3km ê´€ê´‘ì§€ */
    window.showNearbyPlaces = function () {
        if (!userLocation) {
            alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ë¨¼ì € í™•ì¸í•´ì£¼ì„¸ìš”!");
            return;
        }

        const ulat = userLocation.getLat();
        const ulng = userLocation.getLng();

        const nearbyPlaces = placesData.filter(p => {
            if (!p.mapy || !p.mapx) return false;
            const dist = getDistance(ulat, ulng, p.mapy, p.mapx);
            return dist <= 3;
        });

        const sorted = nearbyPlaces.sort((a, b) =>
            a.title.localeCompare(b.title)
        );

        createNearbyMarkers(sorted, `ğŸ“ í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ 3km ê´€ê´‘ì§€`);
    };

    /** ëª©ë¡ ì—…ë°ì´íŠ¸ */
    function updatePlaceList(places, title) {
        const placeList = document.getElementById('placeList');
        if (!places.length) {
            placeList.innerHTML = '<div class="loading">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        let html = `<h4 style="color:#2c3e50; margin-bottom:15px;">${title} (${places.length}ê°œ)</h4>`;

        places.slice(0, 20).forEach(place => {
            html += `
            <div class="place-item" 
                onclick="moveToPlace(${place.mapy}, ${place.mapx}, '${place.title.replace(/'/g, "\\'")}', '${(place.addr1 || '').replace(/'/g, "\\'")}', '${place.contentid || ''}')">
                <div class="place-name">${place.title}</div>
                <div class="place-addr">${place.addr1 || 'ì£¼ì†Œì •ë³´ ì—†ìŒ'}</div>
            </div>`;
        });

        placeList.innerHTML = html;
    }

    /** ìƒì„¸ë³´ê¸° í´ë¦­ â†’ ì§€ë„ ì´ë™ */
    window.moveToPlace = (lat, lng, title, addr, contentid) => {
        closeOpenInfoWindow();

        const pos = new kakao.maps.LatLng(lat, lng);
        map.setCenter(pos);
        map.setLevel(7);

        const marker = new kakao.maps.Marker({ position: pos, map: map });

        const iw = new kakao.maps.InfoWindow({
            content: `
                <div style="padding:12px; background:white; border-radius:8px;">
                    <h6 style="margin:0;">${title}</h6>
                    <p style="margin:5px 0; font-size:12px;">${addr}</p>
                    ${contentid ? `<a href="/places/detail/${contentid}" style="font-size:11px; color:#007bff;">ìƒì„¸ë³´ê¸°</a>` : ''}
                </div>`
        });

        iw.open(map, marker);
        openInfoWindow = iw;
    };

    /** ê²€ìƒ‰ */
    window.searchPlaces = function (keyword) {
        if (!keyword.trim()) {
            alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        const key = keyword.toLowerCase();
        const filtered = placesData.filter(p =>
            (p.title && p.title.toLowerCase().includes(key)) ||
            (p.addr1 && p.addr1.toLowerCase().includes(key))
        );

        createNearbyMarkers(filtered, `ğŸ” "${keyword}" ê²€ìƒ‰ê²°ê³¼`);
    };

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('searchBtn').onclick = () => {
            const keyword = document.getElementById('keyword').value.trim();
            window.searchPlaces(keyword);
        };

        document.getElementById('keyword').addEventListener('keypress', e => {
            if (e.key === 'Enter') document.getElementById('searchBtn').click();
        });
    });

    kakao.maps.load(initMap);
})();
</script>
















  

</body>

</html>
