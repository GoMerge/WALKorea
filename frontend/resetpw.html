<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>비밀번호 찾기 | WALKorea</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-5">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3 class="mb-4 text-center">비밀번호 찾기</h3>

          <!-- 1단계: 아이디 + 이메일로 재설정 코드 요청 -->
          <form id="request-form" class="mb-4">
            <div class="mb-3">
              <label class="form-label">아이디</label>
              <input type="text" class="form-control" name="userid" required>
            </div>
            <div class="mb-3">
              <label class="form-label">가입 이메일</label>
              <input type="email" class="form-control" name="email" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">인증코드 받기</button>
          </form>

          <hr class="my-4">

          <!-- 2단계: 이메일로 받은 코드 + 새 비밀번호 설정 -->
          <form id="reset-form" style="display:none;">
            <div class="mb-3">
              <label class="form-label">인증코드</label>
              <input type="text" class="form-control" name="verification_code" required>
            </div>
            <div class="mb-3">
              <label class="form-label">새 비밀번호</label>
              <input type="password" class="form-control" name="new_password" required>
            </div>
            <div class="mb-3">
              <label class="form-label">새 비밀번호 확인</label>
              <input type="password" class="form-control" name="new_password_confirm" required>
            </div>
            <button type="submit" class="btn btn-success w-100">비밀번호 변경</button>
          </form>

          <div class="mt-3 text-center">
            <a href="login.html" class="small">로그인 화면으로 돌아가기</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// 1단계: 비밀번호 재설정 코드 요청
document.getElementById("request-form").addEventListener("submit", async function(e) {
  e.preventDefault();
  const form = e.target;
  const payload = {
    userid: form.userid.value.trim(),
    email: form.email.value.trim()
  };
  if (!payload.userid || !payload.email) {
    alert("아이디와 이메일을 모두 입력하세요.");
    return;
  }
  const res = await fetch("http://127.0.0.1:8000/user/password-reset-request", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });
  if (res.ok) {
    alert("인증코드가 이메일로 전송되었습니다. 메일함을 확인하세요.");
    // 2단계 폼 표시
    document.getElementById("reset-form").style.display = "block";
    // userid/email은 2단계에서도 필요하므로 저장
    document.getElementById("reset-form").dataset.userid = payload.userid;
    document.getElementById("reset-form").dataset.email = payload.email;
  } else {
    const err = await res.json().catch(()=>null);
    alert((err && err.detail) || "비밀번호 재설정 요청에 실패했습니다.");
  }
});

// 2단계: 코드 + 새 비밀번호로 실제 변경
document.getElementById("reset-form").addEventListener("submit", async function(e) {
  e.preventDefault();
  const form = e.target;
  const userid = form.dataset.userid;
  const email = form.dataset.email;
  const code = form.verification_code.value.trim();
  const pw = form.new_password.value;
  const pw2 = form.new_password_confirm.value;

  if (!code || !pw || !pw2) {
    alert("모든 필드를 입력해주세요.");
    return;
  }
  if (pw !== pw2) {
    alert("새 비밀번호와 확인이 일치하지 않습니다.");
    return;
  }

  const payload = {
    userid: userid,
    email: email,
    verification_code: code,
    new_password: pw
  };

  const res = await fetch("http://127.0.0.1:8000/user/password-reset-confirm", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });

  if (res.ok) {
    alert("비밀번호가 성공적으로 변경되었습니다. 새 비밀번호로 로그인해주세요.");
    window.location.href = "login.html";
  } else {
    const err = await res.json().catch(()=>null);
    alert((err && err.detail) || "비밀번호 변경에 실패했습니다.");
  }
});
</script>
</body>
</html>
