<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ë§ˆì´í˜ì´ì§€ | WALKorea</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color:#f5f7fb; }

    .sidebar-fixed {
      width: 260px;
      min-width: 260px;
      max-width: 260px;
      border-right: 1px solid #e5e7eb;
      background-color:#fff;
    }

    /* ì‚¬ì´ë“œë°” ë©”ë‰´ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .sidebar .menu-title {
      font-size:0.85rem;
      font-weight:600;
      color:#6b7280;
      margin-top:1rem;
      margin-bottom:0.25rem;
    }

    .sidebar .nav-link {
      font-size:0.95rem;
      color:#374151;
      padding:0.45rem 0.75rem;
      border-radius:0.35rem;
      margin-bottom:2px;
    }

    .sidebar .nav-link.active {
      background-color:#e0f2fe;
      color:#0369a1;
      font-weight:600;
    }

    .calendar-grid {
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:4px;
      font-size:0.85rem;
    }
    .calendar-day {
      min-height:70px;
      border-radius:4px;
      padding:4px;
      background-color:#fff;
      border:1px solid #e5e7eb;
    }
    .calendar-day.today {
      border:2px solid #16a34a;
    }
    .calendar-day .date-num {
      font-weight:600;
      margin-bottom:4px;
    }
    .weather-box {
      background-color:#fff;
      border-radius:0.75rem;
      padding:0.75rem 0.85rem;
      box-shadow:0 1px 3px rgba(15,23,42,0.08);
      font-size:0.8rem;
    }

    #region-weather-list div {
      line-height:1.4;
    }
  </style>
</head>
<body>
<header class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold text-success" href="index.html">WALKorea</a>
    <ul class="navbar-nav ms-auto gap-2">
      <li class="nav-item"><a class="nav-link" href="recommend.html">ì¶”ì²œ ì—¬í–‰ì§€</a></li>
      <li class="nav-item"><a class="nav-link" href="calendar.html">ì—¬í–‰ ìº˜ë¦°ë”</a></li>
      <li class="nav-item"><a class="nav-link" href="mypage_calendar.html">ë§ˆì´í˜ì´ì§€</a></li>
      <!-- ì•Œë¦¼ ì•„ì´ì½˜ -->
      <li class="nav-item position-relative">
        <button id="notif-btn" class="btn btn-link nav-link p-0 position-relative">
          <span class="fs-5">ğŸ””</span>
          <span id="notif-badge"
                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
          </span>
        </button>

        <!-- ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ íŒ¨ë„ -->
        <div id="notif-panel"
             class="card shadow-sm position-absolute end-0 mt-2 d-none"
             style="width:260px; z-index:1050;">
          <div class="card-header py-2 px-3 d-flex justify-content-between align-items-center">
            <span class="small fw-semibold">ì•Œë¦¼</span>
            <button id="notif-close" class="btn btn-sm btn-outline-secondary py-0 px-1">Ã—</button>
          </div>
          <ul id="notif-list" class="list-group list-group-flush small"></ul>
        </div>
      </li>
      <li class="nav-item" id="nav-login"><a class="btn btn-success" href="login.html">ë¡œê·¸ì¸</a></li>
      <li class="nav-item" id="nav-signup"><a class="btn btn-primary" href="signup.html">íšŒì›ê°€ì…</a></li>
    </ul>
  </div>
</header>

<main class="container-fluid" style="margin-top:10px;">
  <div class="d-flex">
    <!-- ì™¼ìª½: ë§ˆì´í˜ì´ì§€ ì¹´í…Œê³ ë¦¬ -->
    <aside class="sidebar-fixed sidebar p-3">
      <div class="d-flex align-items-center mb-3">
        <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center"
            style="width:40px;height:40px;">
          <span id="side-initial">W</span>
        </div>
        <div class="ms-2">
          <div class="fw-semibold" id="side-nickname">ë¡œê·¸ì¸ ì‚¬ìš©ì</div>
          <div class="text-muted small" id="side-email">-</div>
        </div>
      </div>

      <div class="weather-box mb-3" id="weather-box">
        <div class="fw-semibold mb-1" id="region-weather-title">ë™ë„¤ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”</div>
        <div class="small text-muted mb-2" id="region-weather-desc">
          ë§ˆì´í˜ì´ì§€ &gt; í”„ë¡œí•„ ìˆ˜ì •ì—ì„œ ì§€ì—­ì„ ì„¤ì •í•˜ë©´, ì´ê³³ì— 6ì¼ê°„ì˜ ë‚ ì”¨ë¥¼ ë³´ì—¬ì¤„ê²Œìš”.
        </div>
        <div id="region-weather-list"></div>
        <a class="btn btn-outline-success btn-sm mt-2 w-100" href="mypage_profile.html">
          ì§€ì—­ ì„¤ì •í•˜ëŸ¬ ê°€ê¸°
        </a>
      </div>

      <div class="menu-title">ë§ˆì´í˜ì´ì§€</div>
      <nav class="nav flex-column">
        <a href="mypage_calendar.html"  class="nav-link">ë‚´ ì¼ì •</a>
        <a href="mypage_friends.html"   class="nav-link">ì¹œêµ¬ ê´€ë¦¬</a>
        <a href="mypage_recommend.html" class="nav-link active">ë§ì¶¤ ê´€ê´‘</a>
        <a href="mypage_profile.html"   class="nav-link">í”„ë¡œí•„ ìˆ˜ì •</a>
        <a href="mypage_favorites.html" class="nav-link">ì¢‹ì•„ìš” í•œ ì—¬í–‰ì§€</a>
      </nav>
    </aside>

    <!-- ì˜¤ë¥¸ìª½: ë§ì¶¤ ê´€ê´‘ ì„¤ì • -->
    <section class="col-md-9 col-lg-10 p-4">
      <div class="profile-card mb-4 d-flex align-items-center gap-3">
        <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center" style="width:64px;height:64px;font-size:1.5rem;">
          <span id="profile-initial">W</span>
        </div>
        <div>
          <div class="fw-bold fs-5" id="profile-nickname">ë¡œê·¸ì¸ ì‚¬ìš©ì</div>
          <div class="text-muted small" id="profile-email">-</div>
          <div class="text-muted small">
            ë‚˜ì˜ ì—¬í–‰ ì·¨í–¥ì„ ì„¤ì •í•˜ë©´, ì¶”ì²œ ì—¬í–‰ì§€ì™€ ì¼ì •ì— ë°˜ì˜ë©ë‹ˆë‹¤.
          </div>
        </div>
      </div>

      <h4 class="fw-bold mb-3">ë§ì¶¤ ê´€ê´‘ ì„¤ì •</h4>
      <p class="text-muted small mb-1">
        ì•„ë˜ í•­ëª©ì„ ì„ íƒí•˜ë©´ WALKoreaê°€ ì·¨í–¥ì— ë§ëŠ” ì—¬í–‰ì§€ë¥¼ ì¶”ì²œí•´ ì¤„ê²Œìš”.
      </p>
      <p id="pref-summary" class="text-success small mb-3" style="display:none;"></p>

      <form id="pref-form" style="max-width:720px;">
        <h6 class="fw-bold mt-4 mb-2">1. ê¸°ë³¸ ì •ë³´</h6>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">ì—°ë ¹ëŒ€</label>
            <select class="form-select" id="age_group">
              <option value="">ì„ íƒ</option>
              <option value="10ëŒ€">10ëŒ€</option>
              <option value="20ëŒ€">20ëŒ€</option>
              <option value="30ëŒ€">30ëŒ€</option>
              <option value="40ëŒ€">40ëŒ€</option>
              <option value="50ëŒ€ ì´ìƒ">50ëŒ€ ì´ìƒ</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">ì„±ë³„</label>
            <select class="form-select" id="pref_gender">
              <option value="">ì„ íƒ</option>
              <option value="M">ë‚¨ì„±</option>
              <option value="F">ì—¬ì„±</option>
              <option value="O">ê¸°íƒ€/ì„ íƒ ì•ˆ í•¨</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">ì—¬í–‰ ìŠ¤íƒ€ì¼</label>
            <select class="form-select" id="travel_style">
              <option value="">ì„ íƒ</option>
              <option value="ê³„íší˜•">ê³„íší˜•</option>
              <option value="ììœ í˜•">ììœ í˜•</option>
            </select>
          </div>
        </div>

        <h6 class="fw-bold mt-4 mb-2">2. ì—¬í–‰ ì·¨í–¥</h6>
        <div class="mt-3">
          <label class="form-label d-block">í•¨ê»˜ ê°€ëŠ” ì‚¬ëŒ</label>

          <input type="checkbox" class="btn-check" id="with-alone" autocomplete="off" value="í˜¼ì">
          <label class="btn btn-outline-secondary btn-sm me-1 mb-1" for="with-alone">í˜¼ì</label>

          <input type="checkbox" class="btn-check" id="with-friend" autocomplete="off" value="ì¹œêµ¬">
          <label class="btn btn-outline-secondary btn-sm me-1 mb-1" for="with-friend">ì¹œêµ¬</label>

          <input type="checkbox" class="btn-check" id="with-family" autocomplete="off" value="ê°€ì¡±">
          <label class="btn btn-outline-secondary btn-sm me-1 mb-1" for="with-family">ê°€ì¡±</label>

          <input type="checkbox" class="btn-check" id="with-couple" autocomplete="off" value="ì»¤í”Œ">
          <label class="btn btn-outline-secondary btn-sm me-1 mb-1" for="with-couple">ì»¤í”Œ</label>
        </div>

        <div class="mt-3">
          <label class="form-label">ì„ í˜¸ ì§€ì—­/í…Œë§ˆ</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" value="ë°”ë‹¤" id="theme-sea">
            <label class="form-check-label" for="theme-sea">ë°”ë‹¤</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" value="ì‚°" id="theme-mountain">
            <label class="form-check-label" for="theme-mountain">ì‚°</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" value="ë„ì‹œ" id="theme-city">
            <label class="form-check-label" for="theme-city">ë„ì‹œ</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" value="ìì—°" id="theme-nature">
            <label class="form-check-label" for="theme-nature">ìì—°</label>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label">í™œë™ íƒ€ì…</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" value="ë¬¸í™”ì²´í—˜" id="act-culture">
            <label class="form-check-label" for="act-culture">ë¬¸í™”ì²´í—˜</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" value="ë§›ì§‘" id="act-food">
            <label class="form-check-label" for="act-food">ë§›ì§‘</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" value="íœ´ì‹" id="act-rest">
            <label class="form-check-label" for="act-rest">íœ´ì‹</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" value="ê´€ê´‘ëª…ì†Œ" id="act-spot">
            <label class="form-check-label" for="act-spot">ê´€ê´‘ëª…ì†Œ</label>
          </div>
        </div>

        <h6 class="fw-bold mt-4 mb-2">3. ì„¸ë¶€ ì„ í˜¸</h6>

        <div class="row g-3 mt-1">
          <div class="col-md-4">
            <label class="form-label">ì‚¬ì§„ ì°ê¸°</label>
            <select class="form-select" id="photo_likes">
              <option value="">ì„ íƒ</option>
              <option value="ë§ì´ ì°ëŠ” í¸">ë§ì´ ì°ëŠ” í¸</option>
              <option value="ë³´í†µ">ë³´í†µ</option>
              <option value="ê±°ì˜ ì•ˆ ì°ìŒ">ê±°ì˜ ì•ˆ ì°ìŒ</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">ì„ í˜¸ ë¶„ìœ„ê¸°</label>
            <select class="form-select" id="vibe">
              <option value="">ì„ íƒ</option>
              <option value="ì¡°ìš©í•œ ê³³">ì¡°ìš©í•œ ê³³</option>
              <option value="ì ë‹¹íˆ ë¶ì ì´ëŠ” ê³³">ì ë‹¹íˆ ë¶ì ì´ëŠ” ê³³</option>
              <option value="í™œê¸°ì°¬ ê³³">í™œê¸°ì°¬ ê³³</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">í™œë™ ì‹œê°„ëŒ€</label>
            <select class="form-select" id="night_activity">
              <option value="">ì„ íƒ</option>
              <option value="ë‚®í™œë™">ì£¼ë¡œ ë‚® í™œë™</option>
              <option value="ë°¤í™œë™">ë°¤ í™œë™ ì„ í˜¸</option>
            </select>
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-md-4">
            <label class="form-label">1ì¸ë‹¹ ì˜ˆì‚°</label>
            <select class="form-select" id="budget_level">
              <option value="">ì„ íƒ</option>
              <option value="low">10ë§Œì› ì´í•˜</option>
              <option value="mid">10~30ë§Œì›</option>
              <option value="high">30ë§Œì› ì´ìƒ</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">í™œë™ ê°•ë„</label>
            <select class="form-select" id="activity_level">
              <option value="">ì„ íƒ</option>
              <option value="light">ê°€ë²¼ìš´ ì‚°ì±… ìœ„ì£¼</option>
              <option value="normal">ë°˜ë‚˜ì ˆ ì •ë„</option>
              <option value="hard">ì¢…ì¼ ë¹¡ì„¸ê²Œ</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">í˜¼ì¡ë„ ì„ í˜¸</label>
            <select class="form-select" id="crowd_level">
              <option value="">ì„ íƒ</option>
              <option value="any">ìƒê´€ ì—†ìŒ</option>
              <option value="moderate">ì ë‹¹íˆ ë¶ì </option>
              <option value="quiet">í•œì í•œ ê³³ ì„ í˜¸</option>
            </select>
          </div>
        </div>
        <div class="mt-3">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="sns_like">
            <label class="form-check-label" for="sns_like">SNSì— ì˜¬ë¦¬ê¸° ì¢‹ì€ ìŠ¤íŒŸ ì„ í˜¸</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="avoid_crowd">
            <label class="form-check-label" for="avoid_crowd">ì‚¬ëŒ ë§ì€ ê³³ì€ í”¼í•˜ê³  ì‹¶ì–´ìš”</label>
          </div>
        </div>
        <div class="mt-4">
          <button type="submit" class="btn btn-success">ì„¤ì • ì €ì¥</button>
        </div>
      </form>
    </section>
  </div>
</main>

<script>
const token = localStorage.getItem("access_token");

function formatKoreanWeekday(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  const names = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
  return names[d.getDay()];
}

async function loadProfileWeather() {
  if (!token) return;

  try {
    const res = await fetch("http://127.0.0.1:8000/weather/profile/current", {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) return;
    const data = await res.json();   // { region_name, days: [...] }

    const box      = document.getElementById("weather-box");
    const boxTitle = document.getElementById("region-weather-title");
    const boxDesc  = document.getElementById("region-weather-desc");
    const listBox  = document.getElementById("region-weather-list");
    if (!data.days || !boxTitle || !boxDesc || !listBox || !box) return;

    boxTitle.textContent = `${data.region_name}ì˜ 6ì¼ê°„ ë‚ ì”¨`;
    boxDesc.textContent  = "ì˜¤ëŠ˜ì„ í¬í•¨í•œ 6ì¼ì¹˜ ë™ë„¤ ë‚ ì”¨ì˜ˆìš”.";
    listBox.innerHTML = "";

    data.days.forEach((d, idx) => {
      const div = document.createElement("div");
      div.className = "d-flex align-items-center small mb-1";

      const weekday = formatKoreanWeekday(d.date);
      const label   = idx === 0 ? "ì˜¤ëŠ˜" : weekday;

      const temp = d.temp;
      const tmax = d.temp_max;
      const tmin = d.temp_min;

      const tempPart = (tmax != null && tmin != null)
        ? `${tmax.toFixed(0)}Â° / ${tmin.toFixed(0)}Â°`
        : (temp != null ? `${temp.toFixed(0)}Â°` : "-Â°");

      const iconEmoji = mapIconToEmoji(d.icon);
      const desc = d.desc || "";

      div.innerHTML = `
        <span class="text-muted" style="width:32px;">${label}</span>
        <span style="width:32px; text-align:center;">${iconEmoji}</span>
        <span class="fw-semibold" style="width:80px; text-align:right;">${tempPart}</span>
        <span class="text-muted" style="flex:1; text-align:left; margin-left:8px;">
          ${desc}
        </span>
      `;
      listBox.appendChild(div);
    });
  } catch (e) {
    console.error("profile weather error", e);
  }
}


function mapIconToEmoji(icon) {
  switch (icon) {
    case "rain": return "ğŸŒ§ï¸";
    case "snow": return "â„ï¸";
    case "fog": return "ğŸŒ«ï¸";
    case "wind": return "ğŸ’¨";
    case "cloudy": return "â˜ï¸";
    case "partly-cloudy-day": return "â›…";
    case "partly-cloudy-night": return "â˜ï¸";
    case "clear-day": return "â˜€ï¸";
    case "clear-night": return "ğŸŒ™";
    default: return "ğŸŒ¤ï¸";
  }
}

async function loadPreferences() {
  const token = localStorage.getItem("access_token");
  if (!token) return;

  const res = await fetch("http://127.0.0.1:8000/user/profile/preferences", {
    headers: { "Authorization": "Bearer " + token }
  });
  if (!res.ok) return;
  const data = await res.json();
  const pref = data.preference;
  if (!pref) return;

  // ë‹¨ì¼ ê°’ selectë“¤
  document.getElementById("age_group").value       = pref.age_group       || "";
  document.getElementById("pref_gender").value     = pref.gender          || "";
  document.getElementById("travel_style").value    = pref.travel_style    || "";
  document.getElementById("photo_likes").value     = pref.photo_likes     || "";
  document.getElementById("vibe").value            = pref.vibe            || "";
  document.getElementById("night_activity").value  = pref.night_activity  || "";
  document.getElementById("budget_level").value    = pref.budget_level    || "";
  document.getElementById("activity_level").value  = pref.activity_level  || "";
  document.getElementById("crowd_level").value     = pref.crowd_level     || "";

  // ì²´í¬ë°•ìŠ¤: ë°°ì—´ ê¸°ì¤€ìœ¼ë¡œ ì±„ìš°ê¸°
  const travelWith   = pref.travel_with   || [];
  const areaTheme    = pref.area_theme    || [];
  const activityType = pref.activity_type || [];

  document.getElementById("with-alone").checked   = travelWith.includes("í˜¼ì");
  document.getElementById("with-friend").checked  = travelWith.includes("ì¹œêµ¬");
  document.getElementById("with-family").checked  = travelWith.includes("ê°€ì¡±");
  document.getElementById("with-couple").checked  = travelWith.includes("ì»¤í”Œ");

  document.getElementById("theme-sea").checked      = areaTheme.includes("ë°”ë‹¤");
  document.getElementById("theme-mountain").checked = areaTheme.includes("ì‚°");
  document.getElementById("theme-city").checked     = areaTheme.includes("ë„ì‹œ");
  document.getElementById("theme-nature").checked   = areaTheme.includes("ìì—°");

  document.getElementById("act-culture").checked = activityType.includes("ë¬¸í™”ì²´í—˜");
  document.getElementById("act-food").checked    = activityType.includes("ë§›ì§‘");
  document.getElementById("act-rest").checked    = activityType.includes("íœ´ì‹");
  document.getElementById("act-spot").checked    = activityType.includes("ê´€ê´‘ëª…ì†Œ");

  document.getElementById("sns_like").checked    = !!pref.sns_like;
  document.getElementById("avoid_crowd").checked = !!pref.avoid_crowd;
}


// ê³µí†µ: í—¤ë”/ì‚¬ì´ë“œë°” í”„ë¡œí•„ ì„¸íŒ…
async function setupHeaderAndProfile() {
  const nav = document.querySelector(".navbar-nav");
  const loginLi = document.getElementById("nav-login");
  const signupLi = document.getElementById("nav-signup");
  if (token && nav) {
    if (loginLi) loginLi.remove();
    if (signupLi) signupLi.remove();
    const logoutLi = document.createElement("li");
    logoutLi.className = "nav-item";
    logoutLi.innerHTML = `<a class="btn btn-outline-danger" href="#">ë¡œê·¸ì•„ì›ƒ</a>`;
    logoutLi.querySelector("a").onclick = (e) => {
      e.preventDefault();
      localStorage.removeItem("access_token");
      localStorage.removeItem("refresh_token");
      window.location.href = "index.html";
    };
    nav.appendChild(logoutLi);
  }
  if (!token) return;

  const res = await fetch("http://127.0.0.1:8000/user/profile", {
    headers: { "Authorization": "Bearer " + token }
  });
  if (!res.ok) return;
  const user = await res.json();

  const nick = user.nickname || (user.name || "ì‚¬ìš©ì");
  const email = user.email || "";

  const sideNick = document.getElementById("side-nickname");
  const profNick = document.getElementById("profile-nickname");
  if (sideNick) sideNick.textContent = nick;
  if (profNick) profNick.textContent = nick;

  const sideEmail = document.getElementById("side-email");
  const profEmail = document.getElementById("profile-email");
  if (sideEmail) sideEmail.textContent = email;
  if (profEmail) profEmail.textContent = email;

  const sideInit = document.getElementById("side-initial");
  const profInit = document.getElementById("profile-initial");
  if (sideInit) sideInit.textContent = nick[0];
  if (profInit) profInit.textContent = nick[0];
}

// ì·¨í–¥ ì„¤ì • ì €ì¥
async function savePreferences(e) {
  e.preventDefault();
  if (!token) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    window.location.href = "login.html";
    return;
  }

  const travelWith = [];
  if (document.getElementById("with-alone").checked)  travelWith.push("í˜¼ì");
  if (document.getElementById("with-friend").checked) travelWith.push("ì¹œêµ¬");
  if (document.getElementById("with-family").checked) travelWith.push("ê°€ì¡±");
  if (document.getElementById("with-couple").checked) travelWith.push("ì»¤í”Œ");

  const areaTheme = [];
  if (document.getElementById("theme-sea").checked)      areaTheme.push("ë°”ë‹¤");
  if (document.getElementById("theme-mountain").checked) areaTheme.push("ì‚°");
  if (document.getElementById("theme-city").checked)     areaTheme.push("ë„ì‹œ");
  if (document.getElementById("theme-nature").checked)   areaTheme.push("ìì—°");

  const activityType = [];
  if (document.getElementById("act-culture").checked) activityType.push("ë¬¸í™”ì²´í—˜");
  if (document.getElementById("act-food").checked)    activityType.push("ë§›ì§‘");
  if (document.getElementById("act-rest").checked)    activityType.push("íœ´ì‹");
  if (document.getElementById("act-spot").checked)    activityType.push("ê´€ê´‘ëª…ì†Œ");

  const payload = {
    preference: {
      age_group: document.getElementById("age_group").value || "ì•Œ ìˆ˜ ì—†ìŒ",
      gender: document.getElementById("pref_gender").value || "ì•Œ ìˆ˜ ì—†ìŒ",
      travel_with: travelWith,
      travel_style: document.getElementById("travel_style").value || "ê³„íší˜•",
      activity_level: document.getElementById("activity_level").value || "ë³´í†µ",
      area_theme: areaTheme,
      activity_type: activityType,
      photo_likes: document.getElementById("photo_likes").value || "ë³´í†µ",
      vibe: document.getElementById("vibe").value || "ì¡°ìš©í•œ ê³³",
      night_activity: document.getElementById("night_activity").value || "ë‚®í™œë™",
      sns_like: document.getElementById("sns_like").checked,
      avoid_crowd: document.getElementById("avoid_crowd").checked,
      budget_level: document.getElementById("budget_level").value || "mid",
      crowd_level: document.getElementById("crowd_level").value || "moderate",
    }
  };

  const res = await fetch("http://127.0.0.1:8000/user/profile/preferences", {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      "Authorization":"Bearer " + token
    },
    body: JSON.stringify(payload)
  });

  if (res.ok) {
    const summary = document.getElementById("pref-summary");
    if (summary) {
      summary.style.display = "block";
      summary.textContent =
        `ì„¤ì • ì™„ë£Œ: ${document.getElementById("age_group").value || "ì—°ë ¹ ë¯¸ì„¤ì •"}, ` +
        `${travelWith.join(", ") || "í˜¼ì/ë™í–‰ ë¯¸ì„¤ì •"}, ` +
        `${areaTheme.join(", ") || "í…Œë§ˆ ë¯¸ì„¤ì •"} ê¸°ì¤€ìœ¼ë¡œ ì¶”ì²œí•´ ë“œë¦´ê²Œìš”.`;
    }
    alert("ë§ì¶¤ ê´€ê´‘ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }
}

window.addEventListener("DOMContentLoaded", async () => {
  if (!token) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    window.location.href = "login.html";
    return;
  }
  await setupHeaderAndProfile();
  await loadProfileWeather();
  await loadPreferences();
  document.getElementById("pref-form").addEventListener("submit", savePreferences);
});
let notifCount = 0;

async function loadNotifications() {
  const token = localStorage.getItem("access_token");
  if (!token) return;

  try {
    const res = await fetch("http://127.0.0.1:8000/notifications/", {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) return;
    const items = await res.json();   // [{id, type, message, ...}, ...]

    const ul = document.getElementById("notif-list");
    if (!ul) return;
    ul.innerHTML = "";

    items.forEach(n => {
      const li = document.createElement("li");
      li.className = "list-group-item py-2";
      li.textContent = n.message;
      ul.appendChild(li);
    });

    if (items.length > 0) {
      notifCount = items.filter(n => !n.is_read).length || items.length;
      const badge = document.getElementById("notif-badge");
      if (badge) {
        badge.textContent = notifCount;
        badge.classList.toggle("d-none", notifCount === 0);
      }
    }
  } catch (e) {
    console.error("loadNotifications error", e);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("notif-btn");
  const panel = document.getElementById("notif-panel");
  const closeBtn = document.getElementById("notif-close");

  if (!btn || !panel) return;

  btn.addEventListener("click", async () => {
    if (panel.classList.contains("d-none")) {
      await loadNotifications();          // ì—´ ë•Œë§ˆë‹¤ ìµœì‹  ëª©ë¡
      panel.classList.remove("d-none");
      const badge = document.getElementById("notif-badge");
      if (badge) badge.classList.add("d-none");   // ì—´ë©´ ë±ƒì§€ ì´ˆê¸°í™”
    } else {
      panel.classList.add("d-none");
    }
  });

  if (closeBtn) {
    closeBtn.addEventListener("click", () => panel.classList.add("d-none"));
  }
});

</script>
</body>
</html>
