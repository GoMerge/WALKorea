<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ë§ˆì´í˜ì´ì§€ | WALKorea</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color:#f5f7fb; }

    .sidebar-fixed {
      width: 260px;
      min-width: 260px;
      max-width: 260px;
      border-right: 1px solid #e5e7eb;
      background-color:#fff;
    }

    /* ì‚¬ì´ë“œë°” ë©”ë‰´ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .sidebar .menu-title {
      font-size:0.85rem;
      font-weight:600;
      color:#6b7280;
      margin-top:1rem;
      margin-bottom:0.25rem;
    }

    .sidebar .nav-link {
      font-size:0.95rem;
      color:#374151;
      padding:0.45rem 0.75rem;
      border-radius:0.35rem;
      margin-bottom:2px;
    }

    .sidebar .nav-link.active {
      background-color:#e0f2fe;
      color:#0369a1;
      font-weight:600;
    }

    .calendar-grid {
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:4px;
      font-size:0.85rem;
    }
    .calendar-day {
      min-height:70px;
      border-radius:4px;
      padding:4px;
      background-color:#fff;
      border:1px solid #e5e7eb;
    }
    .calendar-day.today {
      border:2px solid #16a34a;
    }
    .calendar-day .date-num {
      font-weight:600;
      margin-bottom:4px;
    }
    .weather-box {
      background-color:#fff;
      border-radius:0.75rem;
      padding:0.75rem 0.85rem;
      box-shadow:0 1px 3px rgba(15,23,42,0.08);
      font-size:0.8rem;
    }

    #region-weather-list div {
      line-height:1.4;
    }
  </style>
</head>
<body>
<header class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold text-success" href="index.html">WALKorea</a>
    <ul class="navbar-nav ms-auto gap-2">
      <li class="nav-item"><a class="nav-link" href="recommend.html">ì¶”ì²œ ì—¬í–‰ì§€</a></li>
      <li class="nav-item"><a class="nav-link" href="calendar.html">ì—¬í–‰ ìº˜ë¦°ë”</a></li>
      <li class="nav-item"><a class="nav-link" href="mypage_calendar.html">ë§ˆì´í˜ì´ì§€</a></li>
      <!-- ì•Œë¦¼ ì•„ì´ì½˜ -->
      <li class="nav-item position-relative">
        <button id="notif-btn" class="btn btn-link nav-link p-0 position-relative">
          <span class="fs-5">ğŸ””</span>
          <span id="notif-badge"
                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
          </span>
        </button>

        <!-- ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ íŒ¨ë„ -->
        <div id="notif-panel"
             class="card shadow-sm position-absolute end-0 mt-2 d-none"
             style="width:260px; z-index:1050;">
          <div class="card-header py-2 px-3 d-flex justify-content-between align-items-center">
            <span class="small fw-semibold">ì•Œë¦¼</span>
            <button id="notif-close" class="btn btn-sm btn-outline-secondary py-0 px-1">Ã—</button>
          </div>
          <ul id="notif-list" class="list-group list-group-flush small"></ul>
        </div>
      </li>
      <li class="nav-item" id="nav-login"><a class="btn btn-success" href="login.html">ë¡œê·¸ì¸</a></li>
      <li class="nav-item" id="nav-signup"><a class="btn btn-primary" href="signup.html">íšŒì›ê°€ì…</a></li>
    </ul>
  </div>
</header>

<main class="container-fluid" style="margin-top:10px;">
  <div class="d-flex">
    <!-- ì™¼ìª½: ë§ˆì´í˜ì´ì§€ ì¹´í…Œê³ ë¦¬ -->
    <aside class="sidebar-fixed sidebar p-3">
      <div class="d-flex align-items-center mb-3">
        <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center"
            style="width:40px;height:40px;">
          <span id="side-initial">W</span>
        </div>
        <div class="ms-2">
          <div class="fw-semibold" id="side-nickname">ë¡œê·¸ì¸ ì‚¬ìš©ì</div>
          <div class="text-muted small" id="side-email">-</div>
        </div>
      </div>

      <div class="weather-box mb-3" id="weather-box">
        <div class="fw-semibold mb-1" id="region-weather-title">ë™ë„¤ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”</div>
        <div class="small text-muted mb-2" id="region-weather-desc">
          ë§ˆì´í˜ì´ì§€ &gt; í”„ë¡œí•„ ìˆ˜ì •ì—ì„œ ì§€ì—­ì„ ì„¤ì •í•˜ë©´, ì´ê³³ì— 6ì¼ê°„ì˜ ë‚ ì”¨ë¥¼ ë³´ì—¬ì¤„ê²Œìš”.
        </div>
        <div id="region-weather-list"></div>
        <a class="btn btn-outline-success btn-sm mt-2 w-100" href="mypage_profile.html">
          ì§€ì—­ ì„¤ì •í•˜ëŸ¬ ê°€ê¸°
        </a>
      </div>

      <div class="menu-title">ë§ˆì´í˜ì´ì§€</div>
      <nav class="nav flex-column">
        <a href="mypage_calendar.html"  class="nav-link">ë‚´ ì¼ì •</a>
        <a href="mypage_friends.html"   class="nav-link active">ì¹œêµ¬ ê´€ë¦¬</a>
        <a href="mypage_recommend.html" class="nav-link">ë§ì¶¤ ê´€ê´‘</a>
        <a href="mypage_profile.html"   class="nav-link">í”„ë¡œí•„ ìˆ˜ì •</a>
      </nav>
    </aside>

    <!-- ì˜¤ë¥¸ìª½: ì¹œêµ¬ ê´€ë¦¬ ì»¨í…ì¸  -->
    <section class="col-md-9 col-lg-10 p-4">
      <div class="profile-card mb-4 d-flex align-items-center gap-3">
        <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center" style="width:64px;height:64px;font-size:1.5rem;">
          <span id="profile-initial">W</span>
        </div>
        <div>
          <div class="fw-bold fs-5" id="profile-nickname">ë¡œê·¸ì¸ ì‚¬ìš©ì</div>
          <div class="text-muted small" id="profile-email">-</div>
          <div class="text-muted small">ì¹œêµ¬ì™€ ì¼ì •ì„ ê³µìœ í•˜ê³ , ì„œë¡œì˜ ì—¬í–‰ ê³„íšì„ í™•ì¸í•´ ë³´ì„¸ìš”.</div>
        </div>
      </div>

      <h4 class="fw-bold mb-3">ì¹œêµ¬ ê´€ë¦¬ (íŒ”ë¡œìš° / íŒ”ë¡œì›Œ)</h4>
      <!-- ì¹œêµ¬ ê²€ìƒ‰ ì˜ì—­ -->
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="input-group input-group-sm">
            <input type="text" id="friend-search-input" class="form-control"
                   placeholder="ë‹‰ë„¤ì„ìœ¼ë¡œ ì¹œêµ¬ ì°¾ê¸°">
            <button class="btn btn-outline-secondary" id="friend-search-btn">ê²€ìƒ‰</button>
          </div>
          <div class="small text-muted mt-1">
            ë‹‰ë„¤ì„ ì¼ë¶€ë§Œ ì…ë ¥í•´ë„ ê²€ìƒ‰ë¼ìš”.
          </div>
        </div>
      </div>

      <div class="row g-3">
        <!-- ê²€ìƒ‰ ê²°ê³¼ -->
        <div class="col-md-6">
          <h6 class="fw-semibold">ê²€ìƒ‰ ê²°ê³¼</h6>
          <ul class="list-group small" id="friend-search-result"></ul>
        </div>

        <!-- íŒ”ë¡œì‰ / íŒ”ë¡œì›Œ -->
        <div class="col-md-3">
          <h6 class="fw-semibold">
            íŒ”ë¡œì‰ <span class="text-muted small" id="following-count">(0)</span>
          </h6>
          <ul class="list-group small" id="following-list"></ul>
        </div>
        <div class="col-md-3">
          <h6 class="fw-semibold">
            íŒ”ë¡œì›Œ <span class="text-muted small" id="follower-count">(0)</span>
          </h6>
          <ul class="list-group small" id="follower-list"></ul>
        </div>
      </div>
    </section>
  </div>
</main>

<script>

let currentUserId = null;
let followingIdSet = new Set();

const token = localStorage.getItem("access_token");

function formatKoreanWeekday(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  const names = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
  return names[d.getDay()];
}

function mapIconToEmoji(icon) {
  switch (icon) {
    case "rain": return "ğŸŒ§ï¸";
    case "snow": return "â„ï¸";
    case "fog": return "ğŸŒ«ï¸";
    case "wind": return "ğŸ’¨";
    case "cloudy": return "â˜ï¸";
    case "partly-cloudy-day": return "â›…";
    case "partly-cloudy-night": return "â˜ï¸";
    case "clear-day": return "â˜€ï¸";
    case "clear-night": return "ğŸŒ™";
    default: return "ğŸŒ¤ï¸";
  }
}

async function loadProfileWeather() {
  if (!token) return;

  try {
    const res = await fetch("http://127.0.0.1:8000/weather/profile/current", {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) return;
    const data = await res.json();   // { region_name, days: [...] }

    const box = document.getElementById("weather-box");
    const boxTitle = document.getElementById("region-weather-title");
    const boxDesc  = document.getElementById("region-weather-desc");
    const listBox  = document.getElementById("region-weather-list");
    if (!data.days || !boxTitle || !boxDesc || !listBox || !box) return;

    boxTitle.textContent = `${data.region_name}ì˜ 6ì¼ê°„ ë‚ ì”¨`;
    boxDesc.textContent  = "ì˜¤ëŠ˜ì„ í¬í•¨í•œ 6ì¼ì¹˜ ë™ë„¤ ë‚ ì”¨ì˜ˆìš”.";
    listBox.innerHTML = "";

    data.days.forEach((d, idx) => {
      const div = document.createElement("div");
      div.className = "d-flex align-items-center small mb-1";

      const weekday = formatKoreanWeekday(d.date);
      const label = idx === 0 ? "ì˜¤ëŠ˜" : weekday;

      const temp = d.temp;
      const tmax = d.temp_max;
      const tmin = d.temp_min;

      const tempPart = (tmax != null && tmin != null)
        ? `${tmax.toFixed(0)}Â° / ${tmin.toFixed(0)}Â°`
        : (temp != null ? `${temp.toFixed(0)}Â°` : "-Â°");

      const iconEmoji = mapIconToEmoji(d.icon);
      const desc = d.desc || "";

      div.innerHTML = `
        <span class="text-muted" style="width:32px;">${label}</span>
        <span style="width:32px; text-align:center;">${iconEmoji}</span>
        <span class="fw-semibold" style="width:80px; text-align:right;">${tempPart}</span>
        <span class="text-muted" style="flex:1; text-align:left; margin-left:8px;">
          ${desc}
        </span>
      `;
      listBox.appendChild(div);
    });
  } catch (e) {
    console.error("profile weather error", e);
  }
}



// ê³µí†µ: í—¤ë”/ì‚¬ì´ë“œë°” í”„ë¡œí•„ ì„¸íŒ…
async function setupHeaderAndProfile() {
  const nav = document.querySelector(".navbar-nav");
  const loginLi = document.getElementById("nav-login");
  const signupLi = document.getElementById("nav-signup");
  if (token && nav) {
    if (loginLi) loginLi.remove();
    if (signupLi) signupLi.remove();
    const logoutLi = document.createElement("li");
    logoutLi.className = "nav-item";
    logoutLi.innerHTML = `<a class="btn btn-outline-danger" href="#">ë¡œê·¸ì•„ì›ƒ</a>`;
    logoutLi.querySelector("a").onclick = (e) => {
      e.preventDefault();
      localStorage.removeItem("access_token");
      localStorage.removeItem("refresh_token");
      window.location.href = "index.html";
    };
    nav.appendChild(logoutLi);
  }
  if (!token) return;

  const res = await fetch("http://127.0.0.1:8000/user/profile", {
    headers: { "Authorization": "Bearer " + token }
  });
  if (!res.ok) return;
  const user = await res.json();
  currentUserId = user.id;

  const nick = user.nickname || (user.name || "ì‚¬ìš©ì");
  const email = user.email || "";

  const sideNick = document.getElementById("side-nickname");
  const profNick = document.getElementById("profile-nickname");
  if (sideNick) sideNick.textContent = nick;
  if (profNick) profNick.textContent = nick;

  const sideEmail = document.getElementById("side-email");
  const profEmail = document.getElementById("profile-email");
  if (sideEmail) sideEmail.textContent = email;
  if (profEmail) profEmail.textContent = email;

  const sideInit = document.getElementById("side-initial");
  const profInit = document.getElementById("profile-initial");
  if (sideInit) sideInit.textContent = nick[0];
  if (profInit) profInit.textContent = nick[0];
}

async function searchFriendsByNickname(query) {
  if (!token || !query.trim()) return;

  const res = await fetch(
    `http://127.0.0.1:8000/follow/search-by-nickname/?nickname=${encodeURIComponent(query)}`,
    {
      headers: { "Authorization": "Bearer " + token }
    }
  );
  if (!res.ok) {
    alert("ì¹œêµ¬ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    return;
  }
  const users = await res.json();  // [{id, nickname, email, ...}]

  const ul = document.getElementById("friend-search-result");
  ul.innerHTML = "";

  // ë‚˜ ìì‹  / ì´ë¯¸ íŒ”ë¡œì‰í•œ ì‚¬ìš©ì ì œê±°
  const filteredUsers = users.filter(u => {
    const uid = u.user_id;
    if (currentUserId && uid === currentUserId) return false;
    if (followingIdSet.has(uid)) return false;
    return true;
  });

  if (!filteredUsers.length) {
    const li = document.createElement("li");
    li.className = "list-group-item text-muted small";
    li.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
    ul.appendChild(li);
    return;
  }

  filteredUsers.forEach(user => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";

    li.innerHTML = `
      <div>
        <div class="fw-semibold">${user.nickname || "(ì´ë¦„ ì—†ìŒ)"}</div>
      </div>
      <button class="btn btn-sm btn-outline-success">íŒ”ë¡œìš°</button>
    `;

    const btn = li.querySelector("button");
    btn.onclick = async () => {
      await followUser(user.user_id);
      btn.textContent = "íŒ”ë¡œì‰";
      btn.classList.remove("btn-outline-success");
      btn.classList.add("btn-secondary");
      btn.disabled = true;
    };

    ul.appendChild(li);
  });
}

// íŒ”ë¡œìš° ì‹ ì²­
async function followUser(targetUserId) {
  if (!token) return;

  const res = await fetch("http://127.0.0.1:8000/follow/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ following_id: targetUserId })
  });

  if (!res.ok) {
    const err = await res.json().catch(() => null);
    alert((err && err.detail) || "íŒ”ë¡œìš° ì‹ ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  alert("íŒ”ë¡œìš° ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
  await loadFollowLists();   // íŒ”ë¡œì‰ ëª©ë¡ ê°±ì‹ 
}

// íŒ”ë¡œìš° ëª©ë¡ ë¡œë”©
async function loadFollowLists() {
  const [followingRes, followerRes] = await Promise.all([
    fetch("http://127.0.0.1:8000/follow/following", {
      headers: { "Authorization": "Bearer " + token }
    }),
    fetch("http://127.0.0.1:8000/follow/followers", {
      headers: { "Authorization": "Bearer " + token }
    })
  ]);

  const following = followingRes.ok ? await followingRes.json() : [];
  const followers = followerRes.ok ? await followerRes.json() : [];

  const fList = document.getElementById("following-list");
  const rList = document.getElementById("follower-list");
  fList.innerHTML = "";
  rList.innerHTML = "";

  const followingCountEl = document.getElementById("following-count");
  const followerCountEl  = document.getElementById("follower-count");
  if (followingCountEl) followingCountEl.textContent = `(${following.length})`;
  if (followerCountEl)  followerCountEl.textContent  = `(${followers.length})`;

  followingIdSet = new Set(following.map(f => f.following_id));

  fList.innerHTML = "";
  rList.innerHTML = "";

  following.forEach(f => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";

    const name = f.following_nickname || `ì‚¬ìš©ì #${f.following_id}`;

    li.innerHTML = `
      <span>${name}</span>
      <button class="btn btn-sm btn-outline-danger">ì·¨ì†Œ</button>
    `;

    const btn = li.querySelector("button");
    btn.onclick = async () => {
      if (!confirm(`'${name}' íŒ”ë¡œìš°ë¥¼ ì·¨ì†Œí• ê¹Œìš”?`)) return;
      await unfollowUser(f.following_id);
    };

    fList.appendChild(li);
  });

  followers.forEach(f => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.textContent = f.follower_nickname || `ì‚¬ìš©ì #${f.follower_id}`;
    rList.appendChild(li);
  });
}

async function unfollowUser(followingId) {
  if (!token) return;

  const res = await fetch(`http://127.0.0.1:8000/follow/${followingId}`, {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + token }
  });

  if (!res.ok) {
    const err = await res.json().catch(() => null);
    alert((err && err.detail) || "íŒ”ë¡œìš° ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  alert("íŒ”ë¡œìš°ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.");
  await loadFollowLists();      // ëª©ë¡/ì¹´ìš´íŠ¸/ê²€ìƒ‰ í•„í„° ê°±ì‹ 
}


window.addEventListener("DOMContentLoaded", async () => {
  if (!token) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    window.location.href = "login.html";
    return;
  }
  await setupHeaderAndProfile();
  await loadProfileWeather();
  await loadFollowLists();

  // ì¹œêµ¬ ê²€ìƒ‰ ì´ë²¤íŠ¸ ì—°ê²°
  const input = document.getElementById("friend-search-input");
  const btn   = document.getElementById("friend-search-btn");

  btn.addEventListener("click", () => {
    searchFriendsByNickname(input.value);
  });
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      searchFriendsByNickname(input.value);
    }
  });
});
let notifCount = 0;

async function loadNotifications() {
  const token = localStorage.getItem("access_token");
  if (!token) return;

  try {
    const res = await fetch("http://127.0.0.1:8000/notifications/", {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) return;
    const items = await res.json();   // [{id, type, message, ...}, ...]

    const ul = document.getElementById("notif-list");
    if (!ul) return;
    ul.innerHTML = "";

    items.forEach(n => {
      const li = document.createElement("li");
      li.className = "list-group-item py-2";
      li.textContent = n.message;
      ul.appendChild(li);
    });

    if (items.length > 0) {
      notifCount = items.filter(n => !n.is_read).length || items.length;
      const badge = document.getElementById("notif-badge");
      if (badge) {
        badge.textContent = notifCount;
        badge.classList.toggle("d-none", notifCount === 0);
      }
    }
  } catch (e) {
    console.error("loadNotifications error", e);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("notif-btn");
  const panel = document.getElementById("notif-panel");
  const closeBtn = document.getElementById("notif-close");

  if (!btn || !panel) return;

  btn.addEventListener("click", async () => {
    if (panel.classList.contains("d-none")) {
      await loadNotifications();          // ì—´ ë•Œë§ˆë‹¤ ìµœì‹  ëª©ë¡
      panel.classList.remove("d-none");
      const badge = document.getElementById("notif-badge");
      if (badge) badge.classList.add("d-none");   // ì—´ë©´ ë±ƒì§€ ì´ˆê¸°í™”
    } else {
      panel.classList.add("d-none");
    }
  });

  if (closeBtn) {
    closeBtn.addEventListener("click", () => panel.classList.add("d-none"));
  }
});

</script>
</body>
</html>
