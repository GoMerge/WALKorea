<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ë§ˆì´í˜ì´ì§€ | WALKorea</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color:#f5f7fb; }
    .day-good-badge {
      display: inline-block;
      margin-left: 2px;
      margin-top: 2px;
    }
    .sidebar-fixed {
      width: 260px;
      min-width: 260px;
      max-width: 260px;
      border-right: 1px solid #e5e7eb;
      background-color:#fff;
    }

    /* ì‚¬ì´ë“œë°” ë©”ë‰´ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .sidebar .menu-title {
      font-size:0.85rem;
      font-weight:600;
      color:#6b7280;
      margin-top:1rem;
      margin-bottom:0.25rem;
    }

    .sidebar .nav-link {
      font-size:0.95rem;
      color:#374151;
      padding:0.45rem 0.75rem;
      border-radius:0.35rem;
      margin-bottom:2px;
    }

    .sidebar .nav-link.active {
      background-color:#e0f2fe;
      color:#0369a1;
      font-weight:600;
    }

    .calendar-grid {
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:4px;
      font-size:0.85rem;
    }
    .calendar-day {
      position: relative;           
      border-radius: 4px;
      padding: 4px;
      background-color: #fff;
      border: 1px solid #e5e7eb;

      min-height: 0;
      aspect-ratio: 3 / 2;      
      overflow: hidden;    
    }
    .calendar-day.today {
      border: 2px solid #16a34a;
      background-color: #ecfdf3;
    }
    .calendar-day .date-num {
      line-height: 1.1;
      margin-bottom: 4px;
    }
    .calendar-day .event-list {
      position: absolute;
      top: 28px;          /* ë‚ ì§œ ìˆ«ì ì•„ë˜ë¶€í„° */
      left: 4px;
      right: 4px;
      bottom: 4px;
      overflow: hidden;   /* ë„˜ì¹˜ëŠ” ì¤„ì€ ì˜ë¦¬ê²Œ */
    }
    .calendar-day .event-chip {
      background-color: #0ea5e9;
      color: #fff;
      border-radius: 6px;
      padding: 2px 4px;
      margin-top: 2px;
      font-size: 0.72rem;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }
    .calendar-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #16a34a; /* ì´ˆë¡ */
      margin: 2px auto 0;
    }
    .weather-box {
      background-color:#fff;
      border-radius:0.75rem;
      padding:0.75rem 0.85rem;
      box-shadow:0 1px 3px rgba(15,23,42,0.08);
      font-size:0.8rem;
    }

    #region-weather-list div {
      line-height:1.4;
    }
    .event-weather-badge {
      font-size: 0.7rem;
      margin-top: 2px;
      color: #0f172a;
    }
    .event-weather-badge.good {
      color: #16a34a; /* ì´ˆë¡ */
      font-weight: 600;
    }
    .event-weather-badge.bad {
      color: #dc2626; /* ë¹¨ê°• */
      font-weight: 600;
    }
    .event-chip.shared-event-chip {
      background-color: #f973a5;  /* í•‘í¬ */
      border: 1px solid #ec4899;
      color: #fff;
    }
    .shared-event-chip {
      background-color: #f973a5;  /* í•‘í¬ */
      border-color: #ec4899;
    }
    .shared-event-list-item {
      border-left: 4px solid #f973a5;
      background-color: #fff1f5;
    }
  </style>
</head>
<body>
<header class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold text-success" href="index.html">WALKorea</a>
    <ul class="navbar-nav ms-auto gap-2">
      <li class="nav-item"><a class="nav-link" href="recommend.html">ì¶”ì²œ ì—¬í–‰ì§€</a></li>
      <li class="nav-item"><a class="nav-link" href="calendar.html">ì—¬í–‰ ìº˜ë¦°ë”</a></li>
      <li class="nav-item"><a class="nav-link" href="mypage_calendar.html">ë§ˆì´í˜ì´ì§€</a></li>
      <!-- ì•Œë¦¼ ì•„ì´ì½˜ -->
      <li class="nav-item position-relative">
        <button id="notif-btn" class="btn btn-link nav-link p-0 position-relative">
          <span class="fs-5">ğŸ””</span>
          <span id="notif-badge"
                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
          </span>
        </button>

        <!-- ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ íŒ¨ë„ -->
        <div id="notif-panel"
             class="card shadow-sm position-absolute end-0 mt-2 d-none"
             style="width:260px; z-index:1050;">
          <div class="card-header py-2 px-3 d-flex justify-content-between align-items-center">
            <span class="small fw-semibold">ì•Œë¦¼</span>
            <button id="notif-close" class="btn btn-sm btn-outline-secondary py-0 px-1">Ã—</button>
          </div>
          <ul id="notif-list" class="list-group list-group-flush small"></ul>
        </div>
      </li>
      <li class="nav-item" id="nav-login"><a class="btn btn-success" href="login.html">ë¡œê·¸ì¸</a></li>
      <li class="nav-item" id="nav-signup"><a class="btn btn-primary" href="signup.html">íšŒì›ê°€ì…</a></li>
    </ul>
  </div>
</header>

<main class="container-fluid" style="margin-top:10px;">
  <div class="d-flex">
    <!-- ì™¼ìª½: ë§ˆì´í˜ì´ì§€ ì¹´í…Œê³ ë¦¬ -->
    <aside class="sidebar-fixed sidebar p-3">
      <div class="d-flex align-items-center mb-3">
        <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center"
            style="width:40px;height:40px;">
          <span id="side-initial">W</span>
        </div>
        <div class="ms-2">
          <div class="fw-semibold" id="side-nickname">ë¡œê·¸ì¸ ì‚¬ìš©ì</div>
          <div class="text-muted small" id="side-email">-</div>
        </div>
      </div>

      <div class="weather-box mb-3" id="weather-box">
        <div class="fw-semibold mb-1" id="region-weather-title">ë™ë„¤ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”</div>
        <div class="small text-muted mb-2" id="region-weather-desc">
          ë§ˆì´í˜ì´ì§€ &gt; í”„ë¡œí•„ ìˆ˜ì •ì—ì„œ ì§€ì—­ì„ ì„¤ì •í•˜ë©´, ì´ê³³ì— 6ì¼ê°„ì˜ ë‚ ì”¨ë¥¼ ë³´ì—¬ì¤„ê²Œìš”.
        </div>
        <div id="region-weather-list"></div>
        <a class="btn btn-outline-success btn-sm mt-2 w-100" href="mypage_profile.html">
          ì§€ì—­ ì„¤ì •í•˜ëŸ¬ ê°€ê¸°
        </a>
      </div>

      <div class="menu-title">ë§ˆì´í˜ì´ì§€</div>
      <nav class="nav flex-column">
        <a href="mypage_calendar.html"  class="nav-link active">ë‚´ ì¼ì •</a>
        <a href="mypage_friends.html"   class="nav-link">ì¹œêµ¬ ê´€ë¦¬</a>
        <a href="mypage_recommend.html" class="nav-link">ë§ì¶¤ ê´€ê´‘</a>
        <a href="mypage_profile.html"   class="nav-link">í”„ë¡œí•„ ìˆ˜ì •</a>
        <a href="mypage_favorites.html" class="nav-link">ì¢‹ì•„ìš” í•œ ì—¬í–‰ì§€</a>
      </nav>
    </aside>

    <!-- ì˜¤ë¥¸ìª½: ì»¨í…ì¸  ì˜ì—­ -->
    <section class="col-md-9 col-lg-10 p-4">
      <!-- ìƒë‹¨: í”„ë¡œí•„ ì¹´ë“œ -->
      <div class="row g-3 mb-3">
        <div class="col-lg-8">
          <div class="profile-card d-flex align-items-center gap-3">
            <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center" style="width:64px;height:64px;font-size:1.5rem;">
              <span id="profile-initial">W</span>
            </div>
            <div>
              <div class="fw-bold fs-5" id="profile-nickname">ë¡œê·¸ì¸ ì‚¬ìš©ì</div>
              <div class="text-muted small" id="profile-email">-</div>
              <div class="text-muted small" id="profile-region-msg">
                ê±°ì£¼ ì§€ì—­ì„ ì„¤ì •í•˜ë©´ ì´ê³³ì— ë™ë„¤ ë‚ ì”¨ë¥¼ ë³´ì—¬ì¤„ê²Œìš”.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì„¹ì…˜: ë‚´ ì¼ì • -->
      <div id="section-calendar">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="prev-month">&lt;</button>
            <h4 class="mb-0 fw-bold" id="month-title">2025ë…„ 11ì›”</h4>
            <button class="btn btn-outline-secondary btn-sm" id="next-month">&gt;</button>
          </div>
          <button class="btn btn-success btn-sm" id="btn-new-calendar">+ ì¼ì • ì¶”ê°€</button>
        </div>
        <div class="calendar-grid text-center mb-2 fw-semibold">
          <div class="text-danger">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="text-primary">í† </div>
        </div>
        <div id="calendar-body" class="calendar-grid mb-3"></div>
        <h6 class="fw-bold mb-2">ë‚´ ì¼ì • ëª©ë¡</h6>
        <ul class="list-group small" id="my-cal-list"></ul>
      </div>
    </section>
  </div>
  <!-- ì¼ì • ì¶”ê°€ ëª¨ë‹¬ -->
  <div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h5 class="modal-title">ì¼ì • ì¶”ê°€</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="event-form">
          <div class="modal-body">
            <div class="mb-2">
              <label class="form-label small">ì œëª©</label>
              <input type="text" class="form-control" id="ev-title" required>
            </div>

            <div class="row g-2 mb-2">
              <div class="col-6">
                <label class="form-label small">ì‹œì‘</label>
                <input type="datetime-local" class="form-control" id="ev-start" required>
              </div>
              <div class="col-6">
                <label class="form-label small">ì¢…ë£Œ</label>
                <input type="datetime-local" class="form-control" id="ev-end" required>
              </div>
            </div>

            <div class="mb-2">
              <label class="form-label small">ì¥ì†Œ</label>
              <div class="input-group input-group-sm position-relative">
                <input type="text"
                  class="form-control"
                  id="ev-place"
                  placeholder="ì˜ˆ) ì„œìš¸ ì¢…ë¡œêµ¬ / ì¢…ë¡œ 5ê¸¸ / ê±´ë¬¼ëª…ìœ¼ë¡œ ê²€ìƒ‰ í›„ ì„ íƒ">
              </div>
              <div class="list-group position-absolute w-100"
                  id="place-suggestions"
                  style="z-index:1056; max-height:200px; overflow:auto; display:none;"></div>
              <div class="small text-muted mt-1" id="place-preview"></div>
            </div>

            <div class="mb-2">
              <label class="form-label small">ì•Œë¦¼ ì‹œê°„</label>
              <select class="form-select form-select-sm" id="ev-remind">
                <option value="0">ì•Œë¦¼ ì—†ìŒ</option>
                <option value="5">5ë¶„ ì „</option>
                <option value="10">10ë¶„ ì „</option>
                <option value="30">30ë¶„ ì „</option>
                <option value="60">1ì‹œê°„ ì „</option>
              </select>
            </div>

            <div class="mb-2">
              <label class="form-label small">ë©”ëª¨</label>
              <textarea class="form-control" id="ev-memo" rows="3" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>

          </div>
          <div class="modal-footer py-2">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-success btn-sm">ì €ì¥</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- ë‚ ì§œë³„ ì¼ì • ëª¨ë‹¬ -->
  <div class="modal fade" id="dayEventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h5 class="modal-title" id="day-modal-title">12ì›” 8ì¼ ì¼ì •</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul class="list-group small" id="day-event-list"></ul>
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">ë‹«ê¸°</button>
          <button type="button" class="btn btn-success btn-sm" id="btn-add-on-day">
            + ì´ ë‚ ì§œì— ì¼ì • ì¶”ê°€
          </button>
        </div>
      </div>
    </div>
  </div>
    <!-- ì¼ì • ê³µìœ  ëŒ€ìƒ ì„ íƒ ëª¨ë‹¬ -->
  <div class="modal fade" id="shareEventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h5 class="modal-title">ì¼ì • ê³µìœ </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="small mb-2" id="share-event-title"></p>
          <label class="form-label small">ê³µìœ í•  ì¹œêµ¬ ì„ íƒ</label>
          <select class="form-select form-select-sm" id="share-target-select">
          </select>
          <div class="small text-muted mt-1">
            ì„œë¡œ íŒ”ë¡œìš° ì¤‘ì¸ ì¹œêµ¬ë§Œ ê³µìœ í•  ìˆ˜ ìˆì–´ìš”.
          </div>
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-success btn-sm" id="btn-share-confirm">ê³µìœ í•˜ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ê³µìœ  ìš”ì²­ ìˆ˜ë½/ê±°ì ˆ ëª¨ë‹¬ -->
  <div class="modal fade" id="shareConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h5 class="modal-title">ì¼ì • ê³µìœ  ìš”ì²­</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="share-confirm-text" class="mb-0"></p>
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-secondary btn-sm" id="btn-share-reject">ê±°ì ˆ</button>
          <button type="button" class="btn btn-success btn-sm" id="btn-share-accept">ìˆ˜ë½</button>
        </div>
      </div>
    </div>
  </div>
</main>

<script>

let shareTargetFollowing = [];   // íŒ”ë¡œì‰ ëª©ë¡ ìºì‹œ
let shareSourceEvent = null;     // í˜„ì¬ ê³µìœ í•˜ë ¤ëŠ” ì´ë²¤íŠ¸ ê°ì²´

let debugPlaceWeatherMap = {};
let debugUserWeatherMap = {};

// ê³µí†µ: í•­ìƒ ìµœì‹  í† í° ì½ê¸°
function getToken() {
  return localStorage.getItem("access_token");
}

const placeInput = document.getElementById("ev-place");
const suggestBox = document.getElementById("place-suggestions");

let placeTimer = null;

placeInput.addEventListener("input", () => {
  const q = placeInput.value.trim();
  if (placeTimer) clearTimeout(placeTimer);

  if (!q) {
    suggestBox.style.display = "none";
    suggestBox.innerHTML = "";
    return;
  }

  placeTimer = setTimeout(() => fetchRegionSuggestions(q), 300);
});

async function fetchRegionSuggestions(q) {
  const res = await fetch(`http://127.0.0.1:8000/address/search?q=${encodeURIComponent(q)}`);
  if (!res.ok) {
    suggestBox.style.display = "none";
    suggestBox.innerHTML = "";
    return;
  }
  const items = await res.json();  // [{id, code, full_name}, ...]

  if (!items.length) {
    suggestBox.style.display = "none";
    suggestBox.innerHTML = "";
    return;
  }

  suggestBox.innerHTML = "";
  items.forEach(item => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "list-group-item list-group-item-action small text-start";
    btn.textContent = item.full_name;
    btn.dataset.regionId = item.id;
    btn.dataset.regionCode = item.code;
    btn.onclick = () => selectRegionSuggestion(item);
    suggestBox.appendChild(btn);
  });
  suggestBox.style.display = "block";
}

function selectRegionSuggestion(item) {
  placeInput.value = item.full_name;
  placeInput.dataset.regionId = item.id;
  placeInput.dataset.regionCode = item.code;
  placeInput.dataset.fullName = item.full_name;

  suggestBox.style.display = "none";
  suggestBox.innerHTML = "";

  document.getElementById("place-preview").textContent = item.full_name;

  const preview = document.getElementById("place-preview");
  preview.textContent = item.full_name;
}


async function apiFetch(url, options = {}) {
  const res = await fetch(url, options);
  if (res.status === 401) {
    alert("ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.");
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    window.location.href = "login.html";
    return null;
  }
  return res;
}

// ê³µí†µ: í—¤ë”/ì‚¬ì´ë“œë°” í”„ë¡œí•„ ì„¸íŒ…
async function setupHeaderAndProfile() {
  const token = getToken();
  const nav = document.querySelector(".navbar-nav");
  const loginLi = document.getElementById("nav-login");
  const signupLi = document.getElementById("nav-signup");

  if (token && nav) {
    if (loginLi) loginLi.remove();
    if (signupLi) signupLi.remove();
    const logoutLi = document.createElement("li");
    logoutLi.className = "nav-item";
    logoutLi.innerHTML = `<a class="btn btn-outline-danger" href="#">ë¡œê·¸ì•„ì›ƒ</a>`;
    logoutLi.querySelector("a").onclick = (e) => {
      e.preventDefault();
      localStorage.removeItem("access_token");
      localStorage.removeItem("refresh_token");
      window.location.href = "index.html";
    };
    nav.appendChild(logoutLi);
  }
  if (!token) return;

  const res = await fetch("http://127.0.0.1:8000/user/profile", {
    headers: { "Authorization": "Bearer " + token }
  });
  if (!res.ok) return;
  const user = await res.json();

  const nick = user.nickname || (user.name || "ì‚¬ìš©ì");
  const email = user.email || "";

  const sideNick = document.getElementById("side-nickname");
  const profNick = document.getElementById("profile-nickname");
  if (sideNick) sideNick.textContent = nick;
  if (profNick) profNick.textContent = nick;

  const sideEmail = document.getElementById("side-email");
  const profEmail = document.getElementById("profile-email");
  if (sideEmail) sideEmail.textContent = email;
  if (profEmail) profEmail.textContent = email;

  const sideInit = document.getElementById("side-initial");
  const profInit = document.getElementById("profile-initial");
  if (sideInit) sideInit.textContent = nick[0];
  if (profInit) profInit.textContent = nick[0];

  const regionMsg = document.getElementById("profile-region-msg");
  const weatherTitle = document.getElementById("region-weather-title");
  const weatherDesc  = document.getElementById("region-weather-desc");
  if (!user.region_id) {
    regionMsg.textContent = "ì§€ì—­ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í”„ë¡œí•„ì—ì„œ ë™ë„¤ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.";
    weatherTitle.textContent = "ë™ë„¤ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”";
    weatherDesc.textContent  = "í”„ë¡œí•„ì—ì„œ ê±°ì£¼ ì§€ì—­ì„ ì„¤ì •í•˜ë©´, ì´ê³³ì— 6ì¼ê°„ì˜ ë‚ ì”¨ë¥¼ ë³´ì—¬ì¤„ê²Œìš”.";
    userBaseAddress = null;
  } else {
    const base = user.region_full_name || user.region_name;
    regionMsg.textContent = `í˜„ì¬ ì§€ì—­: ${base}`;
    weatherTitle.textContent = `${base}ì˜ ì˜¤ëŠ˜ ë‚ ì”¨`;
    weatherDesc.textContent  = "ë‚ ì”¨ APIë¥¼ ì—°ë™í•´ì„œ ì‹¤ì œ ë°ì´í„°ë¥¼ í‘œì‹œí•˜ë©´ ë©ë‹ˆë‹¤.";
    userBaseAddress = base;
  }
}

function formatKoreanWeekday(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  const names = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
  return names[d.getDay()];
}

function mapIconToEmoji(icon) {
  // Visual Crossing icon ê°’ ê°„ë‹¨ ë§¤í•‘
  switch (icon) {
    case "rain": return "ğŸŒ§ï¸";
    case "snow": return "â„ï¸";
    case "fog": return "ğŸŒ«ï¸";
    case "wind": return "ğŸ’¨";
    case "cloudy": return "â˜ï¸";
    case "partly-cloudy-day": return "â›…";
    case "partly-cloudy-night": return "â˜ï¸";
    case "clear-day": return "â˜€ï¸";
    case "clear-night": return "ğŸŒ™";
    default: return "ğŸŒ¤ï¸";
  }
}

function weatherEmojiFromResult(w) {
  if (!w) return "";                 // ì •ë³´ ì—†ìœ¼ë©´ ì´ëª¨ì§€ ì—†ìŒ
  if (w.is_good === true) return "ğŸ˜Š";   // ì¢‹ìŒ
  if (w.is_good === false) return "ğŸ˜¡";  // ë‚˜ì¨
  return "ğŸ˜";                        // ë‚˜ì˜ì§€ë„, ì¢‹ì§€ë„ ì•Šì„ ë•Œ
}

function weatherTextFromResult(w) {
  if (!w) return "";                 // ì •ë³´ ì—†ìœ¼ë©´ í…ìŠ¤íŠ¸ë„ ì—†ìŒ
  return w.is_good ? "ë‚ ì”¨ ì¢‹ìŒ" : "ë‚ ì”¨ ë‚˜ì¨";
}


document.getElementById("event-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  const formEl = document.getElementById("event-form");
  const editingId = formEl.dataset.editEventId || null;

  const calId = await ensureUserCalendarId();
  if (!calId) return;

  const title = document.getElementById("ev-title").value.trim();
  const start = document.getElementById("ev-start").value;
  const end   = document.getElementById("ev-end").value;
  const memo  = document.getElementById("ev-memo").value.trim();
  const remindMinutes = parseInt(document.getElementById("ev-remind").value, 10);
  const placeInputEl = document.getElementById("ev-place");
  const placeText = placeInputEl.value.trim();
  const placeFull = placeInputEl.dataset.fullName || placeText;

  if (!title || !start || !end) {
    alert("ì œëª©ê³¼ ì‹œê°„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
    return;
  }

  const startDate = new Date(start + ':00').toISOString();
  const endDate   = new Date(end + ':00').toISOString();

  const payload = {
    title,
    start_date: startDate,
    end_date: endDate,
    description: memo || null,
    location: placeFull || null,
    remind_minutes: isNaN(remindMinutes) ? null : remindMinutes
  };

  const token = getToken();
  let url, method;
  if (editingId) {
    // ìˆ˜ì •
    url = `http://127.0.0.1:8000/calendar/events/${editingId}`;
    method = "PUT";
  } else {
    // ì‹ ê·œ
    url = `http://127.0.0.1:8000/calendar/${calId}/events`;
    method = "POST";
  }

  const res = await fetch(url, {
    method,
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const err = await res.json().catch(()=>null);
    alert((err && err.detail) || "ì¼ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  // ìƒíƒœ ì´ˆê¸°í™”
  delete formEl.dataset.editEventId;

  const modalEl = document.getElementById("eventModal");
  const modal = bootstrap.Modal.getInstance(modalEl);
  modal.hide();

  await loadCalendars();
  const calIdAfter = await ensureUserCalendarId();
  if (calIdAfter) {
    await loadEventsToCalendar(calIdAfter);
  }
});


async function loadProfileWeather() {
  const token = localStorage.getItem("access_token");
  if (!token) return;

  try {
    const res = await fetch("http://127.0.0.1:8000/weather/profile/current", {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) return;
    const data = await res.json();  // { region_name, days: [...] }

    const boxTitle = document.getElementById("region-weather-title");
    const boxDesc  = document.getElementById("region-weather-desc");
    const listBox  = document.getElementById("region-weather-list");
    if (!data.days || !boxTitle || !boxDesc || !listBox) return;

    boxTitle.textContent = `${data.region_name}ì˜ 6ì¼ê°„ ë‚ ì”¨`;
    boxDesc.textContent  = "ì˜¤ëŠ˜ì„ í¬í•¨í•œ 6ì¼ì¹˜ ë™ë„¤ ë‚ ì”¨ì˜ˆìš”.";

    listBox.innerHTML = "";

    data.days.forEach((d, idx) => {
      const div = document.createElement("div");
      div.className = "d-flex align-items-center small mb-1";

      const weekday = formatKoreanWeekday(d.date);
      const label = idx === 0 ? "ì˜¤ëŠ˜" : weekday;

      const temp = d.temp;
      const tmax = d.temp_max;
      const tmin = d.temp_min;

      const tempPart = (tmax != null && tmin != null)
        ? `${tmax.toFixed(0)}Â° / ${tmin.toFixed(0)}Â°`
        : (temp != null ? `${temp.toFixed(0)}Â°` : "-Â°");

      const iconEmoji = mapIconToEmoji(d.icon);
      const desc = d.desc || "";

      div.innerHTML = `
        <span class="text-muted" style="width:32px;">${label}</span>
        <span style="width:32px; text-align:center;">${iconEmoji}</span>
        <span class="fw-semibold" style="width:80px; text-align:right;">${tempPart}</span>
        <span class="text-muted" style="flex:1; text-align:left; margin-left:8px;">
          ${desc}
        </span>
      `;
      listBox.appendChild(div);
    });
  } catch (e) {
    console.error("profile weather error", e);
  }
}

// ìº˜ë¦°ë” ë¡œì§
let currentYear, currentMonth;
let eventsCache = {}; 
let userBaseAddress = null;

function initCalendar() {
  const today = new Date();
  const body = {
    user_id: 0,                 // ë°±ì—”ë“œì—ì„œ current_user.idë¡œ ë®ì–´ì“°ê¸° ë•Œë¬¸ì— ì•ˆ ë³´ë‚´ë„ ë˜ê²Œ ìŠ¤í‚¤ë§ˆ ìˆ˜ì •í•˜ëŠ” ê²Œ ì¢‹ìŒ
    place_id: null,
    event_date: today.toISOString().slice(0, 10),
    start_time: null,
    end_time: null,
    memo: "ë‚´ ìº˜ë¦°ë”"
  };
  currentYear = today.getFullYear();
  currentMonth = today.getMonth();
  document.getElementById("prev-month").onclick = () => changeMonth(-1);
  document.getElementById("next-month").onclick = () => changeMonth(1);
  renderCalendar();
}

async function changeMonth(delta) {
  currentMonth += delta;
  if (currentMonth < 0) { currentMonth = 11; currentYear--; }
  else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  renderCalendar();

  const calId = await ensureUserCalendarId();
  if (calId) {
    await loadEventsToCalendar(calId);  
  }
}

function renderCalendar() {
  const title = document.getElementById("month-title");
  title.textContent = `${currentYear}ë…„ ${currentMonth+1}ì›”`;

  const body = document.getElementById("calendar-body");
  body.innerHTML = "";

  const first = new Date(currentYear, currentMonth, 1);
  const last  = new Date(currentYear, currentMonth+1, 0);
  const startDay = first.getDay();
  const total = last.getDate();

  const today = new Date();
  const isThisMonth = (today.getFullYear() === currentYear && today.getMonth() === currentMonth);

  for (let i=0;i<startDay;i++) body.appendChild(document.createElement("div"));

  for (let d=1; d<=total; d++) {
    const div = document.createElement("div");
    div.className = "calendar-day";
    const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    if (isThisMonth && d === today.getDate()) div.classList.add("today");
    div.dataset.date = `${currentYear}-${String(currentMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    console.log("cell date:", dateStr); 
    div.innerHTML = `
    <div class="date-num">${d}</div>
    <div class="small text-muted event-list">ì¼ì • ì—†ìŒ</div>
    `;
    body.appendChild(div);
  }
}

async function loadCalendars() {
  const res = await apiFetch("http://127.0.0.1:8000/calendar/", {
    headers: { "Authorization": "Bearer " + getToken() }
  });
  if (!res) return;       
  const list = res.ok ? await res.json() : [];

  const ul = document.getElementById("my-cal-list");
  ul.innerHTML = "";
  list.forEach(c => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.textContent = c.memo || c.title || "ë‚´ ìº˜ë¦°ë”";
    ul.appendChild(li);
  });
}

let userCalendarId = null;

async function loadEventsToCalendar(calId) {
  const token = getToken();
  const res = await fetch(`http://127.0.0.1:8000/calendar/${calId}/events`, {
    headers: { "Authorization": "Bearer " + token }
  });
  if (!res.ok) return;
  const events = await res.json();
  console.log("events from API:", events);

  // 1) í˜„ì¬ ë‹¬ ê¸°ì¤€ìœ¼ë¡œ ë¨¼ì € í•„í„°ë§
  const filtered = events.filter(ev => {
    const iso = ev.start_datetime || ev.start_date;
    if (!iso) return false;
    const d = new Date(iso);
    return d.getFullYear() === currentYear && d.getMonth() === currentMonth;
  });

  // 2) ë‚ ì”¨ ì¶”ì²œ payload (í˜„ì¬ ë‹¬ ì´ë²¤íŠ¸ë§Œ)
  const placeWeatherPayload = filtered
    .filter(ev => ev.location && (ev.start_datetime || ev.start_date))
    .map(ev => ({
      address: ev.location,
      date: (ev.start_datetime || ev.start_date).slice(0,10)
    }));
  const placeWeatherMap = await fetchWeatherRecommendations(placeWeatherPayload);
  debugPlaceWeatherMap = placeWeatherMap;

  // 2-1) í•œ ë‹¬ ì „ì²´ ë‚ ì§œì— ëŒ€í•´ ì‚¬ìš©ì ìœ„ì¹˜ ê¸°ì¤€ ë‚ ì”¨ ìš”ì²­ (ë”°ë´‰ìš©)
  let userWeatherMap = {};
  if (userBaseAddress) {
    const monthDaysPayload = [];

    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay  = new Date(currentYear, currentMonth + 1, 0);
    const total    = lastDay.getDate();

    for (let d = 1; d <= total; d++) {
      const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      monthDaysPayload.push({
        address: userBaseAddress,    // â˜… í•­ìƒ ì‚¬ìš©ì ìœ„ì¹˜
        date: dateStr                // â˜… ê·¸ ë‹¬ì˜ ëª¨ë“  ë‚ ì§œ
      });
    }

    userWeatherMap = await fetchWeatherRecommendations(monthDaysPayload);
    debugUserWeatherMap = userWeatherMap;
  }

  const cells = document.querySelectorAll(".calendar-day");
  const map = {};
  eventsCache = {};

  // 3) ë‚´ ì¼ì • ëª©ë¡: í˜„ì¬ ë‹¬ë§Œ
  const ul = document.getElementById("my-cal-list");
  ul.innerHTML = "";

  const sorted = [...filtered].sort((a, b) => {
    const sa = (a.start_datetime || a.start_date);
    const sb = (b.start_datetime || b.start_date);
    return sa.localeCompare(sb);
  });

  sorted.forEach(ev => {
    const iso = (ev.start_datetime || ev.start_date);
    const d = new Date(iso);
    const month = d.getMonth() + 1;
    const day = d.getDate();
    const time = iso.slice(11, 16);
    const keyForEvent = `${iso.slice(0,10)}|${ev.location || ""}`;

    const w = placeWeatherMap[keyForEvent];
    console.log("event item:", keyForEvent, ev);
    console.log("weather for event:", ev.title, keyForEvent, w);

    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";

    if (ev.is_shared === 1) {
      li.classList.add("shared-event-list-item");
    }

    let emoji = "";
    let wText = "ë‚ ì”¨ ì •ë³´ ì—†ìŒ";

    if (ev.location) {
      const key = `${iso.slice(0,10)}|${ev.location}`;
      const w = placeWeatherMap[key];
      console.log("weather for event:", ev.title, key, w);

      emoji = weatherEmojiFromResult(w);

      if (w && w.weather && w.weather.avg_weather) {
        const aw = w.weather.avg_weather;
        const tRaw = aw["ê¸°ì˜¨(â„ƒ)"];
        const pRaw = aw["ê°•ìˆ˜ëŸ‰(mm)"];

        const parts = [];
        if (tRaw != null) parts.push(`í‰ê·  ${Number(tRaw).toFixed(1)}Â°C`);
        if (pRaw != null) parts.push(`ê°•ìˆ˜ ${Number(pRaw).toFixed(1)}mm`);

        if (parts.length > 0) {
          wText = parts.join(", ");
        }
      }
    }

    li.innerHTML = `
      <div class="me-2 flex-grow-1">
        <div class="fw-semibold">${emoji ? emoji + " " : ""}${ev.title}</div>
        <div class="text-muted small">
          ${month}/${day} ${time} Â· ${wText}
        </div>
      </div>
      <div class="d-flex gap-1">
        <button class="btn btn-sm btn-outline-primary btn-share-event">ê³µìœ í•˜ê¸°</button>
        <button class="btn btn-sm btn-outline-secondary btn-edit-event">ìˆ˜ì •</button>
        <button class="btn btn-sm btn-outline-danger btn-delete-event">ì‚­ì œ</button>
      </div>
    `;

    const shareBtn = li.querySelector(".btn-share-event");
    shareBtn.onclick = async (e) => {
      e.stopPropagation();
      await openShareModal(ev);
    };

    const editBtn = li.querySelector(".btn-edit-event");
    editBtn.onclick = (e) => {
      e.stopPropagation();
      openEventModalForEdit(ev);   // ìˆ˜ì • ëª¨ë“œë¡œ ëª¨ë‹¬ ì—´ê¸°
    };

    const deleteBtn = li.querySelector(".btn-delete-event");
    deleteBtn.onclick = async (e) => {
      e.stopPropagation();
      await deleteEvent(ev);
    };

    li.onclick = () => openEventDetail(ev);
    ul.appendChild(li);
  });



  // 4) ë‚ ì§œë³„ ì´ë²¤íŠ¸/ìºì‹œ êµ¬ì„±
  filtered.forEach(ev => {
    const src = ev.start_datetime || ev.start_date;
    if (!src) return;
    const d = src.slice(0, 10);   // "YYYY-MM-DD"
    if (!map[d]) map[d] = [];
    map[d].push(ev.title);
    if (!eventsCache[d]) eventsCache[d] = [];
    eventsCache[d].push(ev);
  });
  console.log("eventsByDate map:", map);

  // 5) ì…€ ë Œë”ë§ + ë”°ë´‰/ì´ëª¨ì§€
  cells.forEach(cell => {
    const date = cell.dataset.date;           // "YYYY-MM-DD"
    const label = cell.querySelector(".event-list");
    const dateEl = cell.querySelector(".date-num");
    if (!label || !dateEl) return;

    const cellEvents = eventsCache[date] || [];

    // 1) ì‚¬ìš©ì ìœ„ì¹˜ ê¸°ì¤€ "ì¢‹ì€ ë‚ "ì¸ì§€ ë¨¼ì € íŒë³„
    let dayIsGood = false;
    let wForDay = null;

    if (userBaseAddress) {
      const key = `${date}|${userBaseAddress}`;
      wForDay = userWeatherMap[key];
      if (wForDay && (wForDay.is_good === true || wForDay.quality === "good")) {
        dayIsGood = true;
      }
    }

    // 2) ê¸°ì¡´ ë°°ì§€ ì œê±° í›„, good ì´ë©´ ìƒˆ ë°°ì§€ ì¶”ê°€
    const oldBadge = dateEl.querySelector(".day-good-badge");
    if (oldBadge) oldBadge.remove();

    if (dayIsGood) {
      const badge = document.createElement("span");
      badge.textContent = "ğŸ‘";
      badge.className = "day-good-badge ms-1";
      dateEl.appendChild(badge);
    }

    // 3) ì´í•˜ ì¼ì •/í‘œì • ì´ëª¨í‹°ì½˜ ë¡œì§ì€ ê·¸ëŒ€ë¡œ
    if (cellEvents.length > 0) {
      label.innerHTML = "";
      cellEvents.slice(0, 3).forEach(ev => {
        const chip = document.createElement("div");
        chip.className = "event-chip";
        if (ev.is_shared === 1) chip.classList.add("shared-event-chip");

        let emoji = "";
        if (ev.location) {
          const key = `${date}|${ev.location}`;
          const w = placeWeatherMap[key];
          emoji = weatherEmojiFromResult(w);
        }

        chip.textContent = `${emoji ? emoji + " " : ""}${ev.title}`;
        label.appendChild(chip);
      });
      if (cellEvents.length > 3) {
        const more = document.createElement("div");
        more.className = "text-muted small";
        more.textContent = `+${cellEvents.length - 3} ë”ë³´ê¸°`;
        label.appendChild(more);
      }
    } else {
      label.textContent = "ì¼ì • ì—†ìŒ";
    }
  });
}


// ì¼ì • ë°°ì—´ [{ address, date }, ...] ë¡œ ì¶”ì²œ ìš”ì²­
async function fetchWeatherRecommendations(events) {
  if (!events.length) return {};

  const token = getToken();    
  if (!token) return {};
  try {
    const res = await fetch("http://127.0.0.1:8000/calendar/weather/recommend", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
      body: JSON.stringify(events)
    });
    if (!res.ok) {
      console.warn("weather recommend failed", res.status);
      return {};
    }

    const data = await res.json(); // { results: [...] }
    console.log("weather recommend data:", data); 

    const map = {};
    (data.results || []).forEach(r => {
      const key = `${r.date}|${r.address}`;
      console.log("result item:", key, r);
      map[key] = r;
    });
    return map;  // { "2025-12-01|ì„œìš¸ ì¢…ë¡œêµ¬ ...": {is_good, weather, ...}, ... }
  } catch (e) {
    console.error("weather recommend error", e);
    return {};
  }
}


async function ensureUserCalendarId() {
  const token = getToken();
  if (userCalendarId) return userCalendarId;

  const res = await fetch("http://127.0.0.1:8000/calendar/", {
    headers: { "Authorization": "Bearer " + token }
  });
  const list = res.ok ? await res.json() : [];
  if (list.length === 0) {
    alert("ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤. ë°±ì—”ë“œì—ì„œ UserCalendar ìƒì„± APIë¥¼ ë§ì¶”ê±°ë‚˜, êµ¬ì¡°ë¥¼ ì •ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.");
    return null;
  }
  userCalendarId = list[0].id;
  return userCalendarId;
}

window.addEventListener("DOMContentLoaded", async () => {
  const btnNew = document.getElementById("btn-new-calendar");
  btnNew.addEventListener("click", () => {
    openEventModal();          // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ëª¨ë‹¬ ì˜¤í”ˆ
  });

  const calBody = document.getElementById("calendar-body");
  calBody.addEventListener("dblclick", (e) => {
    const cell = e.target.closest(".calendar-day");
    if (!cell) return;
    const dateStr = cell.dataset.date;   // renderCalendarì—ì„œ ë„£ì–´ë‘” yyyy-mm-dd
    openDayEventModal(dateStr); 
  });

  const token = getToken();
  if (!token) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    window.location.href = "login.html";
    return;
  }
  await setupHeaderAndProfile();
  await loadProfileWeather();
  initCalendar();
  await loadCalendars();

  const calId = await ensureUserCalendarId();
  if (calId) {
    await loadEventsToCalendar(calId);   
  }
  await checkIncomingShares();
});

function openDayEventModal(dateStr) {
  const listEl = document.getElementById("day-event-list");
  const titleEl = document.getElementById("day-modal-title");
  const addBtn = document.getElementById("btn-add-on-day");

  // ì œëª©: "2025ë…„ 12ì›” 8ì¼" í˜•íƒœ
  const d = new Date(dateStr);
  titleEl.textContent = `${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼ ì¼ì •`;

  listEl.innerHTML = "";
  const events = eventsCache[dateStr] || [];

  if (events.length === 0) {
    const li = document.createElement("li");
    li.className = "list-group-item text-muted small";
    li.textContent = "ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.";
    listEl.appendChild(li);
  } else {
    events.forEach(ev => {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";

      let emoji = "";
      let wText = "ë‚ ì”¨ ì •ë³´ ì—†ìŒ";

      if (ev.location) {
        const key = `${dateStr}|${ev.location}`;
        const w = debugPlaceWeatherMap[key];
        console.log("day modal weather:", ev.title, key, w);

        emoji = weatherEmojiFromResult(w);

        if (w) {
          const parts = [];
          if (w.avg_temp != null)  parts.push(`í‰ê·  ${Number(w.avg_temp).toFixed(1)}Â°C`);
          if (w.precip_mm != null) parts.push(`ê°•ìˆ˜ ${Number(w.precip_mm).toFixed(1)}mm`);
          if (parts.length > 0) wText = parts.join(", ");
        }
      }

      li.innerHTML = `
        <div class="me-2 flex-grow-1">
          <div class="fw-semibold">${emoji ? emoji + " " : ""}${ev.title}</div>
          <div class="text-muted small">
            ${(ev.start_datetime || ev.start_date).slice(11,16)}
            ~ ${(ev.end_datetime || ev.end_date).slice(11,16)}
            Â· ${wText}
          </div>
        </div>
        <div class="d-flex gap-1">
          <button class="btn btn-sm btn-outline-primary btn-share-event">ê³µìœ </button>
          <button class="btn btn-sm btn-outline-secondary btn-edit-event">ìˆ˜ì •</button>
          <button class="btn btn-sm btn-outline-danger btn-delete-event">ì‚­ì œ</button>
        </div>
      `;

      const shareBtn = li.querySelector(".btn-share-event");
      shareBtn.onclick = async (e) => {
        e.stopPropagation();
        await openShareModal(ev);
      };

      const editBtn = li.querySelector(".btn-edit-event");
      editBtn.onclick = (e) => {
        e.stopPropagation();
        // ë‚ ì§œë³„ ëª¨ë‹¬ ë‹«ê³  ìˆ˜ì • ëª¨ë‹¬ ì˜¤í”ˆ
        bootstrap.Modal.getInstance(document.getElementById("dayEventModal")).hide();
        openEventModalForEdit(ev);
      };

      const deleteBtn = li.querySelector(".btn-delete-event");
      deleteBtn.onclick = async (e) => {
        e.stopPropagation();
        await deleteEvent(ev);
      };

      // ë¦¬ìŠ¤íŠ¸ ì „ì²´ í´ë¦­ ì‹œ ìƒì„¸ ì •ë³´ë§Œ ë³´ê³  ì‹¶ìœ¼ë©´ ìœ ì§€
      li.onclick = () => openEventDetail(ev);

      listEl.appendChild(li);
    });
  }

  addBtn.onclick = () => {
    const modal = bootstrap.Modal.getInstance(document.getElementById("dayEventModal"));
    modal.hide();
    openEventModal(dateStr);   // â˜… ì´ ë‚ ì§œë¡œ ì¼ì • ì¶”ê°€ ëª¨ë‹¬ ì˜¤í”ˆ
  };

  const modal = new bootstrap.Modal(document.getElementById("dayEventModal"));
  modal.show();
}

function openEventDetail(ev) {
  const isShared = ev.is_shared === 1;

  const title = ev.title;
  const start = (ev.start_datetime || ev.start_date);
  const end   = (ev.end_datetime || ev.end_date);
  const place = ev.location || "-";
  const memo  = ev.memo || ev.description || "-";

  let msg =
    `ì œëª©: ${title}\n` +
    `ì‹œê°„: ${start} ~ ${end}\n` +
    `ì¥ì†Œ: ${place}\n` +
    `ë©”ëª¨: ${memo}\n`;

  if (isShared) {
    msg += `\nâ€» ê³µìœ ë¡œ ë°›ì€ ì¼ì •ì…ë‹ˆë‹¤.`;
  }

  alert(msg);
}

function openEventModal(defaultDate = null) {
  const startInput = document.getElementById("ev-start");
  const endInput   = document.getElementById("ev-end");

  const baseDate = defaultDate ? new Date(defaultDate) : new Date();
  const base = new Date(
    baseDate.getFullYear(),
    baseDate.getMonth(),
    baseDate.getDate(),
    9, 0
  );
  const end  = new Date(base.getTime() + 60*60*1000);

  const toLocal = d => {
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60000);
    return local.toISOString().slice(0,16);
  };

  startInput.value = toLocal(base);
  endInput.value   = toLocal(end);

  placeInput.value = "";
  placeInput.dataset.regionId = "";
  placeInput.dataset.regionCode = "";
  suggestBox.style.display = "none";
  suggestBox.innerHTML = "";
  document.getElementById("place-preview").textContent = "";

  const modal = new bootstrap.Modal(document.getElementById("eventModal"));
  modal.show();
}

async function loadFollowingForShare() {
  const token = getToken();
  if (!token) return;
  const res = await fetch("http://127.0.0.1:8000/follow/following", {
    headers: { "Authorization": "Bearer " + token }
  });
  shareTargetFollowing = res.ok ? await res.json() : [];
}

async function openShareModal(ev) {
  shareSourceEvent = ev;

  // íŒ”ë¡œì‰ ëª©ë¡ ì—†ìœ¼ë©´ ë¡œë”©
  if (!shareTargetFollowing.length) {
    await loadFollowingForShare();
  }

  const titleEl = document.getElementById("share-event-title");
  const select  = document.getElementById("share-target-select");
  titleEl.textContent = `ê³µìœ í•  ì¼ì •: ${ev.title}`;

  select.innerHTML = "";

  if (!shareTargetFollowing.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "ë¨¼ì € ì¹œêµ¬ë¥¼ íŒ”ë¡œìš°í•´ ì£¼ì„¸ìš”.";
    select.appendChild(opt);
    select.disabled = true;
  } else {
    select.disabled = false;
    shareTargetFollowing.forEach(f => {
      const opt = document.createElement("option");
      opt.value = f.following_id;
      opt.textContent = f.following_nickname || `ì‚¬ìš©ì #${f.following_id}`;
      select.appendChild(opt);
    });
  }

  const modal = new bootstrap.Modal(document.getElementById("shareEventModal"));
  modal.show();
}

document.getElementById("btn-share-confirm").onclick = async () => {
  const select = document.getElementById("share-target-select");
  const targetId = parseInt(select.value, 10);
  if (!targetId || !shareSourceEvent) return;

  const token = getToken();
  const res = await fetch("http://127.0.0.1:8000/calendar/share/request", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({
      event_id: shareSourceEvent.id,
      target_user_id: targetId
    })
  });

  if (!res.ok) {
    const err = await res.json().catch(() => null);
    alert((err && err.detail) || "ì¼ì • ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  alert("ì¼ì • ê³µìœ  ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.");
  bootstrap.Modal.getInstance(document.getElementById("shareEventModal")).hide();
};
async function checkIncomingShares() {
  const token = getToken();
  if (!token) return;

  const res = await fetch("http://127.0.0.1:8000/calendar/share/incoming", {
    headers: { "Authorization": "Bearer " + token }
  });
  if (!res.ok) return;
  const requests = await res.json();   // [{id, from_user_id, event_id, status, ...}]

  for (const req of requests) {
    await showShareConfirmDialog(req);
  }
}

async function respondShare(requestId, accept) {
  const token = getToken();
  const res = await fetch(`http://127.0.0.1:8000/calendar/share/${requestId}/respond`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ accept })
  });
  return res.ok;
}

async function showShareConfirmDialog(req) {
  const textEl = document.getElementById("share-confirm-text");
  const name = req.from_user_nickname || `ì‚¬ìš©ì #${req.from_user_id}`;
  textEl.textContent = `${name} ê°€ ì¼ì •ì„ ê³µìœ í–ˆìŠµë‹ˆë‹¤. ìº˜ë¦°ë”ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

  return new Promise(resolve => {
    const modalEl = document.getElementById("shareConfirmModal");
    const modal = new bootstrap.Modal(modalEl);

    const acceptBtn = document.getElementById("btn-share-accept");
    const rejectBtn = document.getElementById("btn-share-reject");

    const cleanup = async (reload) => {
      acceptBtn.onclick = null;
      rejectBtn.onclick = null;
      modal.hide();
      if (reload) {
        const calId = await ensureUserCalendarId();
        if (calId) await loadEventsToCalendar(calId);
      }
      resolve();
    };

    acceptBtn.onclick = async () => {
      const ok = await respondShare(req.id, true);
      if (!ok) alert("ê³µìœ  ì¼ì • ìˆ˜ë½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      await cleanup(true);
    };

    rejectBtn.onclick = async () => {
      const ok = await respondShare(req.id, false);
      if (!ok) alert("ê³µìœ  ì¼ì • ê±°ì ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      await cleanup(false);
    };

    modal.show();
  });
}
function openEventModalForEdit(ev) {
  const startInput = document.getElementById("ev-start");
  const endInput   = document.getElementById("ev-end");
  const titleInput = document.getElementById("ev-title");
  const memoInput  = document.getElementById("ev-memo");
  const remindSel  = document.getElementById("ev-remind");
  const placeInputEl = document.getElementById("ev-place");

  // ì‹œì‘/ì¢…ë£Œ ì‹œê°„ì„ ë¡œì»¬ í¬ë§·ìœ¼ë¡œ ë³€í™˜
  const toLocal = iso => {
    const d = new Date(iso);
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60000);
    return local.toISOString().slice(0,16);
  };

  titleInput.value = ev.title || "";
  memoInput.value  = ev.memo || ev.description || "";
  placeInputEl.value = ev.location || "";
  remindSel.value = ev.remind_minutes != null ? String(ev.remind_minutes) : "0";

  startInput.value = toLocal(ev.start_datetime || ev.start_date);
  endInput.value   = toLocal(ev.end_datetime || ev.end_date);

  // ìˆ˜ì • ëª¨ë“œ í‘œì‹œìš©
  document.getElementById("event-form").dataset.editEventId = ev.id;

  const modal = new bootstrap.Modal(document.getElementById("eventModal"));
  modal.show();
}
async function deleteEvent(ev) {
  if (!confirm(`'${ev.title}' ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?`)) return;

  const token = getToken();
  const res = await fetch(`http://127.0.0.1:8000/calendar/events/${ev.id}`, {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + token }
  });

  if (!res.ok) {
    const err = await res.json().catch(()=>null);
    alert((err && err.detail) || "ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  alert("ì¼ì •ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.");

  await loadCalendars();
  const calId = await ensureUserCalendarId();
  if (calId) {
    await loadEventsToCalendar(calId);
  }
}

let notifCount = 0;

async function loadNotifications() {
  const token = localStorage.getItem("access_token");
  if (!token) return;

  try {
    const res = await fetch("http://127.0.0.1:8000/notifications/", {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) return;
    const items = await res.json();   // [{id, type, message, ...}, ...]

    const ul = document.getElementById("notif-list");
    if (!ul) return;
    ul.innerHTML = "";

    items.forEach(n => {
      const li = document.createElement("li");
      li.className = "list-group-item py-2";
      li.textContent = n.message;
      ul.appendChild(li);
    });

    if (items.length > 0) {
      notifCount = items.filter(n => !n.is_read).length || items.length;
      const badge = document.getElementById("notif-badge");
      if (badge) {
        badge.textContent = notifCount;
        badge.classList.toggle("d-none", notifCount === 0);
      }
    }
  } catch (e) {
    console.error("loadNotifications error", e);
  }
}
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("notif-btn");
  const panel = document.getElementById("notif-panel");
  const closeBtn = document.getElementById("notif-close");

  if (!btn || !panel) return;

  btn.addEventListener("click", async () => {
    if (panel.classList.contains("d-none")) {
      await loadNotifications();          // ì—´ ë•Œë§ˆë‹¤ ìµœì‹  ëª©ë¡
      panel.classList.remove("d-none");
      const badge = document.getElementById("notif-badge");
      if (badge) badge.classList.add("d-none");   // ì—´ë©´ ë±ƒì§€ ì´ˆê¸°í™”
    } else {
      panel.classList.add("d-none");
    }
  });

  if (closeBtn) {
    closeBtn.addEventListener("click", () => panel.classList.add("d-none"));
  }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
