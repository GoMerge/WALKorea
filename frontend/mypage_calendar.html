<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>WALKorea - 마이 캘린더</title>
  <meta name="description" content="한국 여행 일정 관리">
  <meta name="keywords" content="여행, 캘린더, 일정, WALKorea">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
  <link href="assets/vendor/drift-zoom/drift-basic.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">

  <style>
    body.mypage-layout {
      background:#f5f7fb;
    }

    /* 닉네임 텍스트 강조 */
    .header-nickname {
      font-size: 14px;
      color: #111827;
    }

    /* "닉네임" 라벨 */
    #nav-user .text-muted.small {
      margin-right: 2px;
    }

    /* 로그아웃 버튼을 상단 btn-getstarted 스타일과 맞추되 약간 작게 */
    .btn-logout-small {
      padding: 4px 14px;
      font-size: 13px;
    }

    .mypage-user-badge {
      width:48px;
      height:48px;
      border-radius:999px;
      background:#16a34a;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:700;
      font-size:22px;
      margin-right:12px;
    }

    /* 전체 마이페이지 카드 안 텍스트 */
    .mypage-main-card {
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
    }

    /* 실제 카드 느낌은 개별 요소에만 */
    .mypage-layout-row {
      display: flex;
      gap: 24px;
    }

    /* 반응형: 큰 화면에서는 좌우, 작은 화면에서는 세로 */
    @media (min-width: 992px) {
      .mypage-layout-row {
        flex-direction: row;
      }
    }
    @media (max-width: 991.98px) {
      .mypage-layout-row {
        flex-direction: column;
      }
    }

    .mypage-sidebar {
      background:#ffffff;
      border-radius:18px;
      padding:24px 22px 22px;   /* 위/양옆/아래 여백 */
      box-shadow:0 10px 30px rgba(15,23,42,0.08);
    }

    /* 프로필 박스와 메뉴 사이 간격 */
    .mypage-sidebar .d-flex.align-items-center {
      margin-bottom: 10px;
    }

    /* 사용자 정보 + 날씨 박스 공통 */
    .mypage-sidebar .border.rounded-3 {
      border:1px solid #e5e7eb;
      border-radius:14px;
      background:#ffffff;
    }

    /* '마이페이지' 타이틀과 메뉴 위쪽 여백 */
    .mypage-sidebar .menu-title {
      margin-top: 14px;
      margin-bottom: 6px;
    }

    .mypage-sidebar .d-flex.align-items-center.mb-3 {
      margin-bottom: 16px;
    }

    /* 왼쪽 이름(콩순이) */
    .mypage-sidebar #side-nickname {
      font-weight: 600;         /* 상단 메뉴와 비슷한 굵기 */
      font-size: 15px;
    }

    /* 이메일/부제목 */
    .mypage-sidebar #side-email,
    .mypage-sidebar #profile-region-msg,
    .mypage-sidebar #region-weather-desc {
      font-weight: 400;
      font-size: 13px;
    }

    /* 메뉴 항목들 (내 일정, 친구 관리...) */
    .mypage-nav a {
      display: block;
      padding: 8px 12px;
      border-radius: 10px;
      font-family: "Montserrat", "Roboto", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
      font-weight: 500;           /* 헤더 메뉴 비슷한 두께 */
      color: #374151;
      text-decoration: none;
      margin-bottom: 4px;
      transition: background-color 0.15s ease, color 0.15s ease;
    }

    .mypage-nav a:hover {
      background-color: #f3f4f6;
      color: #0f766e;            /* 헤더의 포커스 색 계열 */
    }

    .mypage-nav a.active {
      background-color: #e5f3ff;
      color: #0f766e;
      font-weight: 600;
    }

    .calendar-card {
      background:#ffffff;
      border-radius:18px;
      box-shadow:0 10px 30px rgba(15,23,42,0.08);
      padding:20px 22px;
    }

    .calendar-week-header {
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:4px;
    }
    .calendar-grid {
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:4px;
    }

    .calendar-day {
      background:#ffffff;
      border-radius:10px;
      min-height:90px;      /* 이미 있다면 유지 */
      max-height:90px;      /* 추가: 더 안 커지게 */
      padding:6px 8px;
      font-size:11px;
      display:flex;
      flex-direction:column;
      border:1px solid #e5e7eb;
      overflow:hidden;      /* 안 넘치게 잘라냄 */
    }

    .calendar-day .date-num {
      flex:0 0 auto;
    }

    .calendar-day.today {
      border-color:#059669;
      box-shadow:0 0 0 1px rgba(5,150,105,0.5);
    }

    .calendar-day .event-list {
      flex:1 1 auto;
      margin-top:2px;
      overflow:hidden;
    }

    .calendar-day .event-list > .text-muted.small {
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .schedule-list-card {
      margin-top:8px;
      background:#ffffff;
      border-radius:18px;
      box-shadow:0 10px 30px rgba(15,23,42,0.06);
      padding:14px 18px;
      font-size:13px;
    }
    .event-chip {
      display:inline-block;
      max-width:100%;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:500;
      white-space:nowrap;       /* 한 줄만 */
      overflow:hidden;
      text-overflow:ellipsis;   /* 제목 길면 ... 처리 */
      line-height:1.4;
    }

    /* 내가 직접 추가한 일반 일정 (기본: 하늘색) */
    .place-event-chip {
      background:#e0f2fe;          /* 옅은 하늘색 */
      color:#0369a1;
    }

    .event-chip.place-event-chip {
      border: 1px solid #d1e3ff;
      background-color: #f5f8ff;
    }

    /* 관광지 상세에서 저장한 일정: 하늘색 + 초록 테두리 */
    .event-chip.from-place-highlight {
      border-color: #2563eb;
      background-color: #eff6ff;
      color: #1d4ed8;
      font-weight: 600;
    }

    .event-chip.shared-event-chip {
      border-color: #f97373;
      background-color: #fef2f2;
      color: #b91c1c;
    }

    /* 공유로 받은 일정: 핑크색 */
    .shared-event-chip {
      background:#fee2e2;
      color:#b91c1c;
    }

    /* 리스트쪽 공유 일정 강조 (내 일정 목록) */
    .shared-event-list-item {
      border-left: 4px solid #f97373;
      background-color: #fff7f7;
    }

    .from-place-highlight-list {
      border-left: 14px solid #2563eb;
      background-color: #f0f6ff;
    }
  </style>
</head>
<body class="mypage-layout">
  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="header-container container-fluid container-xl position-relative d-flex align-items-center justify-content-between">
      
      <!-- Logo -->
      <a href="/places/list" class="logo d-flex align-items-center me-auto me-xl-0">
        <h1 class="sitename">WALKorea</h1>
      </a>

      <!-- Navigation Menu -->
      <nav id="navmenu" class="navmenu">
        <ul>
          <li class="dropdown">
            <a href="/places/list"><span>여행정보</span> <i class="bi bi-chevron-down toggle-dropdown"></i></a>
            <ul>
              <li><a href="/places/list?contenttypeid=12&page=1&sort=updated">관광지</a></li>
              <li><a href="/places/list?contenttypeid=14&page=1&sort=updated">문화시설</a></li>
              <li><a href="/places/list?contenttypeid=15&page=1&sort=updated">축제</a></li>
              <li><a href="/places/list?contenttypeid=32&page=1&sort=updated">숙박</a></li>
              <li><a href="/places/list?contenttypeid=39&page=1&sort=updated">음식점</a></li>
              <li><a href="/places/list?contenttypeid=38&page=1&sort=updated">쇼핑</a></li>
              <li><a href="/places/list?contenttypeid=28&page=1&sort=updated">레포츠</a></li>
            </ul>
          </li>
          <li><a href="/places/map_more">지도</a></li>
          <li><a href="/mypage_calendar">마이페이지</a></li>
        </ul>
      </nav>

      <!-- 비로그인: 로그인/회원가입 버튼 (기존 스타일 적용) -->
      <div id="nav-guest" class="d-flex align-items-center gap-2">
        <a class="btn-getstarted" href="/signup">회원가입</a>
        <a class="btn-getstarted" href="/login">로그인</a>
      </div>

      <!-- 로그인: 알림/닉네임/로그아웃 (기존 스타일 적용) -->
      <div id="nav-user" class="d-none d-flex align-items-center gap-3">

        <!-- 알림 버튼 (작게) -->
        <div class="dropdown">
          <button id="notifDropdown"
                  class="btn btn-outline-success btn-sm position-relative px-2 py-1 dropdown-toggle"
                  type="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false">
            <i class="bi bi-bell"></i>
            <span id="notif-badge"
                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none small">
              0
            </span>
          </button>

          <div class="dropdown-menu dropdown-menu-end notif-dropdown">
            <div class="notif-header d-flex justify-content-between align-items-center">
              <span class="fw-semibold">알림</span>
              <button id="notif-clear-all" class="btn btn-link btn-sm text-danger p-0">전체삭제</button>
            </div>
            <div class="notif-body">
              <p id="notif-empty-text" class="notif-empty text-muted small mb-2">
                아직 알림이 없습니다.
              </p>
              <ul id="notif-list" class="notif-list list-unstyled mb-0"></ul>
            </div>
          </div>
        </div>

        <!-- 닉네임 + 라벨 -->
        <div class="d-flex align-items-center gap-2">
          <div id="header-initial"
              class="mypage-user-badge"
              style="width:32px; height:32px; font-size:16px; margin-right:0;">
            닉네임
          </div>
          <span id="header-nickname" class="fw-semibold"></span>
        </div>

        <!-- 로그아웃 버튼: 로그인/회원가입 버튼 스타일 재사용 -->
        <button id="nav-logout" class="btn-getstarted btn-logout-small">
          로그아웃
        </button>
      </div>
    </div>
  </header>

  <main class="main">

    <!-- Page Title -->
    <div class="page-title">
      <div class="heading">
        <div class="container">
          <div class="row d-flex justify-content-center text-center">
            <div class="col-lg-8">
              <h1 class="heading-title">내 일정</h1>
              <p class="mb-0">날씨와 함께 내 일정을 볼 수 있습니다.</p>
            </div>
          </div>
        </div>
      </div>
      <nav class="breadcrumbs">
        <div class="container">
          <ol>
            <li><a href="/">홈</a></li>
            <li class="current">내 일정</li>
          </ol>
        </div>
      </nav>
    </div>

    <!-- 마이페이지 레이아웃 -->
    <section class="section">
      <div class="container">
        <div class="mypage-main-card">
          <div class="row align-items-start">

            <!-- 왼쪽: 사용자 + 메뉴 + 날씨 -->
            <div class="col-lg-3">
              <div class="mypage-sidebar">
                <div class="d-flex align-items-center mb-3">
                  <div class="mypage-user-badge" id="side-initial">닉네임</div>
                  <div>
                    <div class="fw-semibold" id="side-nickname">닉네임</div>
                    <div class="text-muted small" id="side-email">user@example.com</div>
                  </div>
                </div>

                <div class="border rounded-3 p-3 mb-3" id="weather-box">
                  <div class="small fw-semibold mb-1" id="region-weather-title">동네를 선택해 주세요</div>
                  <div class="small text-muted mb-2" id="region-weather-desc">
                    마이페이지 &gt; 프로필 수정에서 지역을 설정하면, 이곳에 6일간의 날씨를 보여줄게요.
                  </div>
                  <div id="region-weather-list"></div>
                  <a class="btn btn-outline-success btn-sm mt-2 w-100" href="/mypage_profile">
                    지역 설정하러 가기
                  </a>
                </div>

                <div class="menu-title mb-2">마이페이지</div>
                <nav class="mypage-nav">
                  <a href="/mypage_calendar" class="active">내 일정</a>
                  <a href="/mypage_friends">친구 관리</a>
                  <a href="/mypage_recommend">맞춤 관광</a>
                  <a href="/mypage_profile">프로필 수정</a>
                  <a href="/mypage_favorites">좋아요 한 여행지</a>
                </nav>
              </div>
            </div>

          <!-- 오른쪽: 캘린더 -->
          <div class="col-lg-9">
            <div class="calendar-card">

              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-2">
                  <button class="btn btn-outline-secondary btn-sm" id="prev-month">&lt;</button>
                  <h4 class="mb-0 fw-bold" id="month-title">2025년 11월</h4>
                  <button class="btn btn-outline-secondary btn-sm" id="next-month">&gt;</button>
                </div>
                <button class="btn btn-success btn-sm" id="btn-new-calendar">+ 일정 추가</button>
              </div>

              <div class="calendar-week-header text-center mb-2 fw-semibold">
                <div class="text-danger">일</div><div>월</div><div>화</div>
                <div>수</div><div>목</div><div>금</div>
                <div class="text-primary">토</div>
              </div>

              <div id="calendar-body" class="calendar-grid mb-3"></div>

              <div class="schedule-list-card">
                <h6 class="fw-bold mb-2">내 일정 목록</h6>
                <ul class="list-group small" id="my-cal-list"></ul>
              </div>

            </div>
          </div>

        </div>
      </div>
    </div>
  </section>
    <!-- 일정 추가 모달 -->
    <div class="modal fade" id="eventModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header py-2">
            <h5 class="modal-title">일정 추가</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form id="event-form">
            <div class="modal-body">
              <div class="mb-2">
                <label class="form-label small">제목</label>
                <input type="text" class="form-control" id="ev-title" required>
              </div>

              <div class="row g-2 mb-2">
                <div class="col-6">
                  <label class="form-label small">시작</label>
                  <input type="datetime-local" class="form-control" id="ev-start" required>
                </div>
                <div class="col-6">
                  <label class="form-label small">종료</label>
                  <input type="datetime-local" class="form-control" id="ev-end" required>
                </div>
              </div>

              <div class="mb-2">
                <label class="form-label small">장소</label>
                <div class="input-group input-group-sm position-relative">
                  <input type="text"
                    class="form-control"
                    id="ev-place"
                    placeholder="예) 서울 종로구 / 종로 5길 / 건물명으로 검색 후 선택">
                </div>
                <div class="list-group position-absolute w-100"
                    id="place-suggestions"
                    style="z-index:1056; max-height:200px; overflow:auto; display:none;"></div>
                <div class="small text-muted mt-1" id="place-preview"></div>
              </div>

              <div class="mb-2">
                <label class="form-label small">알림 시간</label>
                <select class="form-select form-select-sm" id="ev-remind">
                  <option value="0">알림 없음</option>
                  <option value="5">5분 전</option>
                  <option value="10">10분 전</option>
                  <option value="30">30분 전</option>
                  <option value="60">1시간 전</option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label small">메모</label>
                <textarea class="form-control" id="ev-memo" rows="3" placeholder="메모를 입력하세요"></textarea>
              </div>

            </div>
            <div class="modal-footer py-2">
              <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">취소</button>
              <button type="submit" class="btn btn-success btn-sm">저장</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- 날짜별 일정 모달 -->
    <div class="modal fade" id="dayEventModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header py-2">
            <h5 class="modal-title" id="day-modal-title">12월 8일 일정</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <ul class="list-group small" id="day-event-list"></ul>
          </div>
          <div class="modal-footer py-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">닫기</button>
            <button type="button" class="btn btn-success btn-sm" id="btn-add-on-day">
              + 이 날짜에 일정 추가
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- 일정 공유 대상 선택 모달 -->
    <div class="modal fade" id="shareEventModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header py-2">
            <h5 class="modal-title">일정 공유</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="small mb-2" id="share-event-title"></p>
            <label class="form-label small">공유할 친구 선택</label>
            <select class="form-select form-select-sm" id="share-target-select">
            </select>
            <div class="small text-muted mt-1">
              서로 팔로우 중인 친구만 공유할 수 있어요.
            </div>
          </div>
          <div class="modal-footer py-2">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">취소</button>
            <button type="button" class="btn btn-success btn-sm" id="btn-share-confirm">공유하기</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 공유 요청 수락/거절 모달 -->
    <div class="modal fade" id="shareConfirmModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header py-2">
            <h5 class="modal-title">일정 공유 요청</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p id="share-confirm-text" class="mb-0"></p>
          </div>
          <div class="modal-footer py-2">
            <button type="button" class="btn btn-secondary btn-sm" id="btn-share-reject">거절</button>
            <button type="button" class="btn btn-success btn-sm" id="btn-share-accept">수락</button>
          </div>
        </div>
      </div>
    </div>
  </main>
  <footer id="footer" class="footer position-relative">


    <div class="footer-bottom">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-6">
            <div class="copyright">
              <p>© <span>WALKorea</span></p>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="footer-bottom-links">
              <a href="#">개발자 김혜영</a>
              <a href="#">개발자 이지영</a>
            </div>
            <div class="credits">
            </div>
          </div>
        </div>
      </div>
    </div>

  </footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
  const API_BASE = "";
  import { initHeader } from "/assets/js/header.js";
  import { setupHeaderAndProfile, loadProfileWeather, requireLoginForMypage } from "/assets/js/mypage_common.js";
  import { loadNotifications, deleteAllNotifications, initWebsocket } from "/assets/js/notifications.js";
  import { initCalendarPage } from "/assets/js/mypage_calendar.js";

  document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("access_token");

    if (!requireLoginForMypage()) return;

    await initHeader();
    await setupHeaderAndProfile();
    await loadProfileWeather();
    await loadNotifications();

    try {
      const res = await fetch(API_BASE + "/user/profile", {
        headers: { Authorization: "Bearer " + token },
      });
      if (res.ok) {
        const user = await res.json();
        initWebsocket(user.id);
      }
    } catch (e) {
      console.error("init websocket error", e);
    }

    const clearBtn = document.getElementById("notif-clear-all");
    if (clearBtn) {
      clearBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        if (!confirm("모든 알림을 삭제할까요?")) return;
        await deleteAllNotifications();
      });
    }

    await initCalendarPage();
  });
</script>
</body>
</html>
